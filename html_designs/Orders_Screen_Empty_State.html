<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <title>Orders ‚Äì GoShopMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shine-primary': '#939BFB',
                        'shine-accent': '#F96226'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/chat-drawer-drag.css">
    <style>
        ::-webkit-scrollbar { display: none; }
        * { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .dm-sans { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .poppins { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .icon-button svg { width: 18px; height: 18px; stroke-width: 1.5; }
        .icon-button:hover svg { color: #939BFB; }
        .voice-message-bubble { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 16px; max-width: 80%; min-width: 140px; max-width: 260px; width: fit-content; }
        .voice-message-outgoing { background: #939BFB; color: white; margin-left: auto; }
        .voice-message-incoming { background: #f3f4f6; color: #000; }
        .product-bubble { background: white; border: 1px solid #D1D5DB; border-radius: 16px; padding: 12px; max-width: 60%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .product-bubble.outgoing { border-color: #939BFB; margin-left: auto; }
        .share-icon-tilted { transform: rotate(-35deg); }
        @keyframes wavePulse { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1.0); } }
        .wave-bar.playing { animation: wavePulse 1.1s ease-in-out infinite; animation-delay: calc(var(--i) * 0.08s); }
        .bottom-nav-btn { display: flex; flex-direction: column; align-items: center; color: #6B7280; transition: color 0.2s ease-in-out; }
        .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #939BFB; }
        .bottom-nav-btn:hover svg, .bottom-nav-btn:hover span, .bottom-nav-btn.active svg, .bottom-nav-btn.active span { color: #939BFB; }
        .bottom-nav-btn svg { width: 20px; height: 20px; stroke-width: 1.5; margin-bottom: 4px; }
        #cart-indicator, #notif-indicator { min-width: 18px; min-height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
        #cart-indicator.badge-numeric, #notif-indicator.badge-numeric { min-width: 18px; padding: 0 5px; }
    </style>
</head>
<body class="bg-[#F6F6F6] dm-sans">
<div id="app-shell" class="w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl relative">
    <div id="header" class="sticky top-0 bg-white z-50 border-b border-gray-100">
      <div class="px-5 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button type="button" class="p-2 text-gray-600 hover:text-gray-800 transition-colors" aria-label="Back">
              <svg fill="none" stroke="currentColor"
                viewBox="0 0 24 24" stroke-width="1.5" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
              </svg></button>
            <h1 class="text-xl font-semibold poppins text-gray-900">Orders</h1>
          </div>
          <div class="flex items-center gap-0">
            <a href="Notifications_Screen.html?from=orders-empty" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Notifications">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/>
              </svg>
              <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-accent rounded-full hidden items-center justify-center flex"><span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
            <a href="Shopping_bag.html?from=orders-empty" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Shopping bag">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"/>
              </svg>
              <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-primary rounded-full hidden items-center justify-center flex"><span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
          </div>
        </div>
      </div>
    </div><!-- Main Content -->
    <main id="main-content" class="pt-20 px-4 pb-40 min-h-screen flex flex-col">
      <!-- Empty State Section -->
      <section id="empty-state"
        class="flex-1 flex flex-col items-center justify-center px-6 py-8 animate-slide-in">
        <!-- Empty State Icon with Animation -->
        <div class="mb-8 relative">
          <div
            class="w-32 h-32 bg-[#E8EAFF] rounded-full flex items-center justify-center mb-4 relative">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"
              stroke-width="1.5" class="w-16 h-16 text-[#939BFB]">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z">
              </path>
            </svg><!-- Sparkle Animation -->
            <div
              class="absolute -top-2 -right-2 w-6 h-6 bg-shine-accent rounded-full flex items-center justify-center animate-pulse">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"
                stroke-width="2" class="w-3 h-3 text-white">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z">
                </path>
              </svg></div>
          </div>
        </div><!-- Empty State Content -->
        <div class="text-center mb-8">
          <h2 class="text-2xl poppins font-semibold text-gray-900 mb-4">
            You haven't placed any orders yet ‚Äî but your perfect look is just a
            chat away!
          </h2>
          <p class="text-gray-600 dm-sans text-base leading-relaxed px-4">
            Let ShAI, your personal AI shopper, help you discover your next
            favorite outfit.
          </p>
        </div>
      </section>
    </main>

    <div id="chat-overlay" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

    <div id="chat-drawer" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white rounded-t-3xl shadow-2xl z-50 h-[50vh] transform translate-y-full transition-transform duration-300 flex flex-col">
        <div id="drag-handle-zone" class="chat-drawer-drag-zone flex justify-center pt-2 flex-shrink-0">
            <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full pointer-events-none"></div>
        </div>
        <div id="chat-header" class="flex items-center p-4 pb-2 flex-shrink-0">
            <button id="back-btn" class="mr-3 hidden hover:opacity-70 transition-opacity">
                <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
                </svg>
            </button>
            <div class="w-8 h-8 rounded-full overflow-hidden mr-3 flex-shrink-0">
                <img class="orders-empty-shai-avatar w-full h-full object-cover" src="../assets/shai-avatar.png" alt="ShAI avatar" data-shai-from-db />
            </div>
            <div class="flex-1">
                <p class="font-semibold text-black text-sm" id="header-title">ShAI</p>
                <p class="text-xs text-gray-500" id="header-subtitle">Your shopping assistant</p>
            </div>
        </div>
        <div id="chat-content" class="flex-1 flex flex-col min-h-0">
            <div id="chat-messages" class="flex-1 overflow-y-auto">
                <div class="p-4 pb-0">
                    <div class="flex items-start space-x-3 mb-4">
                        <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img class="orders-empty-shai-avatar w-full h-full object-cover" src="../assets/shai-avatar.png" alt="ShAI avatar" data-shai-from-db />
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 mb-3">
                                <p class="text-sm text-black">Hi there! I'm ShAI, your personal shopping assistant. How can I help you find the perfect items today?</p>
                            </div>
                            <div id="smart-prompts" class="flex-shrink-0">
                                <div class="flex flex-wrap gap-2 pb-2">
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">I need a formal outfit</button>
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Find me seasonal outfits</button>
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">What's trending right now?</button>
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Elevate my workwear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-input-drawer" class="bg-white border-t border-gray-100 p-4 flex-shrink-0 min-w-0 overflow-hidden">
                <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
                    <button id="cam-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/>
                        </svg>
                    </button>
                    <input type="text" id="chat-input-drawer-field" placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
                    <button id="add-friend-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                        </svg>
                    </button>
                    <button id="mic-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                    <button id="send-btn-drawer" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="add-friend-content" class="flex-1 flex flex-col min-h-0 hidden">
            <div id="contact-list" class="flex-1 overflow-y-auto p-4">
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 pl-10 text-sm">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
                    </div>
                </div>
                <div id="contacts-container" class="space-y-2">
                    <div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="Alex Johnson" data-phone="+1 (555) 123-4567" data-goshopme="true">
                        <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" alt="Contact" class="w-full h-full object-cover"></div>
                        <div class="flex-1"><p class="font-medium text-sm text-black">Alex Johnson</p><p class="text-xs text-gray-500">+1 (555) 123-4567</p></div>
                        <button class="contact-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs font-medium">Add</button>
                    </div>
                    <div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="Maria Rodriguez" data-phone="+1 (555) 987-6543" data-goshopme="false">
                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">MR</span></div>
                        <div class="flex-1"><p class="font-medium text-sm text-black">Maria Rodriguez</p><p class="text-xs text-gray-500">+1 (555) 987-6543</p></div>
                        <button class="contact-action bg-white text-[#939BFB] px-2 py-1 rounded-full text-xs font-medium border border-[#939BFB]">Invite</button>
                    </div>
                    <div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="David Kim" data-phone="+1 (555) 456-7890" data-goshopme="true">
                        <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-3.jpg" alt="Contact" class="w-full h-full object-cover"></div>
                        <div class="flex-1"><p class="font-medium text-sm text-black">David Kim</p><p class="text-xs text-gray-500">+1 (555) 456-7890</p></div>
                        <button class="contact-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs font-medium">Add</button>
                    </div>
                    <div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="Sarah Thompson" data-phone="+1 (555) 234-5678" data-goshopme="false">
                        <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">ST</span></div>
                        <div class="flex-1"><p class="font-medium text-sm text-black">Sarah Thompson</p><p class="text-xs text-gray-500">+1 (555) 234-5678</p></div>
                        <button class="contact-action bg-white text-[#939BFB] px-2 py-1 rounded-full text-xs font-medium border border-[#939BFB]">Invite</button>
                    </div>
                </div>
            </div>
            <div id="add-friend-input" class="bg-white border-t border-gray-100 p-4 flex-shrink-0 min-w-0 overflow-hidden">
                <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
                    <button class="icon-button hover:opacity-70 transition-opacity"><svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg></button>
                    <input type="text" placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
                    <button class="icon-button hover:opacity-70 transition-opacity"><svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg></button>
                    <button class="icon-button hover:opacity-70 transition-opacity"><svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-input-bar" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 p-4 z-30 min-w-0 overflow-hidden">
        <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
            <button id="cam-btn" class="icon-button hover:opacity-70 transition-opacity">
                <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/>
                </svg>
            </button>
            <input type="text" id="message-input" placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
            <button id="add-friend-btn" class="icon-button hover:opacity-70 transition-opacity">
                <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                </svg>
            </button>
            <button id="mic-btn" class="icon-button hover:opacity-70 transition-opacity">
                <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
                </svg>
            </button>
            <button id="send-btn" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
                <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 z-50">
      <div class="flex items-center justify-around py-2">
        <a href="Home.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
          </svg>
          <span class="text-xs">Home</span>
        </a>
        <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
          </svg>
          <span class="text-xs">Picks</span>
        </a>
        <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
          </svg>
          <span class="text-xs">Wishlist</span>
        </a>
        <a id="orders-empty-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <span id="orders-empty-nav-profile-icon" class="flex items-center justify-center w-6 h-6 mb-1 text-shine-primary">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
          </span>
          <img id="orders-empty-nav-profile-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
          <span class="text-xs">Profile</span>
        </a>
      </div>
    </nav>
</div>

<script>
(function(){var BADGE_KEYS={notif:'goshopme_notif_count',cart:'goshopme_cart_count'};var cartCountValue=0,notifCountValue=0;function getBadgeElements(){return{cartIndicator:document.getElementById('cart-indicator'),cartCount:document.getElementById('cart-count'),notifIndicator:document.getElementById('notif-indicator'),notifCount:document.getElementById('notif-count')};}function updateCartBadge(){var el=getBadgeElements();if(!el.cartIndicator||!el.cartCount)return;var show=cartCountValue>0;el.cartIndicator.classList.toggle('hidden',!show);el.cartIndicator.classList.toggle('flex',show);el.cartCount.textContent=show?(cartCountValue>99?'99+':cartCountValue):'';try{localStorage.setItem(BADGE_KEYS.cart,String(cartCountValue));localStorage.setItem('__cartCount',String(cartCountValue));}catch(e){}}function updateNotifBadge(){var el=getBadgeElements();if(!el.notifIndicator||!el.notifCount)return;var show=notifCountValue>0;el.notifIndicator.classList.toggle('hidden',!show);el.notifIndicator.classList.toggle('flex',show);el.notifCount.textContent=show?(notifCountValue>99?'99+':notifCountValue):'';try{localStorage.setItem(BADGE_KEYS.notif,String(notifCountValue));localStorage.setItem('notifCount',String(notifCountValue));}catch(e){}}window.updateCartBadge=updateCartBadge;window.updateNotifBadge=updateNotifBadge;window.testBadges=function(notif,cart){notifCountValue=Math.max(0,notif!=null?notif:5);cartCountValue=Math.max(0,cart!=null?cart:3);updateNotifBadge();updateCartBadge();};window.resetBadges=function(){cartCountValue=0;notifCountValue=0;try{localStorage.setItem(BADGE_KEYS.notif,'0');localStorage.setItem(BADGE_KEYS.cart,'0');localStorage.setItem('__cartCount','0');localStorage.setItem('notifCount','0');}catch(e){}updateCartBadge();updateNotifBadge();};document.addEventListener('DOMContentLoaded',function(){try{notifCountValue=parseInt(localStorage.getItem(BADGE_KEYS.notif)||localStorage.getItem('notifCount')||'0',10);cartCountValue=parseInt(localStorage.getItem(BADGE_KEYS.cart)||localStorage.getItem('__cartCount')||'0',10);}catch(e){}updateCartBadge();updateNotifBadge();});})();
</script>
<script>
// Bottom nav profile: link (paid/free), show profile icon if no uploaded photo, else show saved photo from localStorage
(function() {
    var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
    var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
    var profileLink = document.getElementById('orders-empty-nav-profile-link');
    if (profileLink) profileLink.href = profileHref;
    var saved = null;
    try { saved = localStorage.getItem('profilePhoto'); } catch (e) {}
    var img = document.getElementById('orders-empty-nav-profile-photo');
    var icon = document.getElementById('orders-empty-nav-profile-icon');
    if (img && icon) {
        if (saved) {
            img.src = saved;
            img.classList.remove('hidden');
            icon.classList.add('hidden');
        } else {
            img.src = '';
            img.classList.add('hidden');
            icon.classList.remove('hidden');
        }
    }
})();
</script>
<script>
(function() {
  function upgradeToAutoGrowTextarea(cfg) {
    const old = document.querySelector(cfg.selector);
    if (!old) return;
    const ta = document.createElement('textarea');
    ta.id = old.id;
    ta.className = old.className + ' resize-none';
    ta.placeholder = old.placeholder || '';
    ta.value = old.value || '';
    ta.rows = 1;
    ta.autocomplete = 'off';
    ta.spellcheck = true;
    ta.style.overflowY = 'hidden';
    old.parentNode.replaceChild(ta, old);
    const mic = document.querySelector(cfg.mic);
    const add = document.querySelector(cfg.add);
    const send = document.querySelector(cfg.send);
    const chatScroll = document.getElementById('chat-messages');
    const rowH = () => { const lh = parseFloat(getComputedStyle(ta).lineHeight); return Number.isFinite(lh) ? lh : 20; };
    const autoResize = () => { ta.style.height = 'auto'; ta.style.height = Math.min(ta.scrollHeight, 6 * rowH()) + 'px'; };
    const updateButtons = () => {
      const hasText = ta.value.trim().length > 0;
      if (mic) mic.classList.toggle('hidden', hasText);
      if (add) add.classList.toggle('hidden', hasText);
      if (send) send.classList.toggle('hidden', !hasText);
    };
    const sendNow = () => {
      const text = ta.value.trim();
      if (!text) return;
      const container = document.querySelector('#chat-messages .p-4');
      if (container) {
        const wrap = document.createElement('div');
        wrap.className = 'flex justify-end mb-4';
        wrap.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm"></p></div>';
        wrap.querySelector('p').textContent = text;
        container.appendChild(wrap);
        if (chatScroll) chatScroll.scrollTop = chatScroll.scrollHeight;
      }
      ta.value = '';
      autoResize();
      updateButtons();
    };
    ta.addEventListener('input', function() { autoResize(); updateButtons(); });
    ta.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendNow(); }
    });
    if (send) send.addEventListener('click', sendNow);
    autoResize();
    updateButtons();
    if (cfg.onFocusGrow) {
      ta.addEventListener('focus', function() {
        const drawer = document.getElementById('chat-drawer');
        if (drawer) drawer.style.height = '50vh';
      });
    }
  }
  document.addEventListener('DOMContentLoaded', function() {
    upgradeToAutoGrowTextarea({ selector: '#message-input', mic: '#mic-btn', add: '#add-friend-btn', send: '#send-btn' });
    upgradeToAutoGrowTextarea({ selector: '#chat-input-drawer-field', mic: '#mic-btn-drawer', add: '#add-friend-btn-drawer', send: '#send-btn-drawer', onFocusGrow: true });
  });
})();
</script>

<script>
window.setShAIAvatar = function(url) {
    if (!url) return;
    window.__shaiAvatarUrl = url;
    document.querySelectorAll('.orders-empty-shai-avatar').forEach(function(img) { img.src = url; });
};
window.testShAIAvatar = function(url) {
    var testUrl = url || 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg';
    window.setShAIAvatar(testUrl);
    console.log('testShAIAvatar:', testUrl);
};
document.addEventListener("DOMContentLoaded", function () {
    const chatDrawer = document.getElementById("chat-drawer");
    const chatOverlay = document.getElementById("chat-overlay");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("message-input");
    const chatInputDrawer = document.getElementById("chat-input-drawer-field");
    const micBtn = document.getElementById("mic-btn");
    const sendBtn = document.getElementById("send-btn");
    const addFriendBtn = document.getElementById("add-friend-btn");
    const micBtnDrawer = document.getElementById("mic-btn-drawer");
    const sendBtnDrawer = document.getElementById("send-btn-drawer");
    const addFriendBtnDrawer = document.getElementById("add-friend-btn-drawer");
    const dragHandleZone = document.getElementById("drag-handle-zone") || document.getElementById("drag-handle");
    const chatInputBar = document.getElementById("chat-input-bar");

    let isDrawerExpanded = false;
    let startY = 0;
    let currentHeight = 80;
    let isDragging = false;

    function fixWrapping() {
        document.querySelectorAll("#chat-messages p.text-sm").forEach(p => {
            p.classList.add("break-words", "whitespace-pre-wrap");
        });
    }
    fixWrapping();

    function scrollToBottom(force) {
        if (!chatMessages) return;
        const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 20;
        if (force || atBottom) chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    if (chatMessages) {
        const observer = new MutationObserver(() => {
            fixWrapping();
            setTimeout(() => scrollToBottom(true), 50);
        });
        observer.observe(chatMessages, { childList: true, subtree: true });
    }

    function sendMessage(inputEl, mic, addFriend, send) {
        const text = (inputEl && inputEl.value) ? inputEl.value.trim() : '';
        if (!text) return;
        const container = chatMessages && chatMessages.querySelector(".p-4");
        if (container) {
            const userMsg = document.createElement("div");
            userMsg.className = "flex justify-end mb-4";
            userMsg.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm break-words whitespace-pre-wrap">' + text + '</p></div>';
            container.appendChild(userMsg);
        }
        if (inputEl) inputEl.value = "";
        if (mic) { mic.classList.remove("hidden"); }
        if (addFriend) { addFriend.classList.remove("hidden"); }
        if (send) { send.classList.add("hidden"); }
        setTimeout(() => scrollToBottom(true), 50);
    }

    function updateInputState(inputEl, mic, addFriend, send) {
        if (!inputEl) return;
        if (inputEl.value.trim()) {
            if (mic) mic.classList.add("hidden");
            if (addFriend) addFriend.classList.add("hidden");
            if (send) send.classList.remove("hidden");
        } else {
            if (mic) mic.classList.remove("hidden");
            if (addFriend) addFriend.classList.remove("hidden");
            if (send) send.classList.add("hidden");
        }
    }

    [chatInput, chatInputDrawer].forEach(function(inputEl, idx) {
        if (!inputEl) return;
        var mic = idx === 0 ? micBtn : micBtnDrawer;
        var send = idx === 0 ? sendBtn : sendBtnDrawer;
        var add = idx === 0 ? addFriendBtn : addFriendBtnDrawer;
        inputEl.addEventListener("input", function() { updateInputState(inputEl, mic, add, send); });
        inputEl.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(inputEl, mic, add, send); }
        });
        if (send) send.addEventListener("click", function() { sendMessage(inputEl, mic, add, send); });
    });

    function expandDrawer() {
        if (!chatDrawer) return;
        chatDrawer.classList.remove('translate-y-full');
        if (chatOverlay) chatOverlay.classList.remove('hidden');
        if (chatInputBar) chatInputBar.classList.add('hidden');
        isDrawerExpanded = true;
        currentHeight = 80;
        chatDrawer.style.height = '50vh';
    }

    function collapseDrawer() {
        if (!chatDrawer) return;
        chatDrawer.classList.add('translate-y-full');
        if (chatOverlay) chatOverlay.classList.add('hidden');
        if (chatInputBar) chatInputBar.classList.remove('hidden');
        isDrawerExpanded = false;
        currentHeight = 80;
        chatDrawer.style.height = '50vh';
        if (isAddFriendMode) hideAddFriendFlow();
    }

    if (chatOverlay) chatOverlay.addEventListener("click", collapseDrawer);

    if (dragHandleZone) {
        dragHandleZone.addEventListener("mousedown", function(e) { isDragging = true; startY = e.clientY; });
        dragHandleZone.addEventListener("touchstart", function(e) { isDragging = true; startY = e.touches[0].clientY; }, { passive: true });
    }
    document.addEventListener("mousemove", function(e) {
        if (!isDragging) return;
        var deltaY = startY - e.clientY;
        chatDrawer.style.height = Math.min(90, Math.max(35, currentHeight + (deltaY / window.innerHeight) * 100)) + "vh";
    });
    function stopDrag() {
        if (!isDragging) return;
        isDragging = false;
        var rect = chatDrawer.getBoundingClientRect();
        currentHeight = (rect.height / window.innerHeight) * 100;
    }
    document.addEventListener("mouseup", stopDrag);
    document.addEventListener("touchmove", function(e) {
        if (!isDragging) return;
        var deltaY = startY - e.touches[0].clientY;
        chatDrawer.style.height = Math.min(90, Math.max(35, currentHeight + (deltaY / window.innerHeight) * 100)) + "vh";
    });
    document.addEventListener("touchend", stopDrag);
    document.addEventListener("touchcancel", stopDrag);

    var addFriendContent = document.getElementById("add-friend-content");
    var chatContent = document.getElementById("chat-content");
    var contactSearch = document.getElementById("contact-search");
    var contactsContainer = document.getElementById("contacts-container");
    var backBtn = document.getElementById("back-btn");
    var headerTitle = document.getElementById("header-title");
    var headerSubtitle = document.getElementById("header-subtitle");
    var smartPrompts = document.querySelectorAll('#smart-prompts button');
    var camBtns = [document.getElementById("cam-btn"), document.getElementById("cam-btn-drawer")];
    var micBtns = [micBtn, micBtnDrawer];

    var isAddFriendMode = false;
    var isRecording = false;
    var mediaRecorder;
    var audioChunks = [];
    var startX;
    var micAccessDenied = false;
    var mediaStream = null;

    function removeTempRecordingBubble() {
        var temp = document.getElementById("temp-recording");
        if (temp) temp.remove();
    }

    function addShAIMessage(message) {
        var container = document.querySelector('#chat-messages .p-4');
        if (container) {
            var aiMessage = document.createElement('div');
            aiMessage.className = 'flex items-start space-x-3 mb-4';
            aiMessage.innerHTML = '<div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0"><img class="orders-empty-shai-avatar w-full h-full object-cover" src="' + (window.__shaiAvatarUrl || '../assets/shai-avatar.png') + '" alt="ShAI avatar" data-shai-from-db /></div><div class="flex-1"><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3"><p class="text-sm text-black">' + message + '</p></div></div>';
            container.appendChild(aiMessage);
            container.scrollTop = container.scrollHeight;
        }
    }

    function showToast(message) {
        var toast = document.createElement('div');
        toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-[60]';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 3000);
    }

    function handleCameraAccess() {
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*,video/*";
        input.onchange = function(e) {
            var file = e.target.files && e.target.files[0];
            if (file) handleFileSelection(file);
            input.value = "";
        };
        input.click();
    }

    function handleFileSelection(file) {
        var url = URL.createObjectURL(file);
        var container = document.querySelector('#chat-messages .p-4');
        if (container) {
            var bubble = null;
            if (file.type.startsWith("image/")) {
                bubble = document.createElement('div');
                bubble.className = 'flex justify-end mb-4';
                bubble.innerHTML = '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><img src="' + url + '" class="w-full h-auto" alt="Uploaded image" /></div>';
            } else if (file.type.startsWith("video/")) {
                bubble = document.createElement('div');
                bubble.className = 'flex justify-end mb-4';
                bubble.innerHTML = '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm relative"><video src="' + url + '" controls class="w-full h-auto"></video></div>';
            }
            if (bubble) {
                container.appendChild(bubble);
                container.scrollTop = container.scrollHeight;
                setTimeout(function() {
                    addShAIMessage(file.type.startsWith("video/") ? "Great! I can analyze your video. Let me find products that match what I see." : "Perfect! I can see your image. Let me analyze it and find similar products for you.");
                }, 1500);
            }
        }
    }

    camBtns.forEach(function(btn) {
        if (!btn) return;
        btn.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!chatDrawer.classList.contains('translate-y-full')) {
                handleCameraAccess();
            } else {
                expandDrawer();
                setTimeout(handleCameraAccess, 300);
            }
        });
    });

    function startRecording(e) {
        e.preventDefault();
        removeTempRecordingBubble();
        if (!isDrawerExpanded) { expandDrawer(); return; }
        if (micAccessDenied) { showToast("Microphone access denied. Enable it in your browser settings to record voice messages."); return; }
        startX = e.touches ? e.touches[0].clientX : e.clientX;
        var self = this;
        function doStart(stream) {
            mediaStream = stream;
            mediaRecorder = new MediaRecorder(mediaStream);
            isRecording = true;
            audioChunks = [];
            mediaRecorder.ondataavailable = function(ev) { if (ev.data.size > 0) audioChunks.push(ev.data); };
            mediaRecorder.start();
            self.classList.add("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");
            var container = document.querySelector('#chat-messages .p-4');
            if (container) {
                var tempBubble = document.createElement('div');
                tempBubble.id = 'temp-recording';
                tempBubble.className = 'flex justify-end mb-2';
                tempBubble.innerHTML = '<div class="flex items-center bg-[#939BFB] text-white rounded-2xl px-3 py-2 max-w-[70%]"><span class="mr-2">üéôÔ∏è</span><span class="text-xs">Recording... swipe left to cancel</span></div>';
                container.appendChild(tempBubble);
                container.scrollTop = container.scrollHeight;
            }
        }
        try {
            if (!mediaStream || !mediaStream.active) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(doStart).catch(function(err) {
                    removeTempRecordingBubble();
                    if (err && (err.name === "NotAllowedError" || err.name === "SecurityError")) {
                        micAccessDenied = true;
                        showToast("Microphone access denied. Enable it in your browser settings to record voice messages.");
                    } else {
                        showToast("Could not access microphone. Please try again.");
                    }
                });
                return;
            }
            doStart(mediaStream);
        } catch (err) {
            removeTempRecordingBubble();
            if (err && (err.name === "NotAllowedError" || err.name === "SecurityError")) {
                micAccessDenied = true;
                showToast("Microphone access denied. Enable it in your browser settings to record voice messages.");
            } else {
                showToast("Could not access microphone. Please try again.");
            }
        }
    }

    function stopRecording(e) {
        e.preventDefault();
        if (!isRecording) return;
        isRecording = false;
        this.classList.remove("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");
        removeTempRecordingBubble();
        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.onstop = function() {
                var audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                var audioUrl = URL.createObjectURL(audioBlob);
                renderAudioBubble(audioUrl);
            };
        }
    }

    function cancelRecording(e) {
        if (!isRecording) return;
        isRecording = false;
        this.classList.remove("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");
        removeTempRecordingBubble();
        if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    }

    function handleSwipeCancel(e) {
        if (!isRecording || !e.touches || !e.touches.length) return;
        if (startX - e.touches[0].clientX > 30) cancelRecording.call(this, e);
    }

    function renderAudioBubble(url) {
        var container = document.querySelector('#chat-messages .p-4');
        if (container) {
            var bubble = document.createElement('div');
            bubble.className = 'flex justify-end mb-2';
            bubble.innerHTML = '<div role="group" class="voice-message-bubble bg-[#939BFB] text-white rounded-full px-3 py-2 flex items-center gap-2 h-11 shadow-sm"><button class="play-btn flex-shrink-0 w-6 h-6 border border-white rounded-full flex items-center justify-center hover:bg-white/20" onclick="window.toggleVoicePlaybackOrders(this, \'' + url + '\')"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button><div class="waveform flex-1 flex items-center justify-center gap-0.5 h-4 max-w-[120px]"><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height: 8px; --i: 0"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height: 12px; --i: 1"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height: 6px; --i: 2"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height: 16px; --i: 3"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height: 10px; --i: 4"></div></div><span class="duration-text text-white/90 text-xs font-medium flex-shrink-0">0:00</span><audio src="' + url + '" preload="auto" class="hidden"></audio></div>';
            container.appendChild(bubble);
            var audio = bubble.querySelector('audio');
            var durationText = bubble.querySelector('.duration-text');
            if (audio) audio.addEventListener('loadedmetadata', function() {
                var d = Math.ceil(audio.duration);
                durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
            });
            container.scrollTop = container.scrollHeight;
            setTimeout(function() { addShAIMessage("Got your voice message! I'm on it ‚Äî let me find the best options for you."); }, 800);
        }
    }

    window.toggleVoicePlaybackOrders = function(button, audioUrl) {
        var container = button.closest('.voice-message-bubble');
        var audio = container.querySelector('audio');
        var playIcon = button.querySelector('svg');
        var waveBars = container.querySelectorAll('.wave-bar');
        var durationText = container.querySelector('.duration-text');
        if (audio.paused) {
            audio.play();
            playIcon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
            waveBars.forEach(function(bar, i) { bar.style.animation = 'wavePulse 1.1s ease-in-out infinite'; bar.style.animationDelay = (i * 0.08) + 's'; });
            audio.addEventListener('ended', function() {
                playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                waveBars.forEach(function(bar) { bar.style.animation = 'none'; });
                var d = Math.ceil(audio.duration);
                durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
            });
        } else {
            audio.pause();
            playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            waveBars.forEach(function(bar) { bar.style.animation = 'none'; });
        }
    };

    micBtns.forEach(function(btn) {
        if (!btn) return;
        btn.addEventListener("mousedown", startRecording);
        btn.addEventListener("touchstart", startRecording);
        btn.addEventListener("mouseup", stopRecording);
        btn.addEventListener("mouseleave", cancelRecording);
        btn.addEventListener("touchend", stopRecording);
        btn.addEventListener("touchcancel", cancelRecording);
        btn.addEventListener("touchmove", handleSwipeCancel);
    });

    smartPrompts.forEach(function(button) {
        button.addEventListener('click', function() {
            var promptText = this.textContent;
            var container = document.querySelector('#chat-messages .p-4');
            if (container) {
                var userMessage = document.createElement('div');
                userMessage.className = 'flex justify-end mb-4';
                userMessage.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm">' + promptText + '</p></div>';
                container.appendChild(userMessage);
                setTimeout(function() {
                    var aiResponse = document.createElement('div');
                    aiResponse.className = 'flex items-start space-x-3 mb-4';
                    aiResponse.innerHTML = '<div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0"><img class="orders-empty-shai-avatar w-full h-full object-cover" src="' + (window.__shaiAvatarUrl || '../assets/shai-avatar.png') + '" alt="ShAI avatar" data-shai-from-db /></div><div class="flex-1"><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3"><p class="text-sm text-black">I\'d be happy to help you with that! Let me find some perfect options for you.</p></div></div>';
                    container.appendChild(aiResponse);
                    container.scrollTop = container.scrollHeight;
                }, 1000);
                container.scrollTop = container.scrollHeight;
            }
        });
    });

    if (contactSearch) contactSearch.addEventListener('input', function() {
        var term = this.value.toLowerCase();
        var items = contactsContainer ? contactsContainer.querySelectorAll('.contact-item') : [];
        items.forEach(function(item) {
            var name = (item.getAttribute('data-name') || '').toLowerCase();
            var phone = (item.getAttribute('data-phone') || '').toLowerCase();
            item.style.display = (name.indexOf(term) !== -1 || phone.indexOf(term) !== -1) ? 'flex' : 'none';
        });
    });

    if (backBtn) backBtn.addEventListener('click', hideAddFriendFlow);

    function showAddFriendFlow() {
        isAddFriendMode = true;
        if (chatContent) chatContent.classList.add('hidden');
        if (addFriendContent) addFriendContent.classList.remove('hidden');
        if (backBtn) backBtn.classList.remove('hidden');
        if (headerTitle) headerTitle.textContent = 'Add Friend';
        if (headerSubtitle) headerSubtitle.textContent = 'Choose contacts to add';
    }

    function hideAddFriendFlow() {
        isAddFriendMode = false;
        if (chatContent) chatContent.classList.remove('hidden');
        if (addFriendContent) addFriendContent.classList.add('hidden');
        if (backBtn) backBtn.classList.add('hidden');
        if (headerTitle) headerTitle.textContent = 'ShAI';
        if (headerSubtitle) headerSubtitle.textContent = 'Your shopping assistant';
        if (contactSearch) { contactSearch.value = ''; contactSearch.dispatchEvent(new Event('input')); }
    }

    if (addFriendBtn) addFriendBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!isDrawerExpanded) { expandDrawer(); setTimeout(showAddFriendFlow, 300); } else { showAddFriendFlow(); }
    });
    if (addFriendBtnDrawer) addFriendBtnDrawer.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        showAddFriendFlow();
    });

    if (chatInput) chatInput.addEventListener('focus', function() {
        if (!isDrawerExpanded) { expandDrawer(); setTimeout(function() { if (chatInputDrawer) chatInputDrawer.focus(); }, 300); }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('contact-action')) return;
        var contactItem = e.target.closest('.contact-item');
        if (!contactItem) return;
        var contactName = contactItem.querySelector('p').textContent;
        var isGoshopmeUser = contactItem.getAttribute('data-goshopme') === 'true';
        if (e.target.textContent === 'Add' && isGoshopmeUser) {
            var container = document.querySelector('#chat-messages .p-4');
            if (container) {
                var notification = document.createElement('div');
                notification.className = 'flex justify-center mb-4';
                notification.innerHTML = '<div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">' + (contactName.split(' ')[0] || '') + ' has been added to chat</div>';
                container.appendChild(notification);
                container.scrollTop = container.scrollHeight;
            }
            hideAddFriendFlow();
        } else if (e.target.textContent === 'Invite') {
            var shareData = { title: 'Join me on GoShopMe', text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless ‚Äî join me", url: 'https://app.goshopme.ai' };
            if (navigator.share) {
                navigator.share(shareData).catch(function() {
                    if (navigator.clipboard) navigator.clipboard.writeText(shareData.text + ' ' + shareData.url).then(function() { showToast('Invitation link copied to clipboard!'); });
                });
            }
        }
    });

    updateInputState(chatInput, micBtn, addFriendBtn, sendBtn);
    if (chatInputDrawer) updateInputState(chatInputDrawer, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer);
});
</script>
</body>
</html>


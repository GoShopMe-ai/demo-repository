<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/heroicons@2.0.16/24/outline/index.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/chat-drawer-drag.css">
    <style>
        /* ---- MOBILE FULL-WIDTH OVERRIDE ---- */
        @media screen and (max-width: 768px) {
          #app-shell, #main-content, #bottom-nav, #header,
          #chat-drawer, #chat-input-bar {
            max-width: 100vw !important;
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            box-shadow: none !important;
          }
          #header, #bottom-nav, #chat-drawer, #chat-input-bar {
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
          }
          /* Re-apply Y slide when drawer is hidden (translate-y-full class present) */
          #chat-drawer.translate-y-full {
            transform: translateY(100%) !important;
          }
          /* Nav buttons: push UP away from the gesture bar */
          #bottom-nav > div {
            padding-top: 6px !important;
            padding-bottom: 14px !important;
          }
        }
        /* ------------------------------------ */
        /* Chat drawer: prevent scroll leaking to main page */
        #chat-drawer {
          overscroll-behavior: contain;
          -webkit-overflow-scrolling: touch;
        }
        #chat-messages {
          overscroll-behavior: contain;
          -webkit-overflow-scrolling: touch;
        }
        /* Drag handle: tell the browser upfront not to scroll here */
        #drag-handle-zone, .chat-drawer-drag-zone {
          touch-action: none;
          -webkit-user-select: none;
          user-select: none;
        }
        ::-webkit-scrollbar { display: none; }
       * { 
    font-family: 'DM Sans', 
                 'Karla',
                 -apple-system,
                 BlinkMacSystemFont,
                 'Segoe UI',
                 Roboto,
                 'Helvetica Neue',
                 Arial,
                 'Noto Sans',
                 sans-serif; 
}

.dm-sans { 
    font-family: 'DM Sans', 
                 'Karla',
                 -apple-system,
                 BlinkMacSystemFont,
                 'Segoe UI',
                 Roboto,
                 'Helvetica Neue',
                 Arial,
                 'Noto Sans',
                 sans-serif; 
}

.poppins { 
    font-family: 'Poppins',
                 -apple-system,
                 BlinkMacSystemFont,
                 'Segoe UI',
                 Roboto,
                 'Helvetica Neue',
                 Arial,
                 sans-serif; 
}
        
        /* Icon styling */
        .icon-button svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
        }
        
        .icon-button:hover svg {
            color: #939BFB;
        }
        
        .icon-button.white svg {
            color: #FFF;
        }
        
        /* Bottom nav styling */
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6B7280;
            transition: color 0.2s ease-in-out;
        }
        
        .bottom-nav-btn:hover,
        .bottom-nav-btn.active {
            color: #939BFB;
        }
        
        .bottom-nav-btn:hover svg,
        .bottom-nav-btn:hover span,
        .bottom-nav-btn.active svg,
        .bottom-nav-btn.active span {
            color: #939BFB;
        }

        .bottom-nav-btn svg {
            width: 20px;
            height: 20px;
            stroke-width: 1.5;
            margin-bottom: 4px;
        }

        #cart-indicator, #notif-indicator {
            min-width: 18px;
            min-height: 18px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
        #cart-indicator.badge-numeric, #notif-indicator.badge-numeric {
            min-width: 18px;
            padding: 0 5px;
        }
        
        /* Wishlist heart filled state */
        .heart-filled {
            fill: #939BFB !important;
            stroke: #939BFB !important;
        }
        
        /* Voice recording state */
        .recording {
            background: #ef4444 !important;
            color: white !important;
        }
        
        /* Chat message bubbles */
        .voice-message-bubble {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 16px;
            max-width: 80%;
        }
        
        .voice-message-outgoing {
            background: #939BFB;
            color: white;
            margin-left: auto;
        }
        
        .voice-message-incoming {
            background: #f3f4f6;
            color: #000;
        }
        
        .product-bubble {
            background: white;
            border: 1px solid #D1D5DB;
            border-radius: 16px;
            padding: 12px;
            max-width: 60%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .product-bubble.outgoing {
            border-color: #939BFB;
            margin-left: auto;
        }
        
        /* Share button - Instagram-style tilted paper plane */
        .share-icon-tilted {
            transform: rotate(-35deg);
        }
        
        /* Add to existing styles */
        @keyframes wavePulse {
            0%, 100% { 
                transform: scaleY(0.5); 
            }
            50% { 
                transform: scaleY(1.0); 
            }
        }

        .wave-bar.playing {
            animation: wavePulse 1.1s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.08s);
        }

        .product-overlay-icon {
            /* Plain white icons - Instagram style */
        }
        .product-image-overlay-wrap::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.08); pointer-events: none; z-index: 0; }
        .product-image-overlay-wrap > [class*="absolute"][class*="top-"] { z-index: 1; }

        /* Product/creator tiles: pointer cursor (desktop), touch-optimized (mobile) */
        .creator-card { cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: rgba(147, 155, 251, 0.12); }
        span.block.cursor-pointer { touch-action: manipulation; -webkit-tap-highlight-color: rgba(147, 155, 251, 0.12); }

        .voice-message-bubble {
            min-width: 140px;
            max-width: 260px;
            width: fit-content;
        }
      #recent-activity {
    max-width: 390px;
    margin-left: auto;
    margin-right: auto;
}


   #hero-bg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
}
   #hero-bg video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center 15%;
}
        .header-icon-btn { transition: transform 0.2s ease, color 0.2s ease; }
        .header-icon-btn:hover { transform: translateY(-2px); }
        #header img[alt="GoShopMe Logo"] { image-rendering: crisp-edges; }
    </style>

<script>
// -------------------------------------------------------
// GLOBAL BADGE SYSTEM 
// -------------------------------------------------------
// Initialize

const BADGE_KEYS = { notif: 'goshopme_notif_count', cart: 'goshopme_cart_count' };
let cartCountValue = 0;
let notifCountValue = 0;

function getBadgeElements() {
    return {
        cartIndicator: document.getElementById("cart-indicator"),
        cartCount: document.getElementById("cart-count"),
        notifIndicator: document.getElementById("notif-indicator"),
        notifCount: document.getElementById("notif-count"),
    };
}

function updateCartBadge() {
    const el = getBadgeElements();
    if (!el.cartIndicator || !el.cartCount) return;

    const show = cartCountValue > 0;
    el.cartIndicator.classList.toggle("hidden", !show);
    el.cartCount.textContent = show ? (cartCountValue > 99 ? '99+' : cartCountValue) : "";
    try { localStorage.setItem(BADGE_KEYS.cart, String(cartCountValue)); } catch (e) {}
}

function updateNotifBadge() {
    const el = getBadgeElements();
    if (!el.notifIndicator || !el.notifCount) return;

    const show = notifCountValue > 0;
    el.notifIndicator.classList.toggle("hidden", !show);
    el.notifCount.textContent = show ? (notifCountValue > 99 ? '99+' : notifCountValue) : "";
    try { localStorage.setItem(BADGE_KEYS.notif, String(notifCountValue)); } catch (e) {}
}

window.addToCart = function () {
    cartCountValue++;
    updateCartBadge();
};

window.addNotification = function () {
    notifCountValue++;
    updateNotifBadge();
};

window.resetBadges = function () {
    cartCountValue = 0;
    notifCountValue = 0;
    updateCartBadge();
    updateNotifBadge();
};

document.addEventListener("DOMContentLoaded", () => {
    try {
        notifCountValue = parseInt(localStorage.getItem(BADGE_KEYS.notif) || '0', 10);
        cartCountValue = parseInt(localStorage.getItem(BADGE_KEYS.cart) || '0', 10);
    } catch (e) {}
    updateCartBadge();
    updateNotifBadge();
});

</script>

    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
</head>
<body class="bg-[#F6F6F6] min-h-screen overflow-x-hidden">

<div id="app-shell" class="relative w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl overflow-x-hidden">

<header id="header" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] z-50 bg-white border-b border-gray-100">
    <div class="flex items-center justify-between pl-0 pr-4 py-3">
        <div class="flex items-center justify-start flex-shrink-0 min-w-0 -ml-3">
            <img src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/GoShopMe%20logo.svg" alt="GoShopMe Logo" class="h-14 w-auto max-w-[220px] object-contain object-left block">
        </div>
        <div class="flex items-center gap-0">
            <!-- Notifications (no grey background, unified size) -->
            <a href="Notifications_Screen.html?from=home" id="notif-btn" class="header-icon-btn w-10 h-10 flex items-center justify-center relative overflow-visible text-gray-600 hover:text-gray-800" aria-label="Notifications">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 
                             8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 
                             01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 
                             0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 
                             0 11-5.714 0" />
                </svg>
                <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-[#F96226] rounded-full hidden items-center justify-center flex">
                    <span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span>
                </div>
            </a>

            <!-- Shopping cart (no grey background, unified size) -->
            <a href="Shopping_bag.html?from=home" id="cart-btn" class="header-icon-btn w-10 h-10 flex items-center justify-center relative overflow-visible text-gray-600 hover:text-gray-800" aria-label="Shopping bag">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 
                             12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 
                             01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 
                             1.059.435 1.119.993z" />
                </svg>
                <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-[#939BFB] rounded-full hidden items-center justify-center flex">
                    <span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span>
                </div>
            </a>
        </div>
    </div>
</header>

<main id="main-content" class="pt-20 pb-40 relative w-full max-w-[390px] mx-auto overflow-y-auto bg-white">

    <section id="hero-section" class="relative mt-0 h-[300px] min-h-[300px]">
<div id="hero-container" class="w-full h-full relative overflow-hidden bg-gray-100 isolate">
        <!-- Dynamic hero background (image or video) injected here -->
  <div id="hero-bg" class="absolute inset-0 w-full h-full z-0"></div>

        <!-- Dark overlay -->
        <div class="absolute inset-0 bg-black/30 z-10"></div>

        <!-- Text content -->
	<div id="hero-text" class="absolute inset-0 z-20 flex flex-col justify-center items-center text-white text-center px-6">

            <h2 id="hero-title" class="text-3xl font-semibold poppins mb-2"></h2>
            <p id="hero-subtitle" class="text-lg opacity-90 mb-6 dm-sans"></p>
            <button id="hero-invite-btn"
                class="bg-white text-[#939BFB] border border-[#939BFB] hover:bg-[#939BFB] hover:text-white transition-colors duration-300 px-5 py-2 rounded-full font-medium text-sm">
	      Invite
            </button>
        </div>

    </div>
</section>

    <section id="just-for-you" class="px-4 py-6">
    <div class="px-4 max-w-[390px] mx-auto">
 
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-black poppins">Just for You</h3>
            <p class="text-sm text-gray-600">based on your <span class="text-[#939BFB] underline cursor-pointer">size</span></p>
        </div>
       <div id="just-for-you-list" class="flex space-x-4 overflow-x-auto pb-2">
    <!-- dynamic product cards will be injected here -->
</div>

<!-- fallback (hidden by default) -->
<p id="just-for-you-empty" class="text-gray-500 text-sm hidden">
    No personalised suggestions yet. Start searching or liking items to personalise your feed.
</p>

    </section>

    <section id="trending-now" class="px-4 py-6">
 <div class="px-4 max-w-[390px] mx-auto">
        <a href="Trending_Now.html" class="block group">
        <h3 class="text-xl font-semibold text-black poppins mb-4 hover:text-[#939BFB] transition-colors cursor-pointer">Trending Now</h3>
        </a>
        <div id="trending-list" class="flex space-x-4 overflow-x-auto pb-2">
    <!-- dynamic trending cards -->
</div>

<p id="trending-empty" class="text-gray-500 text-sm hidden">
    No trending items available right now. Check back soon.
</p>
    </section>

    <section id="creator-collections" class="px-4 py-6">
    <div class="px-4 max-w-[390px] mx-auto">



        <a href="Picks.html" class="block group">
        <h3 class="text-xl font-semibold text-black poppins mb-4 hover:text-[#939BFB] transition-colors cursor-pointer">Creator's Picks</h3>
        </a>
       <div id="creator-list" class="flex space-x-4 overflow-x-auto pb-2">
    <!-- Dynamic creator collection cards will be injected here -->

    <!-- TEMPLATE (hidden) for JS cloning -->
    <template id="creator-card-template">
        <span class="creator-card flex-shrink-0 w-60 block cursor-pointer">
            <div class="relative bg-gray-100 rounded-xl h-40 mb-3 overflow-hidden">
                <!-- Dynamic creator cover image or video -->
                <div class="creator-cover w-full h-full overflow-hidden rounded-xl"></div>
                <!-- Wishlist + Share Buttons -->
                <div class="absolute top-3 right-3 flex space-x-2">
                    <button class="wishlist-btn hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px] text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 
                                3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
                        </svg>
                    </button>

                    <button class="share-btn hover:opacity-70 transition-opacity">
                        <svg class="w-[18px] h-[18px] text-white share-icon-tilted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 
                                59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Creator avatar + title + creator name -->
            <div class="flex items-center">
                <span class="creator-initials w-10 h-10 rounded-full mr-3 bg-[#E8EAFF] flex items-center justify-center text-shine-primary font-semibold text-sm hidden"></span>
                <img class="creator-avatar w-10 h-10 rounded-full mr-3 object-cover hidden" alt="Creator Avatar">

                <div>
                    <p class="creator-title text-black font-medium text-sm"></p>
                    <p class="creator-name text-gray-500 text-xs"></p>
                </div>
            </div>
        </span>
    </template>
</div>

    </section>

    <section id="shop-by-category" class="px-4 py-6">
  <div class="px-4 max-w-[390px] mx-auto">
    <div class="flex items-center justify-between mb-4">
      <a href="ShopbyCategory.html" class="block group">
      <h3 class="text-xl font-semibold text-black poppins hover:text-[#939BFB] transition-colors cursor-pointer">Shop by Category</h3>
      </a>
    </div>

    <div id="category-grid" class="grid grid-cols-2 gap-3">
      <!-- JS will inject categories here -->
    </div>
  </div>
</section>
   <section id="recent-activity" class="px-4 py-6">

    <div class="px-4 max-w-[390px] mx-auto">

       <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-black poppins">Recent Activity</h3>
        <button class="text-[#939BFB] text-sm font-medium hover:opacity-70 transition-opacity">
            View All
        </button>
    </div>

    <!-- Dynamic container -->
    <div id="recent-activity-list" class="space-y-3 min-h-[60px]">
        <!-- JS inserts items here -->
    </div>

    <!-- Fallback -->
  <p id="recent-activity-empty"
   class="flex items-center justify-center gap-3 text-sm text-gray-500 py-4">
    
    <svg xmlns="http://www.w3.org/2000/svg"
         class="w-5 h-5 text-gray-400"
         fill="none" viewBox="0 0 24 24"
         stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 6v6l4 2m6-2a10 10 0 11-20 0 10 10 0 0120 0z" />
    </svg>

    <span>No recent activity yet.</span>
</p>

  </div>
</section>
</main>

<div id="chat-overlay" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

<div id="chat-drawer" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white rounded-t-3xl shadow-2xl z-50 h-[50vh] transform translate-y-full transition-transform duration-300 flex flex-col border-t border-gray-100">
    <div id="drag-handle-zone" class="chat-drawer-drag-zone flex justify-center pt-2 flex-shrink-0">
        <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full pointer-events-none"></div>
    </div>

    <div id="chat-header" class="flex items-center p-4 pb-2 flex-shrink-0">
        <button id="back-btn" class="mr-3 hidden hover:opacity-70 transition-opacity">
            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
            </svg>
        </button>
        <div class="w-8 h-8 rounded-full overflow-hidden mr-3 flex-shrink-0">
            <img class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar />
        </div>
        <div class="flex-1">
            <p class="font-semibold text-black text-sm" id="header-title">ShAI</p>
            <p class="text-xs text-gray-500" id="header-subtitle">Your shopping assistant</p>
        </div>
    </div>

    <div id="chat-content" class="flex-1 flex flex-col min-h-0">
        <div id="chat-messages" class="flex-1 overflow-y-auto">
            <div class="p-4 pb-0">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                        <img class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar />
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 mb-3">
                            <p class="text-sm text-black">Hi there! I'm ShAI, your personal shopping assistant. How can I help you find the perfect items today?</p>
                        </div>
                        <div id="smart-prompts" class="flex-shrink-0">
                            <div class="flex flex-wrap gap-2 pb-2">
                                <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">I need a formal outfit</button>
                                <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Find me seasonal outfits</button>
                                <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">What's trending right now?</button>
                                <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Elevate my workwear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-input-drawer" class="bg-white border-t border-gray-100 p-4 flex-shrink-0">
            <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm">
                <button id="cam-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/>
                    </svg>
                </button>
                <input type="text" id="chat-input-drawer-field" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
                <button id="add-friend-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                    </svg>
                </button>
                <button id="mic-btn-drawer" class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <button id="send-btn-drawer" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="add-friend-content" class="flex-1 flex flex-col min-h-0 hidden">
        <div id="contact-list" class="flex-1 overflow-y-auto p-4">
            <div class="mb-4">
                <div class="relative">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
                    <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 pl-10 text-sm">
                </div>
            </div>
            
            <div id="contacts-container" class="space-y-2"><!-- Contacts rendered dynamically --></div>
        </div>

        <div id="add-friend-input" class="bg-white border-t border-gray-100 p-4 flex-shrink-0">
            <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm">
                <button class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/>
                    </svg>
                </button>
                <input type="text" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
                <button class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
                    </svg>
                </button>
                <button class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 z-50">
    <div class="flex items-center justify-around py-2">
        <a href="Home.html" class="bottom-nav-btn active">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
            </svg>
            <span class="text-xs">Home</span>
        </a>
        <a href="Picks.html" class="bottom-nav-btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
            </svg>
            <span class="text-xs">Picks</span>
        </a>
        <a href="Wishlist.html" class="bottom-nav-btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
            </svg>
            <span class="text-xs">Wishlist</span>
        </a>
        <a id="home-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn">
            <span id="home-nav-profile-icon" class="flex items-center justify-center w-6 h-6 mb-1 text-shine-primary">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
            </span>
            <img id="home-nav-profile-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
            <span class="text-xs">Profile</span>
        </a>
    </div>
</nav>
<script>
// Bottom nav profile: show profile icon if no uploaded photo, else show saved photo from localStorage; Profile link = paid/free based on __userPlan
(function() {
    var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
    var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
    var profileLink = document.getElementById('home-nav-profile-link');
    if (profileLink) profileLink.href = profileHref;
    var saved = null;
    try { saved = localStorage.getItem('profilePhoto'); } catch (e) {}
    var img = document.getElementById('home-nav-profile-photo');
    var icon = document.getElementById('home-nav-profile-icon');
    if (img && icon) {
        if (saved) {
            img.src = saved;
            img.classList.remove('hidden');
            icon.classList.add('hidden');
        } else {
            img.src = '';
            img.classList.add('hidden');
            icon.classList.remove('hidden');
        }
    }
})();
</script>

<div id="chat-input-bar" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 p-4 z-30">
    <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm">
        <button id="cam-btn" class="icon-button hover:opacity-70 transition-opacity">
            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/>
            </svg>
        </button>
        <input type="text" id="message-input" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px]">
        <button id="add-friend-btn" class="icon-button hover:opacity-70 transition-opacity">
            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
            </svg>
        </button>
        <button id="mic-btn" class="icon-button hover:opacity-70 transition-opacity">
            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
            </svg>
        </button>
        <button id="send-btn" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
            </svg>
        </button>
    </div>
</div>
<script src="js/home-api.js"></script>
<!-- =========================================================
     UNIVERSAL PRODUCT CARD TEMPLATE (Used by ALL dynamic feeds)
     ========================================================= -->
<script>
window.renderProductCard = function (product) {
    return `
<span class="flex-shrink-0 w-40 block cursor-pointer" onclick="openProductDetail('${(product.id || '').replace(/'/g, "\\'")}', '${(product.name || '').replace(/'/g, "\\'")}', '${(product.brand || '').replace(/'/g, "\\'")}', '${(product.image || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${(product.price || '').replace(/'/g, "\\'").replace(/"/g, '&quot;')}')">

    <div class="relative product-image-overlay-wrap bg-gray-100 rounded-xl h-48 mb-3 overflow-hidden">

        <img class="w-full h-full object-cover" 
             src="${product.image}" 
             alt="${product.name}" />

        <div class="absolute top-2 right-2 flex flex-col space-y-2">

            <!-- HEART -->
            <button class="p-1 flex items-center justify-center hover:opacity-80 transition-opacity"
                    onclick="event.stopPropagation(); toggleWishlist(this, '${product.id}')">
                <svg class="w-[18px] h-[18px] text-white product-overlay-icon" fill="none" 
                     stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5
                             -1.935 0 -3.597 1.126 -4.312 2.733
                             -.715 -1.607 -2.377 -2.733 -4.313 -2.733
                             C5.1 3.75 3 5.765 3 8.25
                             c0 7.22 9 12 9 12s9-4.78 9-12z"/>
                </svg>
            </button>

            <!-- SHARE -->
            <button class="p-1 flex items-center justify-center hover:opacity-80 transition-opacity"
                    onclick="event.stopPropagation(); shareProduct('${(product.name || '').replace(/'/g, "\\'")}', '${(product.price || '').replace(/'/g, "\\'")}', null, '${(product.id || '').replace(/'/g, "\\'")}', '${(product.brand || '').replace(/'/g, "\\'")}')">
                <svg class="w-[18px] h-[18px] text-white product-overlay-icon share-icon-tilted" 
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12
                             59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                </svg>
            </button>

            <!-- CHAT -->
            <button class="p-1 flex items-center justify-center hover:opacity-80 transition-opacity chat-trigger"
                    data-item="${product.name}"
                    onclick="event.stopPropagation(); openProductChat('${product.name}', '${product.price}', '${product.image}')">
                <svg class="w-4 h-4 text-white product-overlay-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/>
                </svg>
            </button>

        </div>
    </div>

    <p class="text-xs text-gray-500">${product.brand}</p>
    <p class="font-medium text-sm text-black">${product.name}</p>
    <p class="font-semibold text-sm text-black">${product.price}</p>

</span>
    `;
};
</script>
<!-- ============= END TEMPLATE INSERT ============= -->
<script>
/* ----------------------------------------------
   HELPERS
---------------------------------------------- */

function injectProducts(listId, fallbackId, products) {
    const list = document.getElementById(listId);
    const fallback = document.getElementById(fallbackId);

    if (!list) return;

    list.innerHTML = "";

    if (!products || products.length === 0) {
        fallback?.classList.remove("hidden");
        return;
    }

    fallback?.classList.add("hidden");

    window.__productCache = window.__productCache || {};
    products.forEach(p => {
        if (p.id) window.__productCache[p.id] = p;
        const cardHtml = window.renderProductCard(p);
        const wrapper = document.createElement("div");
        wrapper.innerHTML = cardHtml;
        list.appendChild(wrapper.firstElementChild);
    });
}

/* ----------------------------------------------
   MAIN LOADING FUNCTION
---------------------------------------------- */

window.loadHomeDynamicSections = function (data) {

    // JUST FOR YOU
    injectProducts(
        "just-for-you-list",      // CORRECT ID
        "just-for-you-empty",
        data.justForYou || []
    );

    // TRENDING NOW
    injectProducts(
        "trending-list",          // CORRECT ID
        "trending-empty",
        data.trending || []
    );
};

/* ----------------------------------------------
   INLINE FALLBACK (works when file:// blocks fetch/CORS)
---------------------------------------------- */
window.__HOME_FALLBACK_DATA = {"justForYou":[{"id":"silk-midi-dress","name":"Silk Midi Dress","brand":"Reformation","price":"$248","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/silk%20midi%20dress.jpg"},{"id":"cashmere-sweater","name":"Cashmere Sweater","brand":"Brunello Cucinelli","price":"$1,850","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/cashmere%20sweater.jpg"},{"id":"leather-ankle-boots","name":"Leather Ankle Boots","brand":"Totême","price":"$640","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/leather%20ankle%20boots.jpg"},{"id":"gold-chain-necklace","name":"Gold Chain Necklace","brand":"Cartier","price":"$2,100","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/gold%20necklace.jpg"},{"id":"structured-blazer","name":"Le Smoking Blazer","brand":"Saint Laurent","price":"$1,890","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Saint%20Laurent%20Blazer.jpg"},{"id":"designer-tote","name":"Le 5 À 7 Tote","brand":"Saint Laurent","price":"$1,490","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Saint%20Laurent%20bag.jpg"}],"trending":[{"id":"vintage-blazer","name":"Vintage Blazer","brand":"Mugler","price":"$850","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/mugler%20blazer.jpg"},{"id":"editorial-dress","name":"Editorial Midi Dress","brand":"Bottega Veneta","price":"$2,400","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/bottega%20venetta%20dress.jpg"},{"id":"runway-heels","name":"Tribute Sandals","brand":"Saint Laurent","price":"$695","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Saint%20Laurent%20sandals.jpg"},{"id":"statement-earrings","name":"Statement Earrings","brand":"Bottega Veneta","price":"$1,200","image":"https://images.unsplash.com/photo-1535632066927-ab7c9ab60908?w=500&h=650&fit=crop"},{"id":"paris-editorial","name":"Paris FW Blazer","brand":"Chanel","price":"$4,200","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/chanel%20blazer.jpg"}],"creatorCollections":[{"id":"minimalist-chic","title":"Paris in Spring","creatorName":"Emma Style","creatorAvatarUrl":"https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-5.jpg","coverType":"image","coverUrl":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Paris%20in%20Spring.jpg","wishlistId":"minimalist-chic-collection"},{"id":"bold-bright","title":"Power Business","creatorName":"Anna Rivera","creatorAvatarUrl":"https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-6.jpg","coverType":"image","coverUrl":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Business%20collection.jpg","wishlistId":"bold-bright-collection"},{"id":"neutral-power","title":"Neutral Power","creatorName":"StyledByMira","creatorAvatarUrl":"https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-1.jpg","coverType":"image","coverUrl":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Neutrals.jpg","wishlistId":"neutral-power-collection"},{"id":"urban-street","title":"Urban Street Style","creatorName":"Maya Johnson","creatorAvatarUrl":"https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-1.jpg","coverType":"image","coverUrl":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Urban%20style.jpg","wishlistId":"urban-street-collection"}],"categories":[{"id":"shoes","name":"Shoes","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shoes%201.jpg"},{"id":"dresses","name":"Dresses","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/dresses.jpg"},{"id":"bags","name":"Bags","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/bags.jpg"},{"id":"workwear","name":"Workwear","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Workwear.jpg"},{"id":"swimwear","name":"Swimwear","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/swimwear%201.jpg"},{"id":"sale","name":"Sale","image":"https://storage.googleapis.com/uxpilot-auth.appspot.com/179cee2d51-68640f3705cf734d5d3e.png"}],"recentActivity":[{"chatId":"theory-blazer","title":"Theory Power Blazer","subtitle":"Size advice","timeAgo":"2h ago","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Power%20blazer.jpg"},{"chatId":"reformation-dress","title":"Reformation Midi Dress","subtitle":"Color options","timeAgo":"Yesterday","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/reformation%20midi%20dress.jpg"},{"chatId":"mejuri-necklace","title":"Mejuri Chain Necklace","subtitle":"Layering tips","timeAgo":"2 days ago","image":"https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/chain%20necklace.jpg"}]};

/* ----------------------------------------------
   LOAD HOME DATA (API / data/home.json / inline fallback)
---------------------------------------------- */
async function loadHomeData() {
    // Use inline fallback data directly (works with file:// protocol).
    // Only attempt API fetch if a custom API URL is explicitly configured.
    let data = window.__HOME_FALLBACK_DATA || { justForYou: [], trending: [], creatorCollections: [], categories: [], recentActivity: [] };

    if (window.GOSHOPME_API_BASE_URL) {
        try {
            const r = await fetch(window.GOSHOPME_API_BASE_URL + '/home/feed', {
                credentials: 'same-origin', headers: { 'Accept': 'application/json' }
            });
            if (r.ok) { const json = await r.json(); data = json.data || json; }
        } catch (e) {}
    }

    loadHomeDynamicSections({
        justForYou: data.justForYou || [],
        trending: data.trending || []
    });
    loadCreatorCollections(data.creatorCollections || []);
    if (data.categories && data.categories.length) window.renderCategories(data.categories);
    if (data.recentActivity && data.recentActivity.length) window.renderRecentActivity(data.recentActivity);
}
document.addEventListener('DOMContentLoaded', loadHomeData);
</script>


<script>
(() => {
  function upgradeToAutoGrowTextarea(cfg) {
    const old = document.querySelector(cfg.selector);
    if (!old) return;

    // Create textarea with same identity & classes
    const ta = document.createElement('textarea');
    ta.id = old.id;
    ta.className = old.className + ' resize-none';
    ta.placeholder = old.placeholder || '';
    ta.value = old.value || '';
    ta.rows = 1;
    ta.autocomplete = 'off';
    ta.spellcheck = true;
    ta.style.overflowY = 'hidden';

    // Swap in DOM
    old.parentNode.replaceChild(ta, old);

    // Controls
    const mic  = document.querySelector(cfg.mic);
    const add  = document.querySelector(cfg.add);
    const send = document.querySelector(cfg.send);
    const chatScroll = document.getElementById('chat-messages');

    // Helpers
    const rowH = () => {
      const lh = parseFloat(getComputedStyle(ta).lineHeight);
      return Number.isFinite(lh) ? lh : 20;
    };
    const autoResize = () => {
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 6 * rowH()) + 'px'; // cap ~6 rows
    };
    const updateButtons = () => {
      const hasText = ta.value.trim().length > 0;
      if (mic)  mic.classList.toggle('hidden',  hasText);
      if (add)  add.classList.toggle('hidden',  hasText);
      if (send) send.classList.toggle('hidden', !hasText);
    };
    const sendNow = () => {
      const text = ta.value.trim();
      if (!text) return;
      const container = document.querySelector('#chat-messages .p-4');
      if (container) {
        const wrap = document.createElement('div');
        wrap.className = 'flex justify-end mb-4';
        wrap.innerHTML = `
          <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
            <p class="text-sm"></p>
          </div>`;
        wrap.querySelector('p').textContent = text;
        container.appendChild(wrap);
        if (chatScroll) chatScroll.scrollTop = chatScroll.scrollHeight;
      }
      ta.value = '';
      autoResize();
      updateButtons();
    };

    // Events
    ta.addEventListener('input', () => { autoResize(); updateButtons(); });
    ta.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Enter = send
        sendNow();
      }
      // Shift+Enter = newline (default)
    });
    if (send) {
      // Original click handler still targets the old <input>; add a fresh one for the textarea
      send.addEventListener('click', sendNow);
    }

    // Init
    autoResize();
    updateButtons();

    // Optional: grow on focus inside the drawer
    if (cfg.onFocusGrow) {
      ta.addEventListener('focus', () => {
        const drawer = document.getElementById('chat-drawer');
        if (drawer) drawer.style.height = '50vh';
      });
    }
  }

  // Apply to both chat inputs
  upgradeToAutoGrowTextarea({
    selector: '#message-input',
    mic: '#mic-btn',
    add: '#add-friend-btn',
    send: '#send-btn'
  });

  upgradeToAutoGrowTextarea({
    selector: '#chat-input-drawer-field',
    mic: '#mic-btn-drawer',
    add: '#add-friend-btn-drawer',
    send: '#send-btn-drawer',
    onFocusGrow: true
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ShAI avatar: set from DB when loaded. Call window.setShAIAvatar(url) from API response.
    window.setShAIAvatar = function(url) {
        window.__shaiAvatarUrl = url || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
        document.querySelectorAll('[data-shai-avatar]').forEach(function(img) { img.src = window.__shaiAvatarUrl; });
    };
    window.testShAIAvatar = function(url) {
        const testUrl = url || 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg';
        window.setShAIAvatar(testUrl);
        console.log('testShAIAvatar:', testUrl);
    };

    const chatDrawer = document.getElementById("chat-drawer");
    const chatOverlay = document.getElementById("chat-overlay");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("message-input");
    const chatInputDrawer = document.getElementById("chat-input-drawer-field");
    const micBtn = document.getElementById("mic-btn");
    const sendBtn = document.getElementById("send-btn");
    const addFriendBtn = document.getElementById("add-friend-btn");
    const micBtnDrawer = document.getElementById("mic-btn-drawer");
    const sendBtnDrawer = document.getElementById("send-btn-drawer");
    const addFriendBtnDrawer = document.getElementById("add-friend-btn-drawer");
    const dragHandleZone = document.getElementById("drag-handle-zone") || document.getElementById("drag-handle");
    const chatInputBar = document.getElementById("chat-input-bar");

    let autoScrollEnabled = true;
    let isDrawerExpanded = false; // Set true after expandDrawer() on init
    let startY = 0;
    let currentHeight = 80;
    let isDragging = false;

    // --- 1) Fix wrapping for all text bubbles ---
    function fixWrapping() {
        document.querySelectorAll("#chat-messages p.text-sm").forEach(p => {
            p.classList.add("break-words","whitespace-pre-wrap");
        });
    }
    fixWrapping();

    // --- 2) Auto-scroll helper - scroll to last message ---
    function scrollToBottom(force=false) {
        const chatMessages = document.getElementById("chat-messages");
        if (!chatMessages) return;
        const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 20;
        if (force || atBottom) {
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            });
        }
    }

    // --- 3) Observe for any new bubbles (text, image, video, voice) ---
    if (chatMessages) {
        const observer = new MutationObserver(() => {
            fixWrapping();
            setTimeout(() => scrollToBottom(true), 50);
        });
        observer.observe(chatMessages, { childList:true, subtree:true });
    }

    // === Scroll Behavior ===
    chatMessages.addEventListener("scroll", () => {
        const atBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 20;
        autoScrollEnabled = atBottom;
    });

    // === SEND MESSAGE ===
    function sendMessage(inputEl, mic, addFriend, send) {
        const text = inputEl.value.trim();
        if (!text) return;

        const chatMessagesContainer = chatMessages.querySelector(".p-4");
        if (chatMessagesContainer) {
            const userMsg = document.createElement("div");
            userMsg.className = "flex justify-end mb-4";
            userMsg.innerHTML = `
                <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
                    <p class="text-sm break-words whitespace-pre-wrap">${text.replace(/</g, '&lt;')}</p>
                </div>`;
            chatMessagesContainer.appendChild(userMsg);
        }

        inputEl.value = "";
        mic.classList.remove("hidden");
        addFriend.classList.remove("hidden");
        send.classList.add("hidden");

        scrollToBottom(true);

        // Contextual ShAI reply to text message
        setTimeout(() => {
            addShAIMessage("Perfect! Let me help you find exactly what you're looking for. I'll show you some great options that match your style.");
        }, 1000);
    }

    // === Update Input State ===
    function updateInputState(inputEl, mic, addFriend, send) {
        if (inputEl.value.trim()) {
            mic.classList.add("hidden");
            addFriend.classList.add("hidden");
            send.classList.remove("hidden");
        } else {
            mic.classList.remove("hidden");
            addFriend.classList.remove("hidden");
            send.classList.add("hidden");
        }
    }

    [chatInput, chatInputDrawer].forEach((inputEl, idx) => {
        if (!inputEl) return;
        const mic = idx === 0 ? micBtn : micBtnDrawer;
        const send = idx === 0 ? sendBtn : sendBtnDrawer;
        const add = idx === 0 ? addFriendBtn : addFriendBtnDrawer;

        inputEl.addEventListener("input", () => updateInputState(inputEl, mic, add, send));
        inputEl.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage(inputEl, mic, add, send);
            }
        });
        send.addEventListener("click", () => sendMessage(inputEl, mic, add, send));
    });

    // === Drawer Expand/Collapse (authoritative, default 80%) ===
    function expandDrawer() {
        if (!chatDrawer) return;
        chatDrawer.classList.remove('translate-y-full');
        chatOverlay.classList.remove('hidden');
        chatInputBar.classList.add('hidden');
        isDrawerExpanded = true;
        currentHeight = 80;
        chatDrawer.style.height = '50vh';
        // Lock main page scroll while drawer is open (overflow only — touchAction interferes with drag)
        document.body.style.overflow = 'hidden';
    }

    function collapseDrawer() {
        if (!chatDrawer) return;
        chatDrawer.classList.add('translate-y-full');
        chatOverlay.classList.add('hidden');
        chatInputBar.classList.remove('hidden');
        isDrawerExpanded = false;
        currentHeight = 80;
        chatDrawer.style.height = '50vh';
        if (isAddFriendMode) {
            hideAddFriendFlow();
        }
        // Restore main page scroll
        document.body.style.overflow = '';
    }

    if (chatOverlay) {
        chatOverlay.addEventListener("click", collapseDrawer);
    }

    // Open drawer by default
    expandDrawer();

    // === Dragging Drawer ===
    // Uses native touch events directly on the drag zone — most reliable on Android Chrome.
    // Pointer Events API was avoided because setPointerCapture freezes when body.overflow=hidden.
    const CLOSE_THRESHOLD = 30;
    let dragStartY = 0;
    let dragStartH = 0;

    function onDragEnd() {
        if (!isDragging) return;
        isDragging = false;
        chatDrawer.style.transition = "";          // re-enable snap animation
        const h = (chatDrawer.getBoundingClientRect().height / window.innerHeight) * 100;
        if (h < CLOSE_THRESHOLD) {
            collapseDrawer();
        } else {
            currentHeight = Math.max(35, Math.min(90, h));
            chatDrawer.style.height = currentHeight + "vh";
        }
    }

    if (dragHandleZone) {
        dragHandleZone.style.userSelect = "none";
        dragHandleZone.style.cursor     = "grab";
        dragHandleZone.style.paddingTop    = "14px";
        dragHandleZone.style.paddingBottom = "14px";

        // --- Touch (mobile) ---
        dragHandleZone.addEventListener("touchstart", e => {
            isDragging   = true;
            dragStartY   = e.touches[0].clientY;
            dragStartH   = chatDrawer.getBoundingClientRect().height;
            chatDrawer.style.transition = "none";
        }, { passive: true });

        dragHandleZone.addEventListener("touchmove", e => {
            if (!isDragging) return;
            e.preventDefault();                    // stop page scroll during drag
            const dy   = e.touches[0].clientY - dragStartY;
            const newH = Math.max(80, Math.min(window.innerHeight * 0.92, dragStartH - dy));
            chatDrawer.style.height = newH + "px";
            currentHeight = (newH / window.innerHeight) * 100;
        }, { passive: false });

        dragHandleZone.addEventListener("touchend",    onDragEnd, { passive: true });
        dragHandleZone.addEventListener("touchcancel", onDragEnd, { passive: true });

        // --- Mouse (desktop testing) ---
        dragHandleZone.addEventListener("mousedown", e => {
            isDragging  = true;
            dragStartY  = e.clientY;
            dragStartH  = chatDrawer.getBoundingClientRect().height;
            chatDrawer.style.transition = "none";

            function onMouseMove(ev) {
                if (!isDragging) return;
                const dy   = ev.clientY - dragStartY;
                const newH = Math.max(80, Math.min(window.innerHeight * 0.92, dragStartH - dy));
                chatDrawer.style.height = newH + "px";
                currentHeight = (newH / window.innerHeight) * 100;
            }
            function onMouseUp() {
                document.removeEventListener("mousemove", onMouseMove);
                document.removeEventListener("mouseup",  onMouseUp);
                onDragEnd();
            }
            document.addEventListener("mousemove", onMouseMove);
            document.addEventListener("mouseup",  onMouseUp);
        });
    }

    const addFriendContent = document.getElementById("add-friend-content");
    const chatContent = document.getElementById("chat-content");
    const contactSearch = document.getElementById("contact-search");
    const contactsContainer = document.getElementById("contacts-container");

    // Add Friend contacts: dynamic. Set window.__addFriendContacts before load or call loadAddFriendContacts(apiData).
    // Each contact: { name, phone, goshopme: boolean, avatar?: string }
    // GoShopMe user with avatar -> show photo; GoShopMe user without avatar -> initials; non-GoShopMe -> initials
    window.__addFriendContacts = window.__addFriendContacts || [
        { name: 'Alex Johnson', phone: '+1 (555) 123-4567', goshopme: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg' },
        { name: 'Maria Rodriguez', phone: '+1 (555) 987-6543', goshopme: false },
        { name: 'David Kim', phone: '+1 (555) 456-7890', goshopme: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-3.jpg' },
        { name: 'Sarah Thompson', phone: '+1 (555) 234-5678', goshopme: false },
        { name: 'Emma Wilson', phone: '+1 (555) 345-6789', goshopme: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-5.jpg' },
        { name: 'Michael Brown', phone: '+1 (555) 678-9012', goshopme: false },
        { name: 'Jennifer Lee', phone: '+1 (555) 789-0123', goshopme: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-6.jpg' },
        { name: 'Robert Davis', phone: '+1 (555) 890-1234', goshopme: false },
        { name: 'Lisa Chen', phone: '+1 (555) 111-2222', goshopme: true }
    ];
    function getInitials(name) {
        const parts = (name || '').trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return (parts[0] ? parts[0].slice(0, 2) : '??').toUpperCase();
    }
    function renderAddFriendContacts(container) {
        if (!container) return;
        const list = Array.isArray(window.__addFriendContacts) ? window.__addFriendContacts : [];
        container.innerHTML = list.map(c => {
            const initials = getInitials(c.name);
            const hasAvatar = c.goshopme && c.avatar;
            const avatarHtml = hasAvatar
                ? `<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img src="${c.avatar}" alt="${c.name}" class="w-full h-full object-cover"></div>`
                : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">${initials}</span></div>`;
            const btnHtml = c.goshopme
                ? '<button class="contact-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs font-medium">Add</button>'
                : '<button class="contact-action bg-white text-[#939BFB] px-2 py-1 rounded-full text-xs font-medium border border-[#939BFB]">Invite</button>';
            return `<div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="${(c.name || '').replace(/"/g, '&quot;')}" data-phone="${(c.phone || '').replace(/"/g, '&quot;')}" data-goshopme="${c.goshopme ? 'true' : 'false'}">${avatarHtml}<div class="flex-1"><p class="font-medium text-sm text-black">${(c.name || '').replace(/</g, '&lt;')}</p><p class="text-xs text-gray-500">${(c.phone || '').replace(/</g, '&lt;')}</p></div>${btnHtml}</div>`;
        }).join('');
    }
    window.loadAddFriendContacts = function(data) {
        window.__addFriendContacts = Array.isArray(data) ? data : [];
        renderAddFriendContacts(contactsContainer);
    };
    renderAddFriendContacts(contactsContainer);
    const backBtn = document.getElementById("back-btn");
    const headerTitle = document.getElementById("header-title");
    const headerSubtitle = document.getElementById("header-subtitle");
    const heroInviteBtn = document.getElementById("hero-invite-btn");
    const smartPrompts = document.querySelectorAll('#smart-prompts button');
    
    const camBtns = [
        document.getElementById("cam-btn"),
        document.getElementById("cam-btn-drawer")
    ];

    const micBtns = [micBtn, micBtnDrawer];
    const sendBtns = [sendBtn, sendBtnDrawer];
    
    let isAddFriendMode = false;
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let startX;
    let wishlistItems = new Set();
    let micAccessDenied = false;
    let mediaStream = null;
    
    // === Toggle buttons based on typing (dup guard but harmless) ===
    function updateInputStateLegacy(inputEl, mic, addFriend, send) {
        if (inputEl.value.trim()) {
            mic.classList.add("hidden");
            addFriend.classList.add("hidden");
            send.classList.remove("hidden");
        } else {
            mic.classList.remove("hidden");
            addFriend.classList.remove("hidden");
            send.classList.add("hidden");
        }
    }

    if (chatInput) {
        chatInput.addEventListener("input", () => {
            updateInputStateLegacy(chatInput, micBtn, addFriendBtn, sendBtn);
        });
    }
    if (chatInputDrawer) {
        chatInputDrawer.addEventListener("input", () => {
            updateInputStateLegacy(chatInputDrawer, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer);
        });
    }

    // === SEND TEXT MESSAGE (legacy usages) ===
    function sendMessageLegacy(inputEl, mic, addFriend, send) {
        const text = inputEl.value.trim();
        if (!text) return;
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        if (chatMessagesContainer) {
            const userMsg = document.createElement('div');
            userMsg.className = 'flex justify-end mb-4';
            userMsg.innerHTML = `
                <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
                    <p class="text-sm break-words whitespace-pre-wrap">${text}</p>
                </div>`;
            chatMessagesContainer.appendChild(userMsg);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            inputEl.value = "";

            mic.classList.remove("hidden");
            addFriend.classList.remove("hidden");
            send.classList.add("hidden");
        }
    }

    sendBtn.addEventListener("click", () => sendMessageLegacy(chatInput, micBtn, addFriendBtn, sendBtn));
    sendBtnDrawer.addEventListener("click", () => sendMessageLegacy(chatInputDrawer, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer));

    chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessageLegacy(chatInput, micBtn, addFriendBtn, sendBtn);
        }
    });

    chatInputDrawer.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessageLegacy(chatInputDrawer, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer);
        }
    });

    // === Helper: System Bubble (permission denied, errors, etc.) ===
    function renderSystemBubble(message) {
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        if (chatMessagesContainer) {
            const bubble = document.createElement('div');
            bubble.className = 'flex justify-center mb-2';
            bubble.innerHTML = `
                <div class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                    ${message}
                </div>
            `;
            chatMessagesContainer.appendChild(bubble);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    }

    // === Camera handler ===
    function handleCameraAccess() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*,video/*";
        input.onchange = (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) handleFileSelection(file);
            input.value = "";
        };
        input.click();
    }

    function handleFileSelection(file) {
        const url = URL.createObjectURL(file);
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        const chatMessagesEl = document.getElementById('chat-messages');
        if (chatMessagesContainer) {
            let bubble;
            if (file.type.startsWith("image/")) {
                bubble = document.createElement('div');
                bubble.className = 'flex justify-end mb-4';
                bubble.innerHTML = `
                    <div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm">
                        <img src="${url}" class="w-full h-auto" alt="Uploaded image" />
                    </div>
                `;
            } else if (file.type.startsWith("video/")) {
                bubble = document.createElement('div');
                bubble.className = 'flex justify-end mb-4';
                bubble.innerHTML = `
                    <div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm relative">
                        <video src="${url}" controls class="w-full h-auto"></video>
                    </div>
                `;
            }
            
            if (bubble) {
                chatMessagesContainer.appendChild(bubble);
                if (chatMessagesEl) requestAnimationFrame(function() { requestAnimationFrame(function() { chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight; }); });
                
                // Contextual ShAI reply to image/video
                setTimeout(() => {
                    const isVideo = file.type.startsWith("video/");
                    if (isVideo) {
                        addShAIMessage("Great! I can analyze your video. Let me find products that match what I see.");
                    } else {
                        addShAIMessage("Perfect! I can see your image. Let me analyze it and find similar products for you.");
                    }
                }, 1500);
            }
        }
    }

    function setupCameraButton() {
        camBtns.forEach(btn => {
            if (!btn) return;
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                const openAndPick = () => {
                    handleCameraAccess();
                };
                if (!chatDrawer.classList.contains('translate-y-full')) {
                    openAndPick();
                } else {
                    expandDrawer();
                    setTimeout(openAndPick, 300);
                }
            });
        });
    }

    // === VOICE RECORDING ===
    function setupVoiceRecording() {
        micBtns.forEach(btn => {
            if (!btn) return;
            btn.addEventListener("mousedown", startRecording);
            btn.addEventListener("touchstart", startRecording);

            btn.addEventListener("mouseup", stopRecording);
            btn.addEventListener("mouseleave", cancelRecording);
            btn.addEventListener("touchend", stopRecording);
            btn.addEventListener("touchcancel", cancelRecording);
            btn.addEventListener("touchmove", handleSwipeCancel);
        });
    }
function removeTempRecordingBubble() {
    const temp = document.getElementById("temp-recording");
    if (temp) temp.remove();
}
   async function startRecording(e) {
    e.preventDefault();

    // Always clear any previous temp bubble before starting a new press
    removeTempRecordingBubble();

    if (!isDrawerExpanded) {
        expandDrawer();
        return;
    }

    if (micAccessDenied) {
        showToast("Microphone access denied. Enable it in your browser settings to record voice messages.");
        return;
    }

    startX = e.touches ? e.touches[0].clientX : e.clientX;

    try {
        if (!mediaStream || !mediaStream.active) {
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }

        mediaRecorder = new MediaRecorder(mediaStream);
        isRecording = true;
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) audioChunks.push(event.data);
        };
        mediaRecorder.start();

        this.classList.add("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");

        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        if (chatMessagesContainer) {
            const tempBubble = document.createElement('div');
            tempBubble.id = 'temp-recording';
            tempBubble.className = 'flex justify-end mb-2';
            tempBubble.innerHTML = `
                <div class="flex items-center bg-[#939BFB] text-white rounded-2xl px-3 py-2 max-w-[70%]">
                    <span class="mr-2">🎙️</span>
                    <span class="text-xs">
                        Recording... swipe left to cancel
                    </span>
                </div>
            `;
            chatMessagesContainer.appendChild(tempBubble);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    } catch (err) {
        // Ensure the temp "Recording... swipe left to cancel" bubble never lingers
        removeTempRecordingBubble();

        if (err && (err.name === "NotAllowedError" || err.name === "SecurityError")) {
            micAccessDenied = true;
            showToast("Microphone access denied. Enable it in your browser settings to record voice messages.");
        } else {
            showToast("Could not access microphone. Please try again.");
            console.warn("Microphone error:", err);
        }
    }
}
    function stopRecording(e) {
        e.preventDefault();
        if (!isRecording) return;
        isRecording = false;
        this.classList.remove("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");
        const temp = document.getElementById("temp-recording");
        if (temp) temp.remove();

        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                const audioUrl = URL.createObjectURL(audioBlob);
                renderAudioBubble(audioUrl);
            };
        }
    }

    function cancelRecording(e) {
    if (!isRecording) return;
    isRecording = false;
    this.classList.remove("scale-110", "ring-2", "ring-[#939BFB]", "ring-offset-2");

    // Remove the temporary "Recording... swipe left to cancel" bubble
    const temp = document.getElementById("temp-recording");
    if (temp) temp.remove();

    // Stop recorder without adding any chat message
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }
}

    function handleSwipeCancel(e) {
        if (!isRecording || !e.touches || !e.touches.length) return;
        const currentX = e.touches[0].clientX;
        if (startX - currentX > 30) { 
            cancelRecording.call(this, e);
        }
    }

  function renderAudioBubble(url) {
    const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
    if (chatMessagesContainer) {
        const bubble = document.createElement('div');
        bubble.className = 'flex justify-end mb-2';
        bubble.innerHTML = `
            <div role="group" aria-label="Voice message from you" class="voice-message-bubble bg-[#939BFB] text-white rounded-full px-3 py-2 flex items-center gap-2 h-11 shadow-sm">
                <button aria-label="Play voice message from you" class="play-btn flex-shrink-0 w-6 h-6 border border-white rounded-full flex items-center justify-center hover:bg-white/20 transition-all duration-150 hover:scale-105" onclick="toggleVoicePlayback(this, '${url}')">
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <div class="waveform flex-1 flex items-center justify-center gap-0.5 h-4 max-w-[120px]">
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 0"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 1"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 2"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 16px; --i: 3"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 4"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 14px; --i: 5"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 6"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 7"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 8"></div>
                    <div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 9"></div>
                </div>
                <span class="duration-text text-white/90 text-xs font-medium flex-shrink-0" style="font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;">0:00</span>
                <audio src="${url}" preload="auto" class="hidden"></audio>
            </div>
        `;
        chatMessagesContainer.appendChild(bubble);
        
        // Get the audio element and duration text element
        const audio = bubble.querySelector('audio');
        const durationText = bubble.querySelector('.duration-text');
        
        // Wait for audio metadata to load, then display actual duration
        audio.addEventListener('loadedmetadata', () => {
            const duration = Math.ceil(audio.duration);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            durationText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });
        
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        setTimeout(() => addShAIMessage("Got your voice message! I'm on it — let me find the best options for you."), 800);
    }
}
    window.toggleVoicePlayback = function(button, audioUrl) {
        const container = button.closest('.voice-message-bubble');
        const audio = container.querySelector('audio');
        const playIcon = button.querySelector('svg');
        const waveBars = container.querySelectorAll('.wave-bar');
        const durationText = container.querySelector('.duration-text');
        
        if (audio.paused) {
            audio.play();
            playIcon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
            
            waveBars.forEach((bar, index) => {
                bar.style.animation = `wavePulse 1.1s ease-in-out infinite`;
                bar.style.animationDelay = `${index * 0.08}s`;
            });
            
            audio.addEventListener('timeupdate', () => {
                const remaining = Math.ceil(audio.duration - audio.currentTime);
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                durationText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });
            
            audio.addEventListener('ended', () => {
    playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
    waveBars.forEach(bar => {
        bar.style.animation = 'none';
    });
    // Reset to actual duration instead of hardcoded value
    const duration = Math.ceil(audio.duration);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    durationText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
});
            
        } else {
            audio.pause();
            playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            waveBars.forEach(bar => {
                bar.style.animation = 'none';
            });
        }
    };

    function addShAIMessage(message, thumbUrls) {
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessagesContainer) {
            const avatarUrl = window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
            const thumbHtml = (thumbUrls && thumbUrls.length) ? '<div class="flex gap-1.5 mt-2 flex-wrap">' + thumbUrls.slice(0, 4).map(function(t) { return '<img class="w-12 h-12 rounded-lg object-cover border border-gray-200" src="' + (t || '').replace(/"/g, '&quot;') + '" alt="">'; }).join('') + '</div>' : '';
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex items-start space-x-3 mb-4';
            aiMessage.innerHTML = `
                <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                    <img class="w-full h-full object-cover" src="${avatarUrl.replace(/"/g, '&quot;')}" alt="ShAI avatar" data-shai-avatar />
                </div>
                <div class="flex-1">
                    <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3">
                        <p class="text-sm text-black">${(message || '').replace(/</g, '&lt;')}</p>
                        ${thumbHtml}
                    </div>
                </div>
            `;
            chatMessagesContainer.appendChild(aiMessage);
            if (chatMessages) requestAnimationFrame(function() { requestAnimationFrame(function() { chatMessages.scrollTop = chatMessages.scrollHeight; }); });
        }
    }

    window.openRecentChat = function(chatId) {
        if (!isDrawerExpanded) {
            expandDrawer();
        }
        
        setTimeout(() => {
            const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
            if (chatMessagesContainer) {
                const messages = chatMessagesContainer.querySelectorAll('.flex:not(:first-child)');
                messages.forEach(msg => msg.remove());
                
                if (chatId === 'power-blazer-chat') {
                    addProductBubbleToChat('Theory Power Blazer', '$295', 'https://storage.googleapis.com/uxpilot-auth.appspot.com/a07f271826-cee3c765a05f3b2170c5.png');
                    setTimeout(() => {
                        addShAIMessage("I see you're interested in the Theory Power Blazer. What size are you usually?");
                    }, 500);
                    setTimeout(() => {
                        addUserMessage("I'm usually a medium, but I'm not sure about the fit");
                    }, 1000);
                    setTimeout(() => {
                        addShAIMessage("The Theory Power Blazer runs slightly large. I'd recommend a Small for you. It has a structured fit that's perfect for professional settings.");
                    }, 1500);
                } else if (chatId === 'midi-dress-chat') {
                    addProductBubbleToChat('Reformation Midi Dress', '$178', 'https://storage.googleapis.com/uxpilot-auth.appspot.com/ed54ed626a-c0cdcdbb57dc6381c4fd.png');
                    setTimeout(() => {
                        addShAIMessage("This Reformation Midi Dress is gorgeous! Are you looking for it in a different color?");
                    }, 500);
                    setTimeout(() => {
                        addUserMessage("Yes, do you have it in black or navy?");
                    }, 1000);
                    setTimeout(() => {
                        addShAIMessage("I found similar styles in both black and navy! Let me show you some options that have the same silhouette.");
                    }, 1500);
                } else if (chatId === 'chain-necklace-chat') {
                    addProductBubbleToChat('Mejuri Chain Necklace', '$128', 'https://storage.googleapis.com/uxpilot-auth.appspot.com/27896e6e43-779d8991cbb35505b4d8.png');
                    setTimeout(() => {
                        addShAIMessage("This Mejuri chain necklace is a great choice! Are you looking to layer it or wear it alone?");
                    }, 500);
                    setTimeout(() => {
                        addUserMessage("I want to layer it. What would go well with it?");
                    }, 1000);
                    setTimeout(() => {
                        addShAIMessage("For layering, I'd recommend a shorter delicate chain and maybe a longer pendant necklace. The gold tone will work beautifully together!");
                    }, 1500);
                }
            }
        }, 300);
    };

    function addUserMessage(message) {
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        if (chatMessagesContainer) {
            const userMessage = document.createElement('div');
            userMessage.className = 'flex justify-end mb-4';
            userMessage.innerHTML = `
                <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
                    <p class="text-sm break-words whitespace-pre-wrap">${message}</p>
                </div>
            `;
            chatMessagesContainer.appendChild(userMessage);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    }

    if (heroInviteBtn) {
        heroInviteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Hero Invite: open native app picker (share sheet) directly, not Add Friend flow
            const shareData = {
                title: 'Join me on GoShopMe',
                text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless — join me",
                url: 'https://app.goshopme.ai'
            };
            if (navigator.share) {
                navigator.share(shareData).catch(err => console.error('Share failed:', err));
            } else {
                const msg = `${shareData.text} ${shareData.url}`;
                navigator.clipboard.writeText(msg).then(() => {
                    if (typeof showToast === 'function') showToast('Invite link copied!');
                    else alert('Invite link copied to clipboard!');
                });
            }
        });
    }

    smartPrompts.forEach(button => {
        button.addEventListener('click', function() {
            const promptText = this.textContent;
            const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
            if (chatMessagesContainer) {
                const userMessage = document.createElement('div');
                userMessage.className = 'flex justify-end mb-4';
                userMessage.innerHTML = `
                    <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
                        <p class="text-sm">${promptText}</p>
                    </div>
                `;
                chatMessagesContainer.appendChild(userMessage);
                
                setTimeout(() => {
                    const avatarUrl = window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
                    const aiResponse = document.createElement('div');
                    aiResponse.className = 'flex items-start space-x-3 mb-4';
                    aiResponse.innerHTML = `
                        <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img class="w-full h-full object-cover" src="${avatarUrl.replace(/"/g, '&quot;')}" alt="ShAI avatar" data-shai-avatar />
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3">
                                <p class="text-sm text-black">I'd be happy to help you with that! Let me find some perfect options for you.</p>
                            </div>
                        </div>
                    `;
                    chatMessagesContainer.appendChild(aiResponse);
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }, 1000);
                
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
        });
    });

    if (contactSearch) {
        contactSearch.addEventListener('input', function() {
            filterContacts(this.value);
        });
    }

    if (backBtn) {
        backBtn.addEventListener('click', function() {
            hideAddFriendFlow();
        });
    }

    if (addFriendBtn) {
        addFriendBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!isDrawerExpanded) {
                expandDrawer();
                setTimeout(() => {
                    showAddFriendFlow();
                }, 300);
            } else {
                showAddFriendFlow();
            }
        });
    }

    if (addFriendBtnDrawer) {
        addFriendBtnDrawer.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showAddFriendFlow();
        });
    }

    if (chatInput) {
        chatInput.addEventListener('focus', function() {
            if (!isDrawerExpanded) {
                expandDrawer();
                setTimeout(() => {
                    if (chatInputDrawer) chatInputDrawer.focus();
                }, 300);
            }
        });
    }

    function showAddFriendFlow() {
        isAddFriendMode = true;
        chatContent.classList.add('hidden');
        addFriendContent.classList.remove('hidden');
        backBtn.classList.remove('hidden');
        
        headerTitle.textContent = 'Add Friend';
        headerSubtitle.textContent = 'Choose contacts to add';
    }

    function hideAddFriendFlow() {
        isAddFriendMode = false;
        chatContent.classList.remove('hidden');
        addFriendContent.classList.add('hidden');
        backBtn.classList.add('hidden');
        
        headerTitle.textContent = 'ShAI';
        headerSubtitle.textContent = 'Your shopping assistant';
        
        if (contactSearch) {
            contactSearch.value = '';
            filterContacts('');
        }
    }

    function filterContacts(searchTerm) {
        const contactItems = contactsContainer.querySelectorAll('.contact-item');
        const term = searchTerm.toLowerCase();
        
        contactItems.forEach(item => {
            const name = item.getAttribute('data-name').toLowerCase();
            const phone = item.getAttribute('data-phone').toLowerCase();
            
            if (name.includes(term) || phone.includes(term)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    if (chatOverlay) {
        chatOverlay.addEventListener('click', function() {
            collapseDrawer();
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('contact-action')) {
            const contactItem = e.target.closest('.contact-item');
            const contactName = contactItem.querySelector('p').textContent;
            const isGoshopmeUser = contactItem.getAttribute('data-goshopme') === 'true';
            
            if (e.target.textContent === 'Add' && isGoshopmeUser) {
                const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
                if (chatMessagesContainer) {
                    const notification = document.createElement('div');
                    notification.className = 'flex justify-center mb-4';
                    notification.innerHTML = `
                        <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">
                            ${contactName.split(' ')[0]} has been added to chat
                        </div>
                    `;
                    chatMessagesContainer.appendChild(notification);
                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                }
                hideAddFriendFlow();
            } else if (e.target.textContent === 'Invite') {
                const shareData = {
                    title: 'Join me on GoShopMe',
                    text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless — join me",
                    url: 'https://app.goshopme.ai'
                };
                
                if (navigator.share) {
                    navigator.share(shareData).catch(err => {
                        const shareText = shareData.text + ' ' + shareData.url;
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(shareText);
                            alert('Invitation link copied to clipboard!');
                        }
                    });
                }
            }
        }
    });

    window.toggleWishlist = function(button, productId) {
        const heartIcon = button.querySelector('svg');
        
        if (wishlistItems.has(productId)) {
            wishlistItems.delete(productId);
            heartIcon.classList.remove('heart-filled');
            heartIcon.setAttribute('fill', 'none');
        } else {
            wishlistItems.add(productId);
            heartIcon.classList.add('heart-filled');
            heartIcon.setAttribute('fill', '#939BFB');
        }
    };
    
    window.shareProduct = function(productName, price, productUrl = null, productId = null, brand = null) {
        const base = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        const id = productId || (productName || '').toLowerCase().replace(/\s+/g, '-');
        const shareUrl = productUrl || (base + 'Product_details_page.html?id=' + encodeURIComponent(id) + (productName ? '&name=' + encodeURIComponent(productName) : '') + (brand ? '&brand=' + encodeURIComponent(brand) : ''));
        const shareData = {
            title: `${productName || 'Product'}${brand ? ' by ' + brand : ''}`,
            text: `Check out this ${productName || 'item'}${price ? ' for ' + price : ''} on GoShopMe`,
            url: shareUrl
        };
        
        if (navigator.share) {
            navigator.share(shareData)
                .then(() => console.log('Share successful'))
                .catch(err => {
                    const shareText = `${shareData.text} - ${shareData.url}`;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(shareText)
                            .then(() => showToast('Link copied to clipboard!'))
                            .catch(() => console.log('Clipboard access denied'));
                    }
                });
        } else {
            const shareText = `${shareData.text} - ${shareData.url}`;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText)
                    .then(() => showToast('Link copied to clipboard!'))
                    .catch(() => console.log('Clipboard access denied'));
            }
        }
    };
    
    window.openProductDetail = function(productId, productName, productBrand, productImage, productPrice) {
        var navData = null;
        if (window.__productCache && productId && window.__productCache[productId]) {
            var p = window.__productCache[productId];
            navData = { id: p.id, name: p.name, brand: p.brand, image: p.image, price: p.price };
        }
        if (!navData) {
            navData = { id: productId, name: productName, brand: productBrand, image: productImage || '', price: productPrice || '' };
        }
        if (navData) try { sessionStorage.setItem('__productNavData', JSON.stringify(navData)); } catch (e) {}
        var q = 'id=' + encodeURIComponent(productId || '') + '&from=home';
        if (productName) q += '&name=' + encodeURIComponent(productName);
        if (productBrand) q += '&brand=' + encodeURIComponent(productBrand);
        var img = (navData && navData.image) || productImage;
        var prc = (navData && navData.price) || productPrice;
        if (img) q += '&image=' + encodeURIComponent(img);
        if (prc) q += '&price=' + encodeURIComponent(prc);
        window.location.href = 'Product_details_page.html?' + q;
    };
    
    window.openProductChat = function(productName, price, imageUrl) {
        if (!isDrawerExpanded) {
            expandDrawer();
        }
        
        setTimeout(() => {
            addShAIMessage(`Tell me more about the "${productName}" - would you like styling suggestions or alternatives?`, imageUrl ? [imageUrl] : []);
        }, 300);
    };
    
    window.openCollectionDetail = function(collectionId) {
        console.log('Opening collection detail for:', collectionId);
    };
    
    window.shareCollection = function(name) {
        const base = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        const shareUrl = base + "Creator`s Single_Collection.html?collection=" + encodeURIComponent(name || '');
        const shareData = { title: (name || '') + ' - GoShopMe', text: 'Check out this collection on GoShopMe', url: shareUrl };
        if (navigator.share) navigator.share(shareData).catch(() => { if (navigator.clipboard) navigator.clipboard.writeText(shareData.text + ' ' + shareData.url); });
        else if (navigator.clipboard) navigator.clipboard.writeText(shareData.text + ' ' + shareData.url);
    };
    
    function addProductBubbleToChat(productName, price, imageUrl) {
        const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
        if (chatMessagesContainer) {
            const productId = (productName || '').toLowerCase().replace(/\s+/g, '-');
            const bubbleClick = function(e) {
                if (e.target.closest('button')) return;
                window.location.href = 'Product_details_page.html?id=' + encodeURIComponent(productId) + '&name=' + encodeURIComponent(productName || '') + '&from=home';
            };
            const productBubble = document.createElement('div');
            productBubble.className = 'flex justify-end mb-4';
            productBubble.innerHTML = `
                <div class="product-bubble outgoing cursor-pointer hover:shadow-md transition-shadow" role="button" tabindex="0">
                    <div class="relative">
                        <img src="${imageUrl}" alt="${productName}" class="w-full h-32 object-cover rounded-lg mb-2">
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button type="button" onclick="event.stopPropagation(); toggleWishlist(this, '${productName.toLowerCase().replace(/\s+/g, '-')}')" class="bg-white/80 rounded-full p-1">
                                <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
                                </svg>
                            </button>
                            <button type="button" onclick="event.stopPropagation(); shareProduct('${productName}', '${price}')" class="bg-white/80 rounded-full p-1">
                                <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Brand</p>
                        <p class="text-sm font-medium text-black">${productName}</p>
                        <p class="text-sm font-bold text-black">${price}</p>
                    </div>
                </div>
            `;
            chatMessagesContainer.appendChild(productBubble);
            const bubbleEl = productBubble.querySelector('.product-bubble');
            if (bubbleEl) bubbleEl.addEventListener('click', bubbleClick);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-50';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    setupCameraButton();
    setupVoiceRecording();
});
</script>
<div class="hidden"></div>

<script>
async function loadCreatorCollections(collections) {
    const container = document.getElementById("creator-list");
    const template = document.getElementById("creator-card-template");
    if (!container || !template) return;

    const list = Array.isArray(collections) ? collections : [];
    container.innerHTML = '';
    container.appendChild(template);

    list.forEach(col => {
        const clone = template.content.cloneNode(true);

        // COVER HANDLING
        const cover = clone.querySelector(".creator-cover");
        const showTopPosition = col.id === "bold-bright";
        const posClass = showTopPosition ? " object-top" : "";
        if (col.coverType === "video") {
            cover.innerHTML = `<video src="${col.coverUrl}" class="w-full h-full object-cover${posClass}" autoplay muted loop playsinline ></video>`;
        } else {
            cover.innerHTML = `<img src="${col.coverUrl}" class="w-full h-full object-cover${posClass}"/>`;
        }

        // AVATAR: show image if URL exists, else show initials
        const avatarImg = clone.querySelector(".creator-avatar");
        const avatarInitials = clone.querySelector(".creator-initials");
        if (col.creatorAvatarUrl) {
            avatarImg.src = col.creatorAvatarUrl;
            avatarImg.classList.remove("hidden");
            avatarInitials.classList.add("hidden");
        } else {
            // Generate initials from creator name (e.g., "Emma Style" → "ES")
            const nameParts = (col.creatorName || "").trim().split(/\s+/);
            const initials = nameParts.map(p => p.charAt(0).toUpperCase()).slice(0, 2).join("");
            avatarInitials.textContent = initials || "?";
            avatarInitials.classList.remove("hidden");
            avatarImg.classList.add("hidden");
        }

        // TEXT FIELDS
        clone.querySelector(".creator-title").textContent = col.title;
        clone.querySelector(".creator-name").textContent = `by ${col.creatorName}`;

        // CLICK → open collection detail
        clone.querySelector(".creator-card").onclick = () => openCollectionDetail(col.id);

        // WISHLIST BUTTON
        clone.querySelector(".wishlist-btn").onclick = (e) => {
            e.stopPropagation();
            toggleWishlist(e.currentTarget, col.wishlistId);
        };

        // SHARE BUTTON – collection link (dynamic)
        clone.querySelector(".share-btn").onclick = (e) => {
            e.stopPropagation();
            shareCollection(col.title);
        };

        container.appendChild(clone);
    });
}

</script>
<script>
/* -------------------------------------------------------
   UNIVERSAL HERO LOADER — LOCAL + REPLIT + PRODUCTION SAFE
------------------------------------------------------- */
let heroInitialized = false;
let heroOverridden = false;

/* -------------------------------------------------------
   RENDER HERO TO DOM
------------------------------------------------------- */
function renderHero(hero) {
    const bg = document.getElementById("hero-bg");
    const titleEl = document.getElementById("hero-title");
    const subtitleEl = document.getElementById("hero-subtitle");

    if (!bg) return;

    // Reset background content
    bg.innerHTML = "";

    // Render image or video
    if (hero.coverType === "video") {
        bg.innerHTML = `
            <video
                src="${hero.coverUrl}"
                class="absolute inset-0 w-full h-full object-cover object-center"
                autoplay
                muted
                loop
                playsinline
                preload="auto"
                style="min-width:100%;min-height:100%;">
            </video>
        `;
    } else {
        bg.innerHTML = `
            <img 
                src="${hero.coverUrl}" 
                class="w-full h-full object-cover">
        `;
    }

    // Text
    if (titleEl)   titleEl.textContent   = hero.title    || "";
    if (subtitleEl) subtitleEl.textContent = hero.subtitle || "";

    console.log("HERO LOADED:", hero);
}

/* -------------------------------------------------------
   LOAD HERO CONTENT (fallback + optional DB)
------------------------------------------------------- */
async function loadHeroContent() {
    if (heroInitialized) return;
    heroInitialized = true;

    // 1) Fallback hero (local video from assets – fits hero section perfectly)
    const fallbackHero = {
        title: "Best finds must be shared",
        subtitle: "Add your friends and have fun together.",
        coverType: "video",
        coverUrl: "https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Home-hero%202_video.mp4"
    };

    let heroData = { ...fallbackHero };

    // 2) Local file:// → skip network
    const isLocal = window.location.protocol === "file:";
    if (isLocal) {
        console.log("HERO: Local mode → DB fetch skipped.");
        if (!heroOverridden) renderHero(heroData);
        return;
    }

    // 3) Remote: optional Replit KV fetch
    try {
        const REPLIT_KEY = window.REPLIT_DB_KEY || null;
        if (!REPLIT_KEY) {
            console.warn("HERO: No REPLIT_DB_KEY set → using fallback hero.");
            if (!heroOverridden) renderHero(heroData);
            return;
        }

        const url = `https://kv.replit.com/v0/${REPLIT_KEY}/hero`;
        const res = await fetch(url);

        if (res.ok) {
            const dbHero = await res.json();
            if (dbHero && typeof dbHero === "object") {
                heroData = { ...heroData, ...dbHero };
            }
        } else {
            console.warn("HERO: DB returned non-200 → using fallback hero.");
        }
    } catch (err) {
        console.warn("HERO: DB fetch failed → using fallback hero.");
    }

    if (!heroOverridden) {
        renderHero(heroData);
    }
}

document.addEventListener("DOMContentLoaded", loadHeroContent);

/* -------------------------------------------------------
   CONSOLE OVERRIDE HELPER
------------------------------------------------------- */
window.setHeroOverride = function (heroOverride) {
    heroOverridden = true;
    console.log("HERO OVERRIDE:", heroOverride);
    renderHero({
        title: heroOverride.title || "",
        subtitle: heroOverride.subtitle || "",
        coverType: heroOverride.coverType || "image",
        coverUrl: heroOverride.coverUrl || ""
    });
};
</script>
<script>
/* -------------------------------------------------------
   DYNAMIC RECENT ACTIVITY
------------------------------------------------------- */

window.renderRecentActivity = function (historyItems = []) {

    const container = document.getElementById("recent-activity-list");
    const fallback = document.getElementById("recent-activity-empty");

    if (!container) return;

    container.innerHTML = ""; 

    // EMPTY STATE
    if (!historyItems.length) {
        fallback.classList.remove("hidden");
        return;
    }

    fallback.classList.add("hidden");

    const lastThree = historyItems.slice(0, 3);

    lastThree.forEach(item => {

        const row = document.createElement("div");
        row.className =
            "recent-chat-item flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors";

        row.onclick = () => openRecentChat(item.chatId);

        row.innerHTML = `
            <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
            </div>

            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-black truncate">${item.title}</p>
                <p class="text-xs text-gray-500">${item.subtitle}</p>
            </div>

            <span class="text-xs text-gray-400 flex-shrink-0">${item.timeAgo}</span>
        `;

        container.appendChild(row);
    });
};

document.addEventListener("DOMContentLoaded", () => {
    var fallback = window.__HOME_FALLBACK_DATA || {};
    if (fallback.recentActivity && fallback.recentActivity.length) {
        window.renderRecentActivity(fallback.recentActivity);
    } else {
        window.renderRecentActivity([]);
    }
});
</script>
<script>
window.renderCategories = function (categories = []) {
  const grid = document.getElementById("category-grid");
  if (!grid) return;

  grid.innerHTML = "";

  if (!categories.length) return;

  categories.forEach(cat => {
    const el = document.createElement("a");
    el.href = "ShopbyCategory.html?category=" + encodeURIComponent(cat.id || "");
    el.className =
      "relative bg-gray-100 rounded-xl h-24 overflow-hidden flex flex-col justify-end p-2 text-left";
    const shoesPos = cat.id === "shoes" ? " object-[center_75%]" : "";
    const workwearPos = cat.id === "workwear" ? " object-top" : "";
    el.innerHTML = `
      <img src="${cat.image}" alt="${cat.name}"
           class="absolute inset-0 w-full h-full object-cover${shoesPos}${workwearPos}" />
      <div class="absolute inset-0 bg-black/20"></div>
      <span class="relative text-white font-medium text-sm">${cat.name}</span>
    `;
    grid.appendChild(el);
  });
};
</script>
</div> <!-- end #app-shell -->

</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <title>Manage Subscription - GoShopMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/global-components.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shine-primary': '#939BFB',
                        'shine-accent': '#F96226'
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                        'dm-sans': ['DM Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/header-icons-badges.js"></script>
    <script src="js/back-button.js"></script>
    <script src="js/subscription-api.js"></script>
    <style>
        ::-webkit-scrollbar { display: none; }
        * { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .dm-sans { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .poppins { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #cart-indicator, #notif-indicator { min-width: 18px; min-height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
        .input-error { border-color: #EF4444 !important; }
        .input-error:focus { --tw-ring-color: #EF4444 !important; }
        input[name="cancel-reason"] {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            min-width: 18px;
            border: 2px solid #939BFB;
            border-radius: 50%;
            background: white;
            outline: none;
            cursor: pointer;
        }
        input[name="cancel-reason"]:checked {
            background: radial-gradient(circle, #939BFB 35%, white 40%);
        }
        input[name="cancel-reason"]:focus { outline: none; }
    </style>
</head>
<body class="bg-[#F6F6F6] dm-sans overflow-x-hidden">
    <img id="pdf-logo-preload" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe/main/html_designs/GoShopMe%20logo.svg" alt="" style="position:absolute;left:-9999px;width:375px;height:55px" aria-hidden="true">
    <div id="app-shell" class="relative w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl overflow-x-hidden">
        <!-- Header (design system Section 5) -->
        <header class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white z-50 border-b border-gray-100">
            <div class="p-4">
                <div class="relative flex items-center justify-between">
                    <a href="#" class="goshopme-back-btn header-icon-btn w-10 h-10 flex items-center justify-center p-2 text-gray-600 hover:text-gray-800 flex-shrink-0" data-fallback="User_Profile_Paid_Plan.html" aria-label="Back">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
                        </svg>
                    </a>
                    <h1 class="absolute left-1/2 -translate-x-1/2 text-lg font-semibold poppins text-gray-900 whitespace-nowrap">Manage Subscription</h1>
                    <div id="header-icons-slot" class="flex items-center gap-0 flex-shrink-0 min-w-10"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pt-20 px-4 pb-40 bg-white min-h-screen">
            <!-- Subscription Header -->
            <section class="px-5 py-6 mb-2">
                <h2 class="text-lg font-semibold poppins text-gray-900 mb-2">Your Subscription Details</h2>
                <p class="text-gray-600 text-sm">Easily manage your GoShopMe subscription, payment history, and plan preferences here.</p>
            </section>

            <!-- Current Plan (dynamic from database) -->
            <section class="px-5 py-6 mb-2">
                <h3 class="text-base font-semibold poppins mb-4 text-gray-900">Current Plan</h3>
                <div id="current-plan-card" class="bg-gradient-to-r from-shine-primary to-shine-accent rounded-2xl p-5 text-white mb-4 shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 id="plan-name" class="poppins font-semibold text-lg">Premium Plan</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span id="plan-status-badge" class="bg-green-500 text-xs px-2 py-1 rounded-full">Active</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span id="plan-price" class="text-2xl font-bold">$19.99</span>
                            <p id="plan-interval" class="text-xs opacity-90">/month</p>
                        </div>
                    </div>
                    <div class="space-y-1 text-sm opacity-90" id="plan-details">
                        <p>Next Billing: <span id="billing-date">August 15, 2025</span></p>
                        <p>Billed via <span id="payment-method">Visa ending in 4242</span></p>
                    </div>
                </div>
                <div class="text-center">
                    <button id="switch-plan-btn" class="text-shine-primary underline poppins cursor-pointer text-sm hover:opacity-80 transition-opacity">
                        Change Plan
                    </button>
                </div>
            </section>

            <!-- Billing History (dynamic from database) -->
            <section class="px-5 py-6 mb-2">
                <h3 class="text-base font-semibold poppins mb-4 text-gray-900">Billing History</h3>
                <div id="billing-history-list" class="space-y-1">
                    <!-- Populated dynamically from subscription API -->
                </div>
                <a id="load-more-btn" href="#" class="w-full py-4 text-shine-primary poppins font-medium hover:opacity-80 transition-opacity text-center block hidden" role="button">
                    Load More History
                </a>
            </section>

            <!-- Reassurance -->
            <section class="px-5 py-4">
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                    <p class="text-sm text-gray-700 text-center">
                        Cancel anytime â€” your plan will remain active until the end of the billing period.
                    </p>
                </div>
            </section>
        </main>

        <!-- Change Plan Modal (width matches main screen max-w-[390px]) -->
        <div id="cancel-modal" class="fixed inset-0 bg-black/40 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="w-full max-w-[390px] bg-white rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <!-- Step 1: Confirmation -->
                    <div id="cancel-step-1">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-semibold poppins text-gray-900 mb-2">Are You Sure You Want to Cancel?</h3>
                            <p class="text-gray-600 text-xs">You'll lose access to Premium benefits like unlimited AI searches, full returns automation, and early access to collections.</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 mb-4">
                            <h4 class="poppins font-semibold mb-2 text-gray-900 text-sm">You'll lose access to:</h4>
                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-shine-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 119 0v3.75M3.75 21.75h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/>
                                    </svg>
                                    <span class="text-xs text-gray-700">Unlimited AI Shopping</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-shine-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-xs text-gray-700">Full Return Automation</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-shine-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"/>
                                    </svg>
                                    <span class="text-xs text-gray-700">AI Order Tracking</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-shine-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
                                    </svg>
                                    <span class="text-xs text-gray-700">Discount Alerts + Limited Drops</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2">
                            <button id="continue-cancel-btn" class="w-full max-w-[220px] py-2 px-4 bg-shine-accent text-white rounded-full poppins font-medium text-xs hover:opacity-90 transition-opacity">
                                Continue to Free Plan
                            </button>
                            <button id="keep-subscription-btn" class="w-full max-w-[220px] py-2 px-4 bg-shine-primary text-white rounded-full poppins font-medium text-xs hover:opacity-90 transition-opacity">
                                Keep My Subscription
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Reason Selection -->
                    <div id="cancel-step-2" class="hidden">
                        <div class="text-center mb-4">
                            <h3 class="text-lg font-semibold poppins text-gray-900 mb-2">What's Your Main Reason for Cancelling?</h3>
                        </div>
                        <div class="space-y-2 mb-4">
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="ai-features" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">I don't use the AI features enough</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="short-term" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">I only needed it for a short time</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="price" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">The price feels too high</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="technical" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">I had technical issues</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="switching" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">I'm switching to another service</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="cancel-reason" value="other" class="mr-3 accent-shine-primary">
                                <span class="text-xs text-gray-700">Other</span>
                            </label>
                        </div>
                        <div id="other-reason" class="mb-4 hidden">
                            <textarea id="other-reason-text" placeholder="Please tell us more..." rows="2" class="w-full p-3 border border-gray-200 rounded-xl text-xs focus:outline-none focus:border-shine-primary focus:ring-1 focus:ring-shine-primary"></textarea>
                            <p id="other-reason-error" class="text-red-500 text-xs mt-1 hidden">Please provide more details.</p>
                        </div>
                        <p id="cancel-reason-error" class="text-shine-accent text-xs mb-3 hidden text-center">Please select a reason before continuing.</p>
                        <div class="flex flex-col items-center gap-2">
                            <button id="submit-cancel-btn" class="w-full max-w-[220px] py-2 px-4 bg-shine-accent text-white rounded-full poppins font-medium text-xs hover:opacity-90 transition-opacity">
                                Submit
                            </button>
                            <button id="go-back-btn" class="w-full max-w-[220px] py-2 px-4 bg-gray-200 text-gray-700 rounded-full poppins font-medium text-xs hover:bg-gray-300 transition-colors">
                                Go Back
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav id="bottom-navigation" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 z-50">
            <div class="flex items-center justify-around py-2">
                <a href="Home.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-[#939BFB]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
                    <span class="text-xs">Home</span>
                </a>
                <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-[#939BFB]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/></svg>
                    <span class="text-xs">Picks</span>
                </a>
                <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-[#939BFB]">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg>
                    <span class="text-xs">Wishlist</span>
                </a>
                <a id="subscription-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-[#939BFB]">
                    <span id="profile-nav-icon" class="flex items-center justify-center w-6 h-6 mb-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg></span>
                    <img id="profile-nav-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
                    <span class="text-xs">Profile</span>
                </a>
            </div>
        </nav>

        <!-- Success Notification (design system: green for success) -->
        <div class="fixed top-20 left-0 right-0 z-[60] flex justify-center px-5 pointer-events-none">
            <div id="subscription-cancel-success" class="w-full max-w-[358px] bg-green-500 text-white p-4 rounded-xl shadow-lg hidden transform transition-all duration-300">
                <div class="flex items-center gap-3">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" class="w-6 h-6 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold poppins">Subscription Cancelled Successfully!</p>
                        <p class="text-sm opacity-90 mt-0.5">Your plan will remain active until the end of your billing period.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // Load subscription data from database (or window.__subscriptionData for dev)
        function renderSubscription(data) {
            if (!data || !data.subscription) return;
            var sub = data.subscription;
            var planName = document.getElementById('plan-name');
            var planStatus = document.getElementById('plan-status-badge');
            var planPrice = document.getElementById('plan-price');
            var planInterval = document.getElementById('plan-interval');
            var billingDate = document.getElementById('billing-date');
            var paymentMethod = document.getElementById('payment-method');
            var planDetails = document.getElementById('plan-details');
            var planCard = document.getElementById('current-plan-card');

            if (planName) planName.textContent = sub.planName || 'Premium Plan';
            if (planPrice) planPrice.textContent = sub.price || '$19.99';
            if (planInterval) planInterval.textContent = sub.interval || '/month';

            var status = (sub.status || 'active').toLowerCase();
            if (planStatus) {
                planStatus.textContent = status === 'active' ? 'Active' : status === 'trial' ? 'Trial' : status === 'cancelled' ? 'Cancelled' : status;
                planStatus.className = 'text-xs px-2 py-1 rounded-full ' + (status === 'active' ? 'bg-green-500' : status === 'trial' ? 'bg-blue-500' : 'bg-gray-400');
            }

            if (sub.plan === 'free' || status === 'cancelled') {
                if (planDetails) planDetails.classList.add('hidden');
                if (planCard) planCard.classList.remove('from-shine-primary', 'to-shine-accent');
                if (planCard) planCard.classList.add('bg-gray-100', 'text-gray-800');
            } else {
                if (billingDate) billingDate.textContent = sub.nextBillingDate || 'â€”';
                if (paymentMethod) paymentMethod.textContent = sub.paymentMethod || 'â€”';
            }
        }

        function renderPaymentItem(p) {
            var statusClass = (p.status || 'paid').toLowerCase() === 'paid' ? 'text-green-600' : 'text-gray-500';
            var dataAttrs = ' data-payment-id="' + (p.id || '') + '" data-date="' + (p.date || '') + '" data-plan-name="' + (p.planName || '') + '" data-amount="' + (p.amount || '') + '" data-status="' + (p.status || 'Paid') + '"';
            return '<div class="flex justify-between items-center py-4 border-b border-gray-100">' +
                '<div><p class="font-medium text-gray-900">' + (p.date || '') + '</p><p class="text-sm text-gray-600">' + (p.planName || '') + '</p></div>' +
                '<div class="text-right"><p class="font-semibold text-gray-900">' + (p.amount || '') + '</p>' +
                '<div class="flex items-center gap-2 justify-end items-center">' +
                '<span class="text-xs ' + statusClass + '">' + (p.status || 'Paid') + '</span>' +
                '<button type="button" class="download-receipt-btn inline-flex items-center gap-1 text-shine-primary text-xs hover:opacity-80 transition-opacity cursor-pointer bg-transparent border-none" aria-label="Download receipt"' + dataAttrs + '>' +
                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg> Download</button>' +
                '</div></div></div>';
        }

        function renderBillingHistory(payments) {
            var list = document.getElementById('billing-history-list');
            var loadMore = document.getElementById('load-more-btn');
            if (!list) return;
            list.innerHTML = (payments || []).map(renderPaymentItem).join('');
        }

        var subscriptionData = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof GoShopMeSubscriptionAPI !== 'undefined') {
                GoShopMeSubscriptionAPI.fetchSubscriptionData().then(function(data) {
                    subscriptionData = data;
                    renderSubscription(data);
                    renderBillingHistory(data.payments || []);
                    var loadMore = document.getElementById('load-more-btn');
                    if (loadMore) loadMore.classList.toggle('hidden', !(data.hasMore));
                });
            }
        });

        document.addEventListener('click', function(e) {
            var btn = e.target.closest('.download-receipt-btn');
            if (!btn) return;
            e.preventDefault();
            var p = {
                id: btn.getAttribute('data-payment-id'),
                date: btn.getAttribute('data-date'),
                planName: btn.getAttribute('data-plan-name'),
                amount: btn.getAttribute('data-amount'),
                status: btn.getAttribute('data-status')
            };
            var sub = (subscriptionData && subscriptionData.subscription) ? subscriptionData.subscription : {};
            generateSubscriptionReceiptPDF(p, sub);
        });

        function loadLogoAsImage(callback) {
            var fallbackSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="375" height="55" viewBox="0 0 375 55"><text x="187" y="38" font-family="Arial,sans-serif" font-size="28" font-weight="bold" fill="#939bfb" text-anchor="middle">GoShopMe</text></svg>';
            var preload = document.getElementById('pdf-logo-preload');
            function tryCanvas(img, cb) {
                try {
                    if (!img || !img.complete || img.naturalWidth === 0) { cb(null); return; }
                    var canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth || 375;
                    canvas.height = img.naturalHeight || 55;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    cb(canvas.toDataURL('image/png'));
                } catch (e) { cb(null); }
            }
            function useFallbackSvg() {
                var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(fallbackSvg);
                var img = new Image();
                img.onload = function() { tryCanvas(img, callback); };
                img.onerror = function() { callback(null); };
                img.src = dataUrl;
            }
            if (preload && preload.complete && preload.naturalWidth > 0) {
                tryCanvas(preload, callback);
                return;
            }
            if (preload) {
                preload.onload = function() { tryCanvas(preload, callback); };
                preload.onerror = function() {
                    fetch('GoShopMe logo.svg').then(function(r) { return r.text(); }).then(function(svgText) {
                        var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
                        var img = new Image();
                        img.onload = function() { tryCanvas(img, callback); };
                        img.onerror = useFallbackSvg;
                        img.src = dataUrl;
                    }).catch(useFallbackSvg);
                };
                if (preload.complete) preload.onerror();
                return;
            }
            fetch('GoShopMe logo.svg').then(function(r) { return r.text(); }).then(function(svgText) {
                var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgText);
                var img = new Image();
                img.onload = function() { tryCanvas(img, callback); };
                img.onerror = useFallbackSvg;
                img.src = dataUrl;
            }).catch(useFallbackSvg);
        }

        function generateSubscriptionReceiptPDF(payment, subscription) {
            var JsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jspdf;
            if (!JsPDF) { alert('PDF library not loaded.'); return; }

            var pageW = 210;
            var centerX = pageW / 2;

            loadLogoAsImage(function(logoData) {
                var doc = new JsPDF({ unit: 'mm', format: 'a4' });
                var y = 25;

                if (logoData) {
                    var logoW = 50;
                    var logoH = logoW * (55 / 375);
                    doc.addImage(logoData, 'PNG', centerX - logoW / 2, y, logoW, logoH);
                    y += logoH + 12;
                } else {
                    doc.setFontSize(22);
                    doc.setTextColor(147, 155, 251);
                    doc.text('GoShopMe', centerX, y, { align: 'center' });
                    y += 10;
                }

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Your Personal Shopper', centerX, y, { align: 'center' });
                y += 12;

                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                var titleText = 'SUBSCRIPTION RECEIPT';
                doc.text(titleText, centerX, y, { align: 'center' });
                var contentLeft = centerX - (doc.getTextWidth(titleText) / 2);
                y += 14;

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Receipt: RCT-SUB-' + (payment.id || ''), contentLeft, y);
                y += 12;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text('Date: ' + (payment.date || 'â€”'), contentLeft, y);
                y += 8;
                doc.text('Plan: ' + (payment.planName || 'â€”'), contentLeft, y);
                y += 8;
                doc.text('Amount: ' + (payment.amount || 'â€”'), contentLeft, y);
                y += 8;
                doc.text('Status: ' + (payment.status || 'Paid'), contentLeft, y);
                y += 8;
                doc.text('Payment: ' + (subscription.paymentMethod || 'â€”'), contentLeft, y);
                y += 14;

                doc.setFontSize(9);
                doc.setTextColor(120, 120, 120);
                var now = new Date();
                doc.text('Generated: ' + now.toLocaleString(), contentLeft, y);
                y += 6;
                doc.text('Thank you for your subscription.', contentLeft, y);

                doc.save('GoShopMe-Subscription-Receipt-' + (payment.id || '') + '.pdf');
            });
        }

        var loadMoreBtn = document.getElementById('load-more-btn');
        var paymentOffset = 0;
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (typeof GoShopMeSubscriptionAPI !== 'undefined') {
                    var list = document.getElementById('billing-history-list');
                    paymentOffset = (list && list.children.length) || 0;
                    GoShopMeSubscriptionAPI.fetchMorePayments(paymentOffset).then(function(res) {
                        (res.payments || []).forEach(function(p) {
                            list.insertAdjacentHTML('beforeend', renderPaymentItem(p));
                        });
                        loadMoreBtn.classList.toggle('hidden', !res.hasMore);
                    });
                }
            });
        }

        // Modal elements
        var modal = document.getElementById('cancel-modal');
        var step1 = document.getElementById('cancel-step-1');
        var step2 = document.getElementById('cancel-step-2');
        var switchPlanBtn = document.getElementById('switch-plan-btn');
        var continueCancelBtn = document.getElementById('continue-cancel-btn');
        var keepSubscriptionBtn = document.getElementById('keep-subscription-btn');
        var submitCancelBtn = document.getElementById('submit-cancel-btn');
        var goBackBtn = document.getElementById('go-back-btn');
        var otherRadio = document.querySelector('input[value="other"]');
        var otherReason = document.getElementById('other-reason');

        // Open modal
        if (switchPlanBtn) {
            switchPlanBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
                step1.classList.remove('hidden');
                step2.classList.add('hidden');
            });
        }

        // Continue to step 2
        if (continueCancelBtn) {
            continueCancelBtn.addEventListener('click', function() {
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
            });
        }

        // Keep subscription (close modal)
        if (keepSubscriptionBtn) {
            keepSubscriptionBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
        }

        // Go back to step 1
        if (goBackBtn) {
            goBackBtn.addEventListener('click', function() {
                step2.classList.add('hidden');
                step1.classList.remove('hidden');
            });
        }

        // Submit cancellation
        var cancelReasonError = document.getElementById('cancel-reason-error');
        var otherReasonError = document.getElementById('other-reason-error');
        var otherReasonText = document.getElementById('other-reason-text');
        var successNotification = document.getElementById('subscription-cancel-success');
        if (submitCancelBtn) {
            submitCancelBtn.addEventListener('click', function() {
                var selected = document.querySelector('input[name="cancel-reason"]:checked');
                if (!selected) {
                    if (cancelReasonError) cancelReasonError.classList.remove('hidden');
                    if (otherReasonError) otherReasonError.classList.add('hidden');
                    return;
                }
                if (cancelReasonError) cancelReasonError.classList.add('hidden');
                if (selected.value === 'other') {
                    var text = (otherReasonText && otherReasonText.value) ? otherReasonText.value.trim() : '';
                    if (!text) {
                        if (otherReasonError) otherReasonError.classList.remove('hidden');
                        if (otherReasonText) otherReasonText.classList.add('input-error');
                        return;
                    }
                }
                if (otherReasonError) otherReasonError.classList.add('hidden');
                if (otherReasonText) otherReasonText.classList.remove('input-error');
                var reasonValue = selected.value;
                var otherText = (reasonValue === 'other' && otherReasonText) ? otherReasonText.value.trim() : '';
                modal.classList.add('hidden');
                if (typeof GoShopMeSubscriptionAPI !== 'undefined' && GoShopMeSubscriptionAPI.cancelSubscription) {
                    GoShopMeSubscriptionAPI.cancelSubscription(reasonValue, otherText);
                }
                if (successNotification) {
                    successNotification.classList.remove('hidden');
                    setTimeout(function() {
                        successNotification.classList.add('hidden');
                    }, 4000);
                }
            });
        }

        // Show/hide other reason textarea
        if (otherRadio) {
            otherRadio.addEventListener('change', function() {
                if (this.checked) {
                    otherReason.classList.remove('hidden');
                }
            });
        }

        // Hide other reason when different option selected; clear validation error on selection
        document.querySelectorAll('input[name="cancel-reason"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value !== 'other') {
                    otherReason.classList.add('hidden');
                    if (otherReasonError) otherReasonError.classList.add('hidden');
                    if (otherReasonText) otherReasonText.classList.remove('input-error');
                }
                if (cancelReasonError) cancelReasonError.classList.add('hidden');
            });
        });
        if (otherReasonText) {
            otherReasonText.addEventListener('input', function() {
                if (otherReasonError) otherReasonError.classList.add('hidden');
                this.classList.remove('input-error');
            });
        }

        // Close modal on backdrop click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        // Profile nav: link + photo (dynamic from localStorage)
        (function() {
            var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
            var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
            var link = document.getElementById('subscription-nav-profile-link');
            if (link) link.href = profileHref;
            var saved = null;
            try { saved = localStorage.getItem('profilePhoto'); } catch (err) {}
            var navPhoto = document.getElementById('profile-nav-photo');
            var navIcon = document.getElementById('profile-nav-icon');
            if (saved && navPhoto && navIcon) {
                navPhoto.src = saved;
                navPhoto.classList.remove('hidden');
                navIcon.classList.add('hidden');
            }
        })();
    })();
    </script>
</body>
</html>



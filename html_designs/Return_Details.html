<!DOCTYPE html>
<html>
  <head>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        // Dev mode (no backend): uncomment to test ShAI avatar from a URL
        // window.__shaiAvatarUrl = 'https://yourserver.com/shai.png';
      </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <title>Return Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fuhkwang:wght@400;600;700&family=Wix+Madefor+Display:wght@400;500;600&display=swap"
      rel="stylesheet">
    <link rel="stylesheet" href="css/chat-drawer-drag.css">
    <style>
      ::-webkit-scrollbar { display: none; }
      html, body { overflow-x: hidden; width: 100%; }
      .font-fuhkwang, .poppins { font-family: 'Poppins', 'Fuhkwang', -apple-system, sans-serif; }
      .font-madefor, .dm-sans { font-family: 'DM Sans', 'Karla', 'Wix Madefor Display', -apple-system, sans-serif; }
      .bottom-nav-btn { display: flex; flex-direction: column; align-items: center; color: #6B7280; transition: color 0.2s ease-in-out; min-width: 60px; }
      .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #939BFB; }
      .bottom-nav-btn:hover svg, .bottom-nav-btn:hover span, .bottom-nav-btn.active svg, .bottom-nav-btn.active span { color: #939BFB; }
      .bottom-nav-btn svg { width: 20px; height: 20px; stroke-width: 1.5; margin-bottom: 4px; }
      #cart-indicator, #notif-indicator { min-width: 18px; min-height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
      #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
      #cart-indicator.badge-numeric, #notif-indicator.badge-numeric { min-width: 18px; padding: 0 5px; }
      .icon-button svg { width: 18px; height: 18px; stroke-width: 1.5; }
      .icon-button:hover svg { color: #939BFB; }
      .voice-message-bubble { min-width: 140px; max-width: 260px; width: fit-content; display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 16px; }
      @keyframes wavePulse { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
      .wave-bar.playing { animation: wavePulse 1.1s ease-in-out infinite; }
      #return-chat-drag-handle-area { touch-action: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; min-height: 48px; padding: 12px 0; -webkit-touch-callout: none; }
      #return-chat-drag-handle-area .drag-pill { pointer-events: none; }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-slide-in { animation: slideIn 0.3s ease-out; }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'shine-primary': '#939BFB',
              'shine-accent': '#F96226'
            }
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body class="bg-[#F6F6F6] min-h-screen font-madefor">
    <div class="w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl relative overflow-x-hidden flex flex-col">
    <!-- Header -->
    <div id="header" class="sticky top-0 w-full bg-white z-50 border-b border-gray-100 flex-shrink-0">
      <div class="px-4 py-3">
        <div class="relative flex items-center justify-between">
          <button onclick="goBack()" class="relative z-10 text-gray-600 hover:text-gray-900 transition-colors" aria-label="Back">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
            </svg>
          </button>
          <h1 class="absolute left-0 right-0 text-center text-lg font-semibold font-fuhkwang text-gray-900 pointer-events-none">Return Details</h1>
          <div class="relative z-10 flex items-center gap-0">
            <a href="Notifications_Screen.html?from=return-details" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Notifications">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"></path>
              </svg>
              <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-accent rounded-full hidden items-center justify-center flex"><span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
            <a href="Shopping_bag.html?from=return-details" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Shopping bag">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"></path>
              </svg>
              <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-primary rounded-full hidden items-center justify-center flex"><span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto pt-20 px-4 pb-40 animate-slide-in">
      <!-- Header Section -->
      <section id="header-section" class="py-4 bg-white mb-4">
        <h2 id="return-order-title" class="text-lg font-fuhkwang font-semibold text-gray-900 mb-2">
          Return Details for Order #S04545</h2>
        <p class="text-gray-600 font-madefor text-xs">Here's the current status
          and details of your return request.</p>
      </section>

      <!-- Return Summary Block -->
      <section id="return-summary" class="mb-4">
        <div class="bg-white rounded-lg p-4 border">
          <h3 class="font-fuhkwang font-semibold text-gray-900 mb-4">Return
            Summary</h3>
          <div id="return-summary-content" class="space-y-3">
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Return ID</span><span
                id="return-id" class="font-medium">#R20250715</span></div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Status</span><span
                id="return-status" class="inline-block px-3 py-1 text-xs bg-green-100 text-green-800 rounded-full font-medium">Completed</span>
            </div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Request Date</span><span
                id="return-request-date" class="font-medium">June 22, 2025</span></div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Return Method</span><span
                id="return-method" class="font-medium">Courier Pickup</span></div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Refund Method</span><span
                id="return-refund-method" class="font-medium">Original Payment</span></div>
          </div>
        </div>
      </section>

      <!-- Returned Items Block -->
      <section id="returned-items" class="mb-4">
        <div class="bg-white rounded-lg p-4 border">
          <h3 class="font-fuhkwang font-semibold text-gray-900 mb-4">Returned
            Items</h3>
          <div id="returned-items-list" class="space-y-4">
            <!-- Items populated dynamically -->
          </div>
        </div>
      </section>

      <!-- Return Timeline -->
      <section id="return-timeline" class="mb-4">
        <div class="bg-white rounded-lg p-4 border">
          <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleTimeline()">
            <h3 class="font-fuhkwang font-semibold text-gray-900">Return
              Timeline</h3><button id="timeline-arrow"
              class="text-gray-600 transition-transform duration-200" style="transform:rotate(-90deg)"><svg
                fill="none" stroke="currentColor" viewBox="0 0 24 24"
                stroke-width="1.5" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
              </svg></button>
          </div>
          <div id="timeline-content" class="space-y-6" style="display:none">
            <!-- Timeline populated dynamically -->
          </div>
        </div>
      </section>

      <!-- Refund Details Section -->
      <section id="refund-details" class="mb-4">
        <div class="bg-white rounded-lg p-4 border">
          <h3 class="font-fuhkwang font-semibold text-gray-900 mb-4">Refund
            Details</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Refund Amount</span><span
                id="refund-amount" class="font-semibold text-green-600 text-lg">$89.99</span></div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Refund Method</span><span
                id="refund-method" class="font-medium">Visa â€¢â€¢â€¢â€¢ 4242</span></div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Refund Status</span><span
                id="refund-status-badge" class="inline-block px-3 py-1 text-xs bg-green-100 text-green-800 rounded-full font-medium">Completed</span>
            </div>
            <div class="flex justify-between items-center"><span
                class="text-gray-600 font-madefor">Processing Date</span><span
                id="refund-processing-date" class="font-medium">June 28, 2025</span></div>
          </div>
          <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
            <div class="flex items-center gap-2 mb-2"><svg fill="none"
                stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"
                class="w-5 h-5 text-green-600">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                </path>
              </svg>
              <p class="text-sm font-medium text-green-800">Refund Processed
                Successfully!</p>
            </div>
            <p class="text-xs text-green-700">Your refund has been processed and
              should appear in your account within 3-5 business days.</p>
          </div>
        </div>
      </section>

      <!-- Support CTA Section -->
      <section id="support-cta" class="mb-4"></section>
    </main>

    <!-- Chat overlay â€“ tap to close drawer -->
    <div id="return-chat-overlay" class="fixed inset-0 bg-black/40 z-40 hidden" aria-hidden="true"></div>

    <!-- Chat drawer â€“ docked above bottom nav, height resizable via drag -->
    <div id="return-chat-drawer" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white rounded-t-3xl shadow-2xl z-50 flex flex-col border-t border-gray-100 transition-all duration-300 transform translate-y-full hidden" style="height: 50vh;">
      <div class="flex justify-center items-center flex-shrink-0 cursor-grab active:cursor-grabbing select-none" id="return-chat-drag-handle-area">
        <div class="drag-pill w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>
      <div class="flex items-center p-4 pb-2 flex-shrink-0">
        <button id="return-chat-back-btn" class="mr-3 hidden hover:opacity-70 transition-opacity">
          <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
        </button>
        <div class="w-8 h-8 rounded-full overflow-hidden mr-3 flex-shrink-0 bg-gray-100 flex items-center justify-center relative">
          <img class="return-shai-avatar w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI" data-shai-from-db onerror="this.style.display='none';var s=this.parentElement.querySelector('.return-shai-placeholder');if(s)s.classList.remove('hidden')">
          <span class="return-shai-placeholder absolute inset-0 flex items-center justify-center text-gray-400 text-xs font-medium bg-gray-100">AI</span>
        </div>
        <div class="flex-1">
          <p class="font-semibold text-black text-sm">ShAI</p>
          <p class="text-xs text-gray-500">Your shopping assistant</p>
        </div>
      </div>
      <div id="return-chat-content" class="flex-1 flex flex-col min-h-0">
        <div id="return-chat-messages" class="flex-1 overflow-y-auto min-h-0">
          <div class="p-4 pb-6">
            <div class="flex items-start space-x-3 mb-4">
              <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-100 flex items-center justify-center relative">
                <img class="return-shai-avatar w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI" data-shai-from-db onerror="this.style.display='none';var s=this.parentElement.querySelector('.return-shai-placeholder');if(s)s.classList.remove('hidden')">
                <span class="return-shai-placeholder absolute inset-0 flex items-center justify-center text-gray-400 text-xs font-medium bg-gray-100">AI</span>
              </div>
              <div class="flex-1">
                <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 mb-3 min-w-0">
                  <p class="text-sm text-black break-words whitespace-pre-wrap">Hi! I'm here to help with your return or anything else. How can I assist you today?</p>
                </div>
                <div class="flex flex-wrap gap-2 pb-2">
                  <button class="return-smart-prompt bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium hover:bg-[#939BFB] hover:text-white transition-colors">Return status help</button>
                  <button class="return-smart-prompt bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium hover:bg-[#939BFB] hover:text-white transition-colors">Find me an outfit</button>
                  <button class="return-smart-prompt bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium hover:bg-[#939BFB] hover:text-white transition-colors">What's trending?</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-white border-t border-gray-100 p-4 flex-shrink-0 min-w-0 overflow-hidden">
          <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
            <button id="return-cam-btn" class="icon-button hover:opacity-70 transition-opacity">
              <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg>
            </button>
            <textarea id="return-chat-input" placeholder="Message ShAI..." rows="1" class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px] max-h-[120px] py-1 text-sm resize-none overflow-y-auto" style="overflow-y: hidden;"></textarea>
            <button id="return-add-friend-btn" class="icon-button hover:opacity-70 transition-opacity">
              <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg>
            </button>
            <button id="return-mic-btn" class="icon-button hover:opacity-70 transition-opacity">
              <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg>
            </button>
            <button id="return-send-btn" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
              <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
            </button>
          </div>
        </div>
      </div>
      <div id="return-add-friend-content" class="flex-1 flex flex-col min-h-0 hidden">
        <div class="flex-1 overflow-y-auto p-4">
          <div class="mb-4">
            <div class="relative">
              <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
              <input type="text" id="return-contact-search" placeholder="Search contacts..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 pl-10 text-sm">
            </div>
          </div>
          <div id="return-contacts-container" class="space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- Chat input bar (collapsed state) â€“ tap to expand -->
    <div id="return-chat-input-bar" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 p-4 z-30 min-w-0 overflow-hidden">
      <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
        <button id="return-cam-btn-collapsed" class="icon-button hover:opacity-70 transition-opacity">
          <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg>
        </button>
        <input type="text" id="return-chat-input-collapsed" placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans min-h-[24px] text-sm cursor-pointer" readonly>
        <button id="return-add-friend-btn-collapsed" class="icon-button hover:opacity-70 transition-opacity">
          <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg>
        </button>
        <button id="return-mic-btn-collapsed" class="icon-button hover:opacity-70 transition-opacity">
          <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg>
        </button>
        <button id="return-send-btn-collapsed" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
          <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
        </button>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] border-t border-gray-100 bg-white px-4 py-3 z-50">
      <div class="flex items-center justify-around">
        <a href="Home.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"></path>
          </svg>
          <span class="text-xs mt-1">Home</span>
        </a>
        <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"></path>
          </svg>
          <span class="text-xs mt-1">Picks</span>
        </a>
        <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"></path>
          </svg>
          <span class="text-xs mt-1">Wishlist</span>
        </a>
        <a id="return-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
          <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-1.jpg" alt="Profile" class="w-6 h-6 rounded-full object-cover mb-1">
          <span class="text-xs mt-1">Profile</span>
        </a>
      </div>
    </nav>
    </div>

    <script>
(function(){var BADGE_KEYS={notif:'goshopme_notif_count',cart:'goshopme_cart_count'};var cartCountValue=0,notifCountValue=0;function getBadgeElements(){return{cartIndicator:document.getElementById('cart-indicator'),cartCount:document.getElementById('cart-count'),notifIndicator:document.getElementById('notif-indicator'),notifCount:document.getElementById('notif-count')};}function updateCartBadge(){var el=getBadgeElements();if(!el.cartIndicator||!el.cartCount)return;var show=cartCountValue>0;el.cartIndicator.classList.toggle('hidden',!show);el.cartIndicator.classList.toggle('flex',show);el.cartCount.textContent=show?(cartCountValue>99?'99+':cartCountValue):'';try{localStorage.setItem(BADGE_KEYS.cart,String(cartCountValue));localStorage.setItem('__cartCount',String(cartCountValue));}catch(e){}}function updateNotifBadge(){var el=getBadgeElements();if(!el.notifIndicator||!el.notifCount)return;var show=notifCountValue>0;el.notifIndicator.classList.toggle('hidden',!show);el.notifIndicator.classList.toggle('flex',show);el.notifCount.textContent=show?(notifCountValue>99?'99+':notifCountValue):'';try{localStorage.setItem(BADGE_KEYS.notif,String(notifCountValue));localStorage.setItem('notifCount',String(notifCountValue));}catch(e){}}window.updateCartBadge=updateCartBadge;window.updateNotifBadge=updateNotifBadge;window.testBadges=function(notif,cart){notifCountValue=Math.max(0,notif!=null?notif:5);cartCountValue=Math.max(0,cart!=null?cart:3);updateNotifBadge();updateCartBadge();};window.resetBadges=function(){cartCountValue=0;notifCountValue=0;try{localStorage.setItem(BADGE_KEYS.notif,'0');localStorage.setItem(BADGE_KEYS.cart,'0');localStorage.setItem('__cartCount','0');localStorage.setItem('notifCount','0');}catch(e){}updateCartBadge();updateNotifBadge();};document.addEventListener('DOMContentLoaded',function(){try{notifCountValue=parseInt(localStorage.getItem(BADGE_KEYS.notif)||localStorage.getItem('notifCount')||'0',10);cartCountValue=parseInt(localStorage.getItem(BADGE_KEYS.cart)||localStorage.getItem('__cartCount')||'0',10);}catch(e){}updateCartBadge();updateNotifBadge();});})();
    </script>
    <script>
(function() {
  var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
  var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
  var link = document.getElementById('return-nav-profile-link');
  if (link) link.href = profileHref;
})();
    </script>
    <script>
(function() {
  var DEFAULT_RETURN = {
    id: '#S04545', date: 'June 15, 2025', total: '$89.99', status: 'returned', statusLabel: 'Returned',
    returnedDate: 'June 22, 2025', refundStatus: 'Processed', payment: 'Visa â€¢â€¢â€¢â€¢ 4242',
    returnId: '#R20250715', returnMethod: 'Courier Pickup', returnReason: 'Changed mind', itemCondition: 'New with tags',
    items: [{ image: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/8edc82e22f-908ef8c4557e6b889643.png', title: 'Basic Cotton T-Shirt', meta: 'Size L â€¢ Qty 2', alt: 'Basic Cotton T-Shirt' }]
  };

  function getReturnOrder() {
    try {
      var s = localStorage.getItem('__returnOrder');
      if (s) return JSON.parse(s);
    } catch (e) {}
    return null;
  }

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function getStatusClass(status) {
    var s = (status || '').toLowerCase();
    if (s === 'processed' || s === 'completed' || s === 'refunded') return 'bg-green-100 text-green-800';
    if (s === 'processing' || s === 'inspecting') return 'bg-yellow-100 text-yellow-800';
    if (s === 'received' || s === 'shipped') return 'bg-blue-100 text-blue-800';
    return 'bg-gray-100 text-gray-800';
  }

  function buildTimeline(order) {
    var returnedDate = order.returnedDate || order.date;
    var refundStatus = (order.refundStatus || '').toLowerCase();
    var steps = [
      { label: 'Refund Issued', date: returnedDate, desc: 'Refund processed to your original payment method', active: refundStatus === 'processed' },
      { label: 'Processing Complete', date: returnedDate, desc: 'Item inspected and approved for refund', active: true },
      { label: 'Item Received', date: returnedDate, desc: 'Item arrived at our warehouse for inspection', active: true },
      { label: 'Return Shipped', date: returnedDate, desc: 'Item picked up by courier', active: true },
      { label: 'Return Request Submitted', date: returnedDate, desc: "We've received your return request", active: true }
    ];
    return steps.map(function(step, i) {
      var dotClass = step.active ? 'bg-green-500' : 'bg-gray-400';
      var lineClass = (i < steps.length - 1) ? (step.active ? 'bg-green-500' : 'bg-gray-200') : '';
      var ping = (i === 0 && step.active) ? ' relative"><div class="absolute inset-0 bg-green-500 rounded-full animate-ping opacity-75"></div>' : '">';
      var lineEl = i < steps.length - 1 ? '<div class="w-0.5 h-8 ' + lineClass + ' mt-2"></div>' : '';
      return '<div class="flex items-start gap-4"><div class="flex flex-col items-center"><div class="w-3 h-3 ' + dotClass + ' rounded-full' + ping + '</div>' + lineEl + '</div><div class="flex-1"><p class="font-medium text-sm' + (step.active && i === 0 ? ' text-green-700' : '') + '">' + escapeHtml(step.label) + '</p><p class="text-xs text-gray-600 mb-1">' + escapeHtml(step.date) + '</p><p class="text-xs text-gray-500">' + escapeHtml(step.desc) + '</p></div></div>';
    }).join('');
  }

  function renderReturnDetails(order) {
    order = order || DEFAULT_RETURN;
    var items = order.items || [];
    var id = order.id || '';

    var titleEl = document.getElementById('return-order-title');
    if (titleEl) titleEl.textContent = 'Return Details for Order ' + (id || 'â€”');

    var returnIdEl = document.getElementById('return-id');
    if (returnIdEl) returnIdEl.textContent = order.returnId || (id ? '#R' + String(id).replace(/^#/, '') : '#Râ€”');

    var statusEl = document.getElementById('return-status');
    if (statusEl) {
      statusEl.textContent = order.refundStatus || order.statusLabel || order.status || 'Processing';
      statusEl.className = 'inline-block px-3 py-1 text-xs rounded-full font-medium ' + getStatusClass(order.refundStatus || order.status);
    }

    var reqDateEl = document.getElementById('return-request-date');
    if (reqDateEl) reqDateEl.textContent = order.returnedDate || order.date || 'â€”';

    var methodEl = document.getElementById('return-method');
    if (methodEl) methodEl.textContent = order.returnMethod || 'Courier Pickup';

    var refundMethodEl = document.getElementById('return-refund-method');
    if (refundMethodEl) refundMethodEl.textContent = order.payment ? 'Original Payment (' + order.payment + ')' : 'Original Payment';

    var itemsListEl = document.getElementById('returned-items-list');
    if (itemsListEl) {
      itemsListEl.innerHTML = items.map(function(item) {
        var img = escapeHtml(item.image || '');
        var title = escapeHtml(item.title || '');
        var meta = escapeHtml(item.meta || '');
        var reason = escapeHtml(item.returnReason || order.returnReason || 'â€”');
        var condition = escapeHtml(item.condition || order.itemCondition || 'â€”');
        var itemStatus = item.refundStatus || order.refundStatus || 'Refunded';
        return '<div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg"><img src="' + img + '" alt="' + title + '" class="w-16 h-16 rounded-lg object-cover"><div class="flex-1"><h4 class="font-medium text-sm mb-1">' + title + '</h4><p class="text-xs text-gray-600 mb-2">' + meta + ' â€¢ ' + escapeHtml(order.total || '') + '</p><div class="space-y-1"><div class="flex justify-between text-xs"><span class="text-gray-600">Reason:</span><span class="font-medium">' + reason + '</span></div><div class="flex justify-between text-xs"><span class="text-gray-600">Condition:</span><span class="font-medium">' + condition + '</span></div><div class="flex justify-between text-xs"><span class="text-gray-600">Status:</span><span class="text-green-600 font-medium">' + escapeHtml(itemStatus) + '</span></div></div></div></div>';
      }).join('');
    }

    var timelineEl = document.getElementById('timeline-content');
    if (timelineEl) timelineEl.innerHTML = buildTimeline(order);

    var refundAmountEl = document.getElementById('refund-amount');
    if (refundAmountEl) refundAmountEl.textContent = order.total || 'â€”';

    var refundMethodDetailEl = document.getElementById('refund-method');
    if (refundMethodDetailEl) refundMethodDetailEl.textContent = order.payment || 'â€”';

    var refundStatusEl = document.getElementById('refund-status-badge');
    if (refundStatusEl) {
      refundStatusEl.textContent = order.refundStatus || 'Completed';
      refundStatusEl.className = 'inline-block px-3 py-1 text-xs rounded-full font-medium ' + getStatusClass(order.refundStatus);
    }

    var refundDateEl = document.getElementById('refund-processing-date');
    if (refundDateEl) refundDateEl.textContent = order.returnedDate || order.date || 'â€”';
  }

  window.setReturnOrder = function(order) {
    if (!order) return;
    try { localStorage.setItem('__returnOrder', JSON.stringify(order)); } catch (e) {}
    renderReturnDetails(order);
  };

  document.addEventListener('DOMContentLoaded', function() {
    var order = getReturnOrder();
    renderReturnDetails(order);
  });
})();

function goBack() {
  if (window.history.length > 1) window.history.back();
  else window.location.href = 'Orders.html';
}

function toggleTimeline() {
  var content = document.getElementById('timeline-content');
  var arrow = document.getElementById('timeline-arrow');
  if (!content || !arrow) return;
  if (content.style.display === 'none') {
    content.style.display = 'block';
    arrow.style.transform = 'rotate(0deg)';
  } else {
    content.style.display = 'none';
    arrow.style.transform = 'rotate(-90deg)';
  }
}

(function() {
  var overlay = document.getElementById('return-chat-overlay');
  var drawer = document.getElementById('return-chat-drawer');
  var inputBar = document.getElementById('return-chat-input-bar');
  var input = document.getElementById('return-chat-input');
  var inputCollapsed = document.getElementById('return-chat-input-collapsed');
  var sendBtn = document.getElementById('return-send-btn');
  var sendBtnCollapsed = document.getElementById('return-send-btn-collapsed');
  var dragHandle = document.getElementById('return-chat-drag-handle-area');
  var content = document.getElementById('return-chat-content');
  var addFriendContent = document.getElementById('return-add-friend-content');
  var backBtn = document.getElementById('return-chat-back-btn');

  function expand() {
    if (!drawer || !overlay || !inputBar) return;
    drawer.classList.remove('hidden');
    drawer.style.transform = 'translate(-50%, 0)';
    overlay.classList.remove('hidden');
    inputBar.classList.add('hidden');
    document.body.style.overflow = 'hidden';
  }

  function collapse() {
    if (!drawer || !overlay || !inputBar) return;
    drawer.style.transform = 'translate(-50%, 100%)';
    overlay.classList.add('hidden');
    inputBar.classList.remove('hidden');
    drawer.classList.add('hidden');
    document.body.style.overflow = '';
    content.classList.remove('hidden');
    addFriendContent.classList.add('hidden');
    backBtn.classList.add('hidden');
  }

  inputBar.addEventListener('click', expand);
  inputCollapsed.addEventListener('click', expand);
  overlay.addEventListener('click', collapse);

  if (drawer) {
    drawer.addEventListener('click', function(e) {
      if (e.target === drawer) collapse();
    });
  }

  var smartPrompts = document.querySelectorAll('.return-smart-prompt');
  smartPrompts.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var msg = btn.textContent ? btn.textContent.trim() : '';
      if (!msg) return;
      var container = document.getElementById('return-chat-messages');
      if (container) {
        var bubble = document.createElement('div');
        bubble.className = 'flex justify-end mb-4 px-4';
        bubble.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md px-4 py-2 max-w-[85%]"><p class="text-sm whitespace-pre-wrap break-words">' + msg.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p></div>';
        container.appendChild(bubble);
        scrollToBottom();
        setTimeout(function() { addShAIMessage(getShaiReply(msg)); }, 800);
      }
    });
  });

  function send() {
    var txt = (input && input.value.trim()) ? input : (inputCollapsed && inputCollapsed.value.trim()) ? inputCollapsed : null;
    if (!txt || !txt.value.trim()) return;
    var msg = txt.value.trim();
    if (input) { input.value = ''; autoResizeInput(); }
    if (inputCollapsed) inputCollapsed.value = '';
    updateInputState();
    var container = document.getElementById('return-chat-messages');
    if (container) {
      var bubble = document.createElement('div');
      bubble.className = 'flex justify-end mb-4 px-4';
      bubble.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md px-4 py-2 max-w-[85%]"><p class="text-sm whitespace-pre-wrap break-words">' + msg.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p></div>';
      container.appendChild(bubble);
      scrollToBottom();
      setTimeout(function() { addShAIMessage(getShaiReply(msg)); }, 800);
    }
  }

  function updateInputState() {
    var hasText = (input && input.value.trim()) || (inputCollapsed && inputCollapsed.value.trim()) || '';
    if (sendBtn) sendBtn.classList.toggle('hidden', !hasText);
    if (sendBtnCollapsed) sendBtnCollapsed.classList.toggle('hidden', !hasText);
    if (micBtn) micBtn.classList.toggle('hidden', !!hasText);
    if (addFriendBtn) addFriendBtn.classList.toggle('hidden', !!hasText);
  }

  function autoResizeInput() {
    if (!input) return;
    input.style.height = 'auto';
    var h = Math.max(24, Math.min(input.scrollHeight, 120));
    input.style.height = h + 'px';
    input.style.overflowY = input.scrollHeight > 120 ? 'auto' : 'hidden';
  }
  if (input) {
    input.addEventListener('input', function() { autoResizeInput(); updateInputState(); });
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  }
  if (inputCollapsed) inputCollapsed.addEventListener('input', updateInputState);

  if (sendBtn) sendBtn.addEventListener('click', send);
  if (sendBtnCollapsed) sendBtnCollapsed.addEventListener('click', send);

  var camBtn = document.getElementById('return-cam-btn');
  var camBtnCollapsed = document.getElementById('return-cam-btn-collapsed');
  var micBtn = document.getElementById('return-mic-btn');
  var addFriendBtn = document.getElementById('return-add-friend-btn');
  var addFriendBtnCollapsed = document.getElementById('return-add-friend-btn-collapsed');
  var contactsContainer = document.getElementById('return-contacts-container');
  var contactSearch = document.getElementById('return-contact-search');
  var chatMessages = document.getElementById('return-chat-messages');
  window.setShaiAvatarFromDb = window.setShAIAvatar = function(url) {
    if (!url) return;
    try { localStorage.setItem('shaiAvatar', url); } catch (e) {}
    document.querySelectorAll('.return-shai-avatar').forEach(function(img) { img.src = url; img.style.display = ''; });
    document.querySelectorAll('.return-shai-placeholder').forEach(function(s) { s.classList.add('hidden'); });
  };
  window.testShAIAvatar = function(url) {
    var testUrl = url || 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg';
    window.setShAIAvatar(testUrl);
    console.log('testShAIAvatar:', testUrl);
  };
  var devShaiAvatarDataUri = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="%23939BFB"/><text x="32" y="40" font-size="20" font-weight="bold" fill="white" text-anchor="middle" font-family="sans-serif">AI</text></svg>');
  function loadShaiAvatarFromDb() {
    if (window.__shaiAvatarUrl) { setShaiAvatarFromDb(window.__shaiAvatarUrl); return; }
    if (window.location.protocol === 'file:') {
      try { var cached = localStorage.getItem('shaiAvatar'); if (cached) setShaiAvatarFromDb(cached); else setShaiAvatarFromDb('https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png'); } catch (e) { setShaiAvatarFromDb('https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png'); }
      return;
    }
    var endpoint = window.__shaiAvatarEndpoint || '/api/avatar/shai';
    if (typeof fetch !== 'function') {
      try { var cached = localStorage.getItem('shaiAvatar'); if (cached) setShaiAvatarFromDb(cached); } catch (e) {}
      return;
    }
    fetch(endpoint, { credentials: 'same-origin' }).then(function(r) {
      if (!r.ok) throw new Error('Not found');
      return r.json().catch(function() { return r.text().then(function(t) { return { url: t }; }); });
    }).then(function(data) {
      var url = (data && (data.url || data.avatarUrl || data.avatar)) || null;
      if (url) setShaiAvatarFromDb(url);
      else { try { var c = localStorage.getItem('shaiAvatar'); if (c) setShaiAvatarFromDb(c); } catch (e) {} }
    }).catch(function() {
      try { var cached = localStorage.getItem('shaiAvatar'); if (cached) setShaiAvatarFromDb(cached); } catch (e) {}
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadShaiAvatarFromDb);
  } else {
    loadShaiAvatarFromDb();
  }

  ['return-cam-btn-collapsed', 'return-mic-btn-collapsed', 'return-add-friend-btn-collapsed'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('click', function(e) { e.preventDefault(); expand(); });
  });

  updateInputState();
  if (input) autoResizeInput();

  function getMessagesContainer() { return chatMessages; }
  function scrollToBottom() {
    if (!chatMessages) return;
    requestAnimationFrame(function() { requestAnimationFrame(function() { chatMessages.scrollTop = chatMessages.scrollHeight; }); });
  }
  var defaultShaiImg = 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
  function getShaiAvatarUrl() {
    var img = document.querySelector('.return-shai-avatar');
    var fallback = localStorage.getItem('shaiAvatar') || (window.location.protocol === 'file:' ? devShaiAvatarDataUri : defaultShaiImg);
    return (img && img.src && img.style.display !== 'none') ? img.src : fallback;
  }
  function addShAIMessage(msg) {
    if (!chatMessages || !msg) return;
    var avatarUrl = getShaiAvatarUrl();
    var bubble = document.createElement('div');
    bubble.className = 'flex items-start space-x-3 mb-4 px-4';
    bubble.innerHTML = '<div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-100 flex items-center justify-center relative"><img class="return-shai-avatar w-full h-full object-cover" src="' + (avatarUrl || defaultShaiImg).replace(/"/g, '&quot;') + '" alt="ShAI" onerror="this.style.display=\'none\';var s=this.parentElement.querySelector(\'.return-shai-placeholder\');if(s)s.classList.remove(\'hidden\')"><span class="return-shai-placeholder hidden absolute inset-0 flex items-center justify-center text-gray-400 text-xs font-medium bg-gray-100">AI</span></div><div class="flex-1 min-w-0"><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3"><p class="text-sm text-black break-words whitespace-pre-wrap">' + (msg || '').replace(/</g, '&lt;') + '</p></div></div>';
    chatMessages.appendChild(bubble);
    scrollToBottom();
  }
  function getShaiReply(msg) {
    var m = (msg || '').toLowerCase().trim();
    if (/return|refund|status|tracking|when|where|processing|received|shipped/i.test(m)) return "Your return is being processed! Refunds typically appear within 3â€“5 business days after we receive your items. I can check the exact status for you â€” would you like me to look it up?";
    if (/outfit|outfits|find.*look|style|dress|shirt|pants|jacket|what to wear/i.test(m)) return "I'd love to help you find the perfect outfit! Tell me the occasion â€” casual, work, date night, or something else â€” and I'll curate some looks for you.";
    if (/trending|trend|popular|hot|new|what\'?s in/i.test(m)) return "Here's what's trending right now: elevated basics, soft neutrals, and statement accessories. Want me to show you some picks that match your style?";
    if (/help|hi|hello|hey|what can you/i.test(m)) return "Hi! I'm here to help with your return status, refund questions, or finding your next favorite look. What would you like to explore?";
    if (/size|exchange|swap|wrong size|too (big|small)/i.test(m)) return "I can help with that! For size exchanges, we can arrange a swap when your return is received. Would you like me to start an exchange, or find similar items in your size?";
    if (/how long|delay|when will|refund.*days/i.test(m)) return "Refunds usually process within 3â€“5 business days after we receive your return. If it's been longer, I can help you track it or escalate if needed.";
    if (/thank|thanks|ty|great|perfect|awesome/i.test(m)) return "You're welcome! Let me know if you need anything else â€” I'm here to help.";
    if (/bye|goodbye|later/i.test(m)) return "Goodbye! Come back anytime you need help with returns or styling.";
    return "I'd be happy to help with that! Your return is on track, and I can also assist with outfit ideas or trending picks. What would you like to explore?";
  }
  function showToast(msg) {
    var t = document.createElement('div');
    t.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-[60]';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function() { t.remove(); }, 3000);
  }

  if (camBtn) camBtn.addEventListener('click', function(e) {
    e.preventDefault();
    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*,video/*';
    fileInput.onchange = function(ev) {
      var file = ev.target.files && ev.target.files[0];
      if (file) {
        var url = URL.createObjectURL(file);
        var container = getMessagesContainer();
        if (chatMessages) {
          var bubble = document.createElement('div');
          bubble.className = 'flex justify-end mb-4 px-4';
          bubble.innerHTML = file.type.startsWith('image/')
            ? '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><img src="' + url + '" class="w-full h-auto" alt="Uploaded"/></div>'
            : '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><video src="' + url + '" controls class="w-full h-auto"></video></div>';
          chatMessages.appendChild(bubble);
          scrollToBottom();
          setTimeout(function() {
            addShAIMessage(file.type.startsWith('video/') ? "Thanks for sharing! I can help you find pieces that match this vibe. What occasion or style are you going for?" : "I love it! I can find similar items or help you style this. What are you looking for?");
          }, 1200);
        }
        fileInput.value = '';
      }
    };
    fileInput.click();
  });

  var isRecording = false, mediaRecorder, audioChunks = [], startX, micAccessDenied = false, mediaStream = null;
  function removeTempBubble() {
    var t = document.getElementById('return-temp-recording');
    if (t) t.remove();
  }
  function startRecording(e) {
    e.preventDefault();
    expand();
    removeTempBubble();
    if (micAccessDenied) { showToast('Microphone access denied.'); return; }
    startX = e.touches ? e.touches[0].clientX : e.clientX;
    var self = e.currentTarget;
    function doStart(stream) {
      mediaStream = stream;
      mediaRecorder = new MediaRecorder(stream);
      isRecording = true;
      audioChunks = [];
      mediaRecorder.ondataavailable = function(ev) { if (ev.data.size > 0) audioChunks.push(ev.data); };
      mediaRecorder.start();
      if (self) self.classList.add('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
      var container = getMessagesContainer();
      if (container) {
        var tb = document.createElement('div');
        tb.id = 'return-temp-recording';
        tb.className = 'flex justify-end mb-2 px-4';
        tb.innerHTML = '<div class="flex items-center bg-[#939BFB] text-white rounded-2xl px-3 py-2 max-w-[70%]"><span class="mr-2">&#127908;</span><span class="text-xs">Recording... swipe left to cancel</span></div>';
        container.appendChild(tb);
        scrollToBottom();
      }
    }
    try {
      if (!mediaStream || !mediaStream.active) {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(doStart).catch(function(err) {
          removeTempBubble();
          if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) { micAccessDenied = true; showToast('Microphone access denied.'); }
          else { showToast('Could not access microphone.'); }
        });
        return;
      }
      doStart(mediaStream);
    } catch (err) { removeTempBubble(); showToast('Could not access microphone.'); }
  }
  function stopRecording(e) {
    e.preventDefault();
    if (!isRecording) return;
    isRecording = false;
    var btn = document.getElementById('return-mic-btn');
    if (btn) btn.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
    removeTempBubble();
    if (mediaRecorder) {
      mediaRecorder.stop();
      mediaRecorder.onstop = function() {
        var blob = new Blob(audioChunks, { type: 'audio/webm' });
        var url = URL.createObjectURL(blob);
        var container = getMessagesContainer();
        if (container) {
        var bubble = document.createElement('div');
        bubble.className = 'flex justify-end mb-2 px-4';
        bubble.innerHTML = '<div role="group" class="voice-message-bubble bg-[#939BFB] text-white rounded-full px-3 py-2 flex items-center gap-2 h-11 shadow-sm"><button class="play-btn flex-shrink-0 w-6 h-6 border border-white rounded-full flex items-center justify-center hover:bg-white/20 transition-all duration-150"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button><div class="waveform flex-1 flex items-center justify-center gap-0.5 h-4 max-w-[120px]"><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:8px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:12px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:6px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:16px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:10px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:14px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:8px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:12px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:6px"></div><div class="wave-bar w-0.5 bg-white/90 rounded-full" style="height:10px"></div></div><span class="duration-text text-white/90 text-xs font-medium flex-shrink-0">0:00</span><audio src="' + url + '" preload="metadata" class="hidden"></audio></div>';
          chatMessages.appendChild(bubble);
          var audioEl = bubble.querySelector('audio');
          var durationEl = bubble.querySelector('.duration-text');
          if (audioEl && durationEl) audioEl.addEventListener('loadedmetadata', function() {
            var d = Math.ceil(audioEl.duration), m = Math.floor(d / 60), s = d % 60;
            durationEl.textContent = m + ':' + (s < 10 ? '0' : '') + s;
          });
          scrollToBottom();
          setTimeout(function() { addShAIMessage("Got your voice message! I'm here to help with your return or finding your next look. Want to type a quick follow-up so I can assist better?"); }, 1000);
        }
      };
    }
  }
  function cancelRecording(e) {
    if (!isRecording) return;
    isRecording = false;
    var btn = document.getElementById('return-mic-btn');
    if (btn) btn.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
    removeTempBubble();
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }
  function handleSwipeCancel(e) {
    if (!isRecording || !e.touches || !e.touches.length) return;
    if (startX - e.touches[0].clientX > 30) cancelRecording.call(null, e);
  }
  function toggleVoicePlayback(playBtn) {
    var container = playBtn.closest('.voice-message-bubble');
    if (!container) return;
    var audio = container.querySelector('audio');
    var playIcon = playBtn.querySelector('svg');
    var waveBars = container.querySelectorAll('.wave-bar');
    var durationText = container.querySelector('.duration-text');
    if (!audio || !playIcon) return;
    function fmt(t) { var m = Math.floor(t / 60), s = Math.ceil(t % 60); return m + ':' + (s < 10 ? '0' : '') + s; }
    function stopAnim() {
      if (playIcon) playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
      waveBars.forEach(function(b) { b.style.animation = 'none'; b.classList.remove('playing'); });
      if (audio._returnTimeupdate) { audio.removeEventListener('timeupdate', audio._returnTimeupdate); audio._returnTimeupdate = null; }
    }
    if (audio.paused) {
      audio.play();
      if (playIcon) playIcon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
      waveBars.forEach(function(b, i) { b.style.animation = 'wavePulse 1.1s ease-in-out infinite'; b.style.animationDelay = (i * 0.08) + 's'; b.classList.add('playing'); });
      var onTime = function() { if (durationText) durationText.textContent = fmt(Math.ceil(audio.duration - audio.currentTime)); };
      audio._returnTimeupdate = onTime;
      audio.addEventListener('timeupdate', onTime);
      audio.addEventListener('ended', function() { stopAnim(); if (durationText) durationText.textContent = fmt(Math.ceil(audio.duration)); }, { once: true });
    } else {
      audio.pause();
      stopAnim();
      if (durationText) durationText.textContent = fmt(Math.ceil(audio.duration - audio.currentTime));
    }
  }
  chatMessages && chatMessages.addEventListener('click', function(e) {
    var playBtn = e.target.closest('.voice-message-bubble .play-btn');
    if (playBtn) { e.preventDefault(); toggleVoicePlayback(playBtn); }
  });
  if (micBtn) {
    micBtn.addEventListener('mousedown', startRecording);
    micBtn.addEventListener('touchstart', startRecording);
    micBtn.addEventListener('mouseup', stopRecording);
    micBtn.addEventListener('mouseleave', cancelRecording);
    micBtn.addEventListener('touchend', stopRecording);
    micBtn.addEventListener('touchcancel', cancelRecording);
    micBtn.addEventListener('touchmove', handleSwipeCancel);
  }

  function contactAvatarSvg(initials, fill) {
    return 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="' + (fill || '#939BFB') + '"/><text x="16" y="20" font-size="12" fill="white" text-anchor="middle" font-family="sans-serif" font-weight="bold">' + (initials || '?') + '</text></svg>');
  }
  var defaultContacts = [
    { name: 'Alex Johnson', phone: '+1 (555) 123-4567', goshopme: true, avatar: contactAvatarSvg('AJ', '#939BFB') },
    { name: 'Maria Rodriguez', phone: '+1 (555) 987-6543', goshopme: false },
    { name: 'David Kim', phone: '+1 (555) 456-7890', goshopme: true, avatar: contactAvatarSvg('DK', '#F96226') },
    { name: 'Sarah Thompson', phone: '+1 (555) 234-5678', goshopme: false }
  ];
  function getContacts() {
    try {
      var s = localStorage.getItem('__returnContacts') || localStorage.getItem('__contacts');
      if (s) { var p = JSON.parse(s); if (Array.isArray(p) && p.length > 0) return p; }
    } catch (e) {}
    return Array.isArray(window.__addFriendContacts) ? window.__addFriendContacts : defaultContacts;
  }
  window.setDeviceContacts = function(list) {
    if (!Array.isArray(list)) return;
    try { localStorage.setItem('__returnContacts', JSON.stringify(list)); } catch (e) {}
    window.__addFriendContacts = list;
    renderAddFriendContacts();
  };
  // Add Friend: contacts from device. Native app calls setDeviceContacts(list).
  // Each contact: { name, phone, goshopme, avatar? }
  // - goshopme: true + avatar: Add button, show profile pic (from GoShopMe DB)
  // - goshopme: false: Invite button, show initials
  function setContacts(list) {
    try { localStorage.setItem('__returnContacts', JSON.stringify(list)); } catch (e) {}
    if (Array.isArray(list)) window.__addFriendContacts = list;
    renderAddFriendContacts();
  }
  function getInitials(n) {
    var parts = (n || '').trim().split(/\s+/);
    return ((parts[0] ? parts[0].slice(0, 1) : '') + (parts[1] ? parts[1].slice(0, 1) : '')).toUpperCase() || '?';
  }
  function renderAddFriendContacts() {
    if (!contactsContainer) return;
    var list = getContacts();
    contactsContainer.innerHTML = list.map(function(c) {
      var initials = getInitials(c.name);
      var avatarHtml;
      var btnHtml;
      if (c.goshopme) {
        btnHtml = '<button class="return-contact-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs font-medium">Add</button>';
        avatarHtml = c.avatar
          ? '<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img src="' + (c.avatar || '').replace(/"/g, '&quot;') + '" alt="' + (c.name || '').replace(/"/g, '&quot;') + '" class="w-full h-full object-cover"></div>'
          : '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">' + initials + '</span></div>';
      } else {
        btnHtml = '<button class="return-contact-action bg-white text-[#939BFB] px-2 py-1 rounded-full text-xs font-medium border border-[#939BFB]">Invite</button>';
        avatarHtml = '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">' + initials + '</span></div>';
      }
      return '<div class="return-contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="' + (c.name || '').replace(/"/g, '&quot;') + '" data-phone="' + (c.phone || '').replace(/"/g, '&quot;') + '" data-goshopme="' + (c.goshopme ? 'true' : 'false') + '">' + avatarHtml + '<div class="flex-1 min-w-0"><p class="font-medium text-sm text-black truncate">' + (c.name || '').replace(/</g, '&lt;') + '</p><p class="text-xs text-gray-500 truncate">' + (c.phone || c.email || '').replace(/</g, '&lt;') + '</p></div>' + btnHtml + '</div>';
    }).join('');
  }
  function filterContacts(term) {
    var items = contactsContainer ? contactsContainer.querySelectorAll('.return-contact-item') : [];
    var t = (term || '').toLowerCase();
    items.forEach(function(el) {
      var match = ((el.getAttribute('data-name') || '') + (el.getAttribute('data-phone') || '')).toLowerCase().indexOf(t) !== -1;
      el.style.display = match ? 'flex' : 'none';
    });
  }
  function showAddFriendFlow() {
    expand();
    if (content) content.classList.add('hidden');
    if (addFriendContent) addFriendContent.classList.remove('hidden');
    if (backBtn) backBtn.classList.remove('hidden');
    renderAddFriendContacts();
    if (contactSearch) { contactSearch.value = ''; contactSearch.dispatchEvent(new Event('input')); }
  }
  function hideAddFriendFlow() {
    if (content) content.classList.remove('hidden');
    if (addFriendContent) addFriendContent.classList.add('hidden');
    if (backBtn) backBtn.classList.add('hidden');
    if (contactSearch) contactSearch.value = '';
  }
  if (addFriendBtn) addFriendBtn.addEventListener('click', function(e) { e.preventDefault(); showAddFriendFlow(); });
  if (addFriendBtnCollapsed) addFriendBtnCollapsed.addEventListener('click', function(e) { e.preventDefault(); showAddFriendFlow(); });
  if (backBtn) backBtn.addEventListener('click', hideAddFriendFlow);
  if (contactSearch) contactSearch.addEventListener('input', function() { filterContacts(this.value); });
  if (contactsContainer) contactsContainer.addEventListener('click', function(e) {
    if (!e.target.classList.contains('return-contact-action')) return;
    var item = e.target.closest('.return-contact-item');
    if (!item) return;
    var nameEl = item.querySelector('p');
    var name = nameEl ? nameEl.textContent : '';
    if (e.target.textContent === 'Add') {
      var container = getMessagesContainer();
      if (container) {
        var notif = document.createElement('div');
        notif.className = 'flex justify-center mb-4 px-4';
        notif.innerHTML = '<div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">' + (name.split(' ')[0] || '') + ' has been added to chat</div>';
        chatMessages.appendChild(notif);
        scrollToBottom();
      }
      hideAddFriendFlow();
    } else if (e.target.textContent === 'Invite') {
      var shareData = { title: 'Join me on GoShopMe', text: "Hey! I'm using GoShopMe.", url: 'https://app.goshopme.ai' };
      if (navigator.share) navigator.share(shareData).catch(function() {});
      else if (navigator.clipboard) navigator.clipboard.writeText(shareData.text + ' ' + shareData.url).then(function() { showToast('Invitation link copied!'); });
    }
  });
  var dragState = { active: false, startY: 0, startHeightVh: 0, touchId: null, rafId: null };
  var SNAP_HEIGHTS = [25, 50, 75, 90];
  function getDrawerHeightVh() {
    if (!drawer) return 90;
    var r = drawer.getBoundingClientRect();
    return (r.height / window.innerHeight) * 100;
  }
  function getTouchY(e) {
    if (e.touches && e.touches.length) {
      var t = dragState.touchId != null ? Array.prototype.find.call(e.touches, function(x) { return x.identifier === dragState.touchId; }) : e.touches[0];
      return t ? t.clientY : 0;
    }
    return e.clientY;
  }
  function applyHeight(vh) {
    var clamped = Math.min(90, Math.max(25, vh));
    if (drawer) drawer.style.height = clamped + 'vh';
    return clamped;
  }
  function snapToNearest(currentVh) {
    var best = SNAP_HEIGHTS[0], minDist = Math.abs(currentVh - best);
    SNAP_HEIGHTS.forEach(function(h) { var d = Math.abs(currentVh - h); if (d < minDist) { minDist = d; best = h; } });
    if (drawer) {
      drawer.style.transition = 'height 0.2s ease-out';
      drawer.style.height = best + 'vh';
      setTimeout(function() { if (drawer) drawer.style.transition = ''; }, 200);
    }
  }
  function endDrag() {
    if (dragState.rafId) cancelAnimationFrame(dragState.rafId);
    dragState.active = false;
    dragState.touchId = null;
  }
  function onDragMove(clientY) {
    if (!dragState.active) return;
    var deltaY = dragState.startY - clientY;
    var newVh = dragState.startHeightVh + (deltaY / window.innerHeight) * 100;
    if (dragState.rafId) cancelAnimationFrame(dragState.rafId);
    dragState.rafId = requestAnimationFrame(function() {
      applyHeight(newVh);
      dragState.rafId = null;
    });
  }
  if (dragHandle) {
    dragHandle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      dragState.active = true;
      dragState.touchId = null;
      dragState.startY = e.clientY;
      dragState.startHeightVh = getDrawerHeightVh();
    });
    dragHandle.addEventListener('touchstart', function(e) {
      if (e.touches && e.touches.length === 1) {
        dragState.active = true;
        dragState.touchId = e.touches[0].identifier;
        dragState.startY = e.touches[0].clientY;
        dragState.startHeightVh = getDrawerHeightVh();
      }
    }, { passive: true });
    document.addEventListener('mouseup', function() {
      if (!dragState.active) return;
      snapToNearest(getDrawerHeightVh());
      endDrag();
    });
    document.addEventListener('touchend', function(e) {
      if (!dragState.active) return;
      var changed = e.changedTouches || [];
      var isOurTouch = dragState.touchId == null || changed.some(function(t) { return t.identifier === dragState.touchId; });
      if (isOurTouch) { snapToNearest(getDrawerHeightVh()); endDrag(); }
    }, { passive: true });
    document.addEventListener('touchcancel', endDrag);
    document.addEventListener('mousemove', function(e) {
      if (!dragState.active || dragState.touchId != null) return;
      onDragMove(e.clientY);
    });
    document.addEventListener('touchmove', function(e) {
      if (!dragState.active) return;
      var clientY = getTouchY(e);
      if (clientY) {
        e.preventDefault();
        onDragMove(clientY);
      }
    }, { passive: false, capture: true });
  }
})();
    </script>
  <script src="js/shai-chat.js"></script>
</body>
</html>


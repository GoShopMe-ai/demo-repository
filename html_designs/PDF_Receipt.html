<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Receipt PDF "“ GoShopMe</title>
    <link rel="stylesheet" href="css/mobile-optimization.css">
<script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shine-primary': '#939BFB',
                        'shine-accent': '#F96226'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="css/chat-drawer-drag.css">

    
    <style>
        
/* ---- MOBILE FULL-WIDTH OVERRIDE (match Home) ---- */
@media screen and (max-width: 768px) {
  #app-shell, #main-content, #auth-screen, #welcome_screen, #quiz-screen, #onboarding-screen,
  #bottom-nav, #bottom-navigation, #header, #app-header,
  #chat-drawer, #chat-input-bar, #shai-chat-drawer, #return-chat-drawer, #return-chat-input-bar, #chat-input-collapsed,
  #shai-chat-drawer-wrapper, #chat-drawer-wrapper,
  body > div, body > main {
    max-width: 100vw !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    box-shadow: none !important;
    left: 0 !important;
    right: 0 !important;
    transform: none !important;
  }
  [class*="left-1/2"][class*="-translate-x-1/2"]:not([class*="rounded-full"]) {
    left: 0 !important;
    right: 0 !important;
    max-width: 100vw !important;
    width: 100% !important;
    transform: none !important;
  }
  #chat-drawer.translate-y-full, #shai-chat-drawer.translate-y-full, #return-chat-drawer.translate-y-full {
    transform: translateY(100%) !important;
  }
  #bottom-nav > div, #bottom-navigation > div, nav#bottom-nav > div, nav#bottom-navigation > div {
    padding-top: 2px !important;
    padding-bottom: 24px !important;
  }
}

::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; margin: 0; }
        * { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .dm-sans { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .poppins { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .bottom-nav-btn { display: flex; flex-direction: column; align-items: center; color: #6B7280; transition: color 0.2s ease-in-out; min-width: 60px; }
        .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #939BFB; }
        .bottom-nav-btn:hover svg, .bottom-nav-btn:hover span, .bottom-nav-btn.active svg, .bottom-nav-btn.active span { color: #939BFB; }
        .bottom-nav-btn svg { width: 20px; height: 20px; stroke-width: 1.5; margin-bottom: 4px; }
        #cart-indicator, #notif-indicator { min-width: 18px; min-height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
        #cart-indicator.badge-numeric, #notif-indicator.badge-numeric { min-width: 18px; padding: 0 5px; }
        @media print {
            @page { size: A4; margin: 0; }
            html, body { background: white !important; padding: 0 !important; min-height: auto !important; height: auto !important; }
            body { margin: 12mm !important; }
            .no-print { display: none !important; }
            #pdf-receipt-wrapper { box-shadow: none !important; min-height: auto !important; display: flex !important; justify-content: center !important; }
            #pdf-receipt { padding: 0 !important; padding-bottom: 0 !important; }
            #pdf-receipt {
                transform: scale(0.55);
                transform-origin: top center;
                page-break-inside: avoid;
            }
            #brand-header { padding: 12px 0 !important; }
            #receipt-title { padding: 8px 16px !important; }
            #transaction-info, #customer-info { padding: 6px 16px !important; }
            #items-section { padding: 6px 16px !important; }
            #items-section h3 { margin-bottom: 4px !important; }
            #price-breakdown { padding: 6px 16px !important; }
            #price-breakdown h3 { margin-bottom: 4px !important; }
            #price-breakdown .space-y-2 > * + * { margin-top: 2px !important; }
            #price-breakdown .pt-2 { padding-top: 4px !important; }
            #price-breakdown .mt-3 { margin-top: 4px !important; }
            #footer-info { padding: 8px 16px !important; }
            #footer-info p { margin-bottom: 2px !important; }
            #footer-info .mb-4 { margin-bottom: 4px !important; }
            #footer-info .border-t { padding-top: 4px !important; }
        }
    </style>
</head>
<body class="bg-[#F6F6F6] dm-sans min-h-screen">
<div class="w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl relative overflow-x-hidden" id="pdf-receipt-wrapper">
    <div id="header" class="sticky top-0 bg-white z-50 border-b border-gray-100 no-print">
        <div class="px-5 py-4">
            <div class="flex items-center">
                <div class="w-20 flex-shrink-0 flex items-center">
                    <a href="Receipt_Details_Screen.html" onclick="event.preventDefault();goBack()" class="p-2 text-gray-600 hover:text-gray-800 transition-colors" aria-label="Back">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
                        </svg>
                    </a>
                </div>
                <div class="flex-1 flex justify-center min-w-0">
                    <h1 class="poppins text-xl font-semibold text-gray-900">Receipt PDF</h1>
                </div>
                <div class="w-20 flex-shrink-0 flex justify-end items-center gap-0">
                    <a href="Notifications_Screen.html?from=pdf-receipt" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Notifications">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"></path>
                        </svg>
                        <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-accent rounded-full hidden items-center justify-center flex"><span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
                    </a>
                    <a href="Shopping_bag.html?from=pdf-receipt" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Shopping bag">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"></path>
                        </svg>
                        <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-primary rounded-full hidden items-center justify-center flex"><span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
                    </a>
                </div>
            </div>
        </div>
    </div>    <main id="pdf-receipt" class="pt-3 pb-24 max-w-[390px] mx-auto bg-white">
      <!-- Brand Header -->
      <div id="brand-header" class="px-6 py-5 border-b-2 border-shine-primary">
        <div class="text-center">
          <h1 class="text-3xl poppins font-bold text-shine-primary mb-2">GoShopMe</h1>
          <p class="text-gray-600 dm-sans text-sm">Your Personal Shopper</p>
        </div>
      </div>      <!-- Receipt Title -->
      <div id="receipt-title" class="px-6 py-4 text-center border-b border-gray-100">
        <h2 class="text-2xl poppins font-semibold text-gray-900 mb-2">RECEIPT</h2>
        <p id="pdf-order-number" class="text-gray-600 dm-sans text-sm">Order #S04589</p>
        <p id="pdf-receipt-number" class="text-gray-500 dm-sans text-xs mt-1">Receipt: RCT-20250715-0001</p>
      </div>      <!-- Transaction Info -->
      <div id="transaction-info" class="px-6 py-3 border-b border-gray-100">
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div><p class="text-gray-600 dm-sans">Date:</p><p id="pdf-date" class="font-medium dm-sans">July 15, 2025</p></div>
          <div><p class="text-gray-600 dm-sans">Payment:</p><p id="pdf-payment" class="font-medium dm-sans">Visa •••• 4242</p></div>
          <div><p class="text-gray-600 dm-sans">Status:</p><p id="pdf-status" class="font-medium text-green-600 dm-sans">Paid</p></div>
          <div><p class="text-gray-600 dm-sans">Type:</p><p id="pdf-type" class="font-medium dm-sans">Purchase</p></div>
        </div>
      </div>      <!-- Customer Info -->
      <div id="customer-info" class="px-6 py-3 border-b border-gray-100">
        <h3 class="poppins text-sm font-semibold text-gray-900 mb-2">Bill To:</h3>
        <div class="text-sm dm-sans">
          <p id="pdf-billed-to" class="font-medium">Maria Lopez</p>
          <p id="pdf-address" class="text-gray-600 mt-1">123 Rue Saint-Honoré</p>
          <p id="pdf-city" class="text-gray-600">Paris, France 75001</p>
        </div>
      </div><!-- Items Purchased -->
      <div id="items-section" class="px-6 py-3 border-b border-gray-100">
        <h3 class="poppins text-sm font-semibold text-gray-900 mb-2">Items Purchased:</h3>
        <div id="pdf-items-container"></div>
      </div>      <!-- Price Breakdown -->
      <div id="price-breakdown" class="px-6 py-3 border-b border-gray-100">
        <h3 class="poppins text-sm font-semibold text-gray-900 mb-2">Price Breakdown:</h3>
        <div class="space-y-2 text-sm dm-sans">
          <div class="flex justify-between"><span class="text-gray-600">Subtotal:</span><span id="pdf-subtotal" class="font-medium">$250.00</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Shipping:</span><span id="pdf-shipping" class="font-medium">$9.50</span></div>
          <div class="flex justify-between"><span class="text-gray-600">Taxes:</span><span id="pdf-taxes" class="font-medium">$30.00</span></div>
          <div class="flex justify-between border-t border-gray-100 pt-2 mt-2"><span class="poppins font-bold text-shine-primary text-lg">Total Paid:</span><span id="pdf-total" class="poppins font-bold text-shine-primary text-lg">$289.50</span></div>
        </div>
      </div>      <!-- Footer Info -->
      <div id="footer-info" class="px-6 py-4 text-center">
        <p class="text-xs text-gray-500 dm-sans mb-1">Thank you for shopping with GoShopMe!</p>
        <p class="text-xs text-gray-500 dm-sans mb-2">Questions? Contact us at support@goshopme.com</p>
        <div class="border-t border-gray-100 pt-2">
          <p id="pdf-generated" class="text-xs text-gray-400 dm-sans">Generated on: July 15, 2025 at 3:47 PM</p>
          <p class="text-xs text-gray-400 dm-sans">This is an official receipt for your records.</p>
        </div>
      </div>      <!-- Action Buttons -->
      <div id="action-buttons" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 no-print">
        <div class="p-4 flex gap-2">
          <button onclick="printReceipt()" class="flex items-center justify-center rounded-full bg-shine-primary py-2.5 px-4 flex-1 text-sm font-medium text-white dm-sans hover:opacity-90 transition-opacity">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" class="w-4 h-4 mr-1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0021 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 00-1.913-.247M6.34 18H5.25A2.25 2.25 0 013 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 011.913-.247m10.5 0a48.536 48.536 0 00-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5zm-3 0h.008v.008H15V10.5zm-3 0h.008v.008H12V10.5z"></path>
            </svg>
            Print
          </button>
          <button onclick="shareReceipt()" class="flex items-center justify-center rounded-full border border-[#B7C7FF] py-2.5 px-4 flex-1 text-xs font-medium text-shine-primary dm-sans hover:bg-shine-primary hover:text-white transition-colors">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" class="w-4 h-4 mr-1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z"></path>
            </svg>
            Share
          </button>
        </div>
      </div>
    </main>
    <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] border-t border-gray-100 bg-white px-4 py-3 z-50 no-print">
        <div class="flex items-center justify-around">
            <a href="Home.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"></path>
                </svg>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"></path>
                </svg>
                <span class="text-xs mt-1">Picks</span>
            </a>
            <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"></path>
                </svg>
                <span class="text-xs mt-1">Wishlist</span>
            </a>
            <a id="pdf-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px]">
                <span id="pdf-nav-profile-icon" class="flex items-center justify-center w-6 h-6 mb-1 text-shine-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path>
                    </svg>
                </span>
                <img id="pdf-nav-profile-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </nav>
    <div id="success-notification" class="fixed top-20 left-1/2 -translate-x-1/2 w-full max-w-[390px] mx-4 bg-green-600 text-white p-4 rounded-xl shadow-lg z-[60] hidden">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1 min-w-0">
                <p id="success-notification-title" class="font-medium poppins text-sm">Receipt action completed</p>
                <p id="success-notification-body" class="text-xs opacity-90 dm-sans">Your receipt has been processed successfully.</p>
            </div>
        </div>
    </div>
    <script>
(function(){var BADGE_KEYS={notif:'goshopme_notif_count',cart:'goshopme_cart_count'};var cartCountValue=0,notifCountValue=0;function getBadgeElements(){return{cartIndicator:document.getElementById('cart-indicator'),cartCount:document.getElementById('cart-count'),notifIndicator:document.getElementById('notif-indicator'),notifCount:document.getElementById('notif-count')};}function updateCartBadge(){var el=getBadgeElements();if(!el.cartIndicator||!el.cartCount)return;var show=cartCountValue>0;el.cartIndicator.classList.toggle('hidden',!show);el.cartIndicator.classList.toggle('flex',show);el.cartCount.textContent=show?(cartCountValue>99?'99+':cartCountValue):'';try{localStorage.setItem(BADGE_KEYS.cart,String(cartCountValue));localStorage.setItem('__cartCount',String(cartCountValue));}catch(e){}}function updateNotifBadge(){var el=getBadgeElements();if(!el.notifIndicator||!el.notifCount)return;var show=notifCountValue>0;el.notifIndicator.classList.toggle('hidden',!show);el.notifIndicator.classList.toggle('flex',show);el.notifCount.textContent=show?(notifCountValue>99?'99+':notifCountValue):'';try{localStorage.setItem(BADGE_KEYS.notif,String(notifCountValue));localStorage.setItem('notifCount',String(notifCountValue));}catch(e){}}window.updateCartBadge=updateCartBadge;window.updateNotifBadge=updateNotifBadge;window.testBadges=function(notif,cart){notifCountValue=Math.max(0,notif!=null?notif:5);cartCountValue=Math.max(0,cart!=null?cart:3);updateNotifBadge();updateCartBadge();};window.resetBadges=function(){cartCountValue=0;notifCountValue=0;try{localStorage.setItem(BADGE_KEYS.notif,'0');localStorage.setItem(BADGE_KEYS.cart,'0');localStorage.setItem('__cartCount','0');localStorage.setItem('notifCount','0');}catch(e){}updateCartBadge();updateNotifBadge();};document.addEventListener('DOMContentLoaded',function(){try{notifCountValue=parseInt(localStorage.getItem(BADGE_KEYS.notif)||localStorage.getItem('notifCount')||'0',10);cartCountValue=parseInt(localStorage.getItem(BADGE_KEYS.cart)||localStorage.getItem('__cartCount')||'0',10);}catch(e){}updateCartBadge();updateNotifBadge();});})();
    </script>
    <script>
      function printReceipt()
      {
        window.print();
      }

      function shareReceipt()
      {
        generateAndSharePdf(function() { showNotification('Receipt shared successfully'); }, function() {});
      }

      function enrichReceiptOrder(order) {
        if (!order) return null;
        var o = {};
        o.id = order.id || order.orderNumber || '';
        o.receiptNumber = order.receiptNumber || (o.id ? 'RCT-' + String(o.id).replace(/^#/,'').replace(/\s/g,'') + '-' + (order.date || '').replace(/\s/g,'') : 'RCT-0001');
        o.date = order.date || '"”';
        o.payment = order.payment || '"”';
        o.statusLabel = order.statusLabel || order.status || 'Paid';
        o.subtotal = order.subtotal != null ? order.subtotal : order.total || '"”';
        o.shipping = order.shipping != null ? order.shipping : '"”';
        o.taxes = order.taxes != null ? order.taxes : '"”';
        o.total = order.total || '"”';
        o.billedTo = order.billedTo || '"”';
        o.shippingAddress = order.shippingAddress || '';
        o.shippingCity = order.shippingCity || '';
        o.items = Array.isArray(order.items) ? order.items : [];
        return o;
      }

      function buildReceiptPdfHtml(order) {
        order = enrichReceiptOrder(order);
        if (!order || !order.items) return '';
        function esc(s) { return (s == null) ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
        var id = order.id || '';
        var rn = order.receiptNumber || 'RCT-0001';
        var st = order.subtotal || '"”', sh = order.shipping || '"”', tx = order.taxes || '"”';
        var addr = [order.shippingAddress || '', order.shippingCity || ''].filter(Boolean).join(', ') || '"”';
        var now = new Date().toLocaleDateString('en-US', { year:'numeric',month:'long',day:'numeric' }) + ' at ' + new Date().toLocaleTimeString('en-US', { hour:'numeric',minute:'2-digit' });
        var itemRows = order.items.map(function(i) {
          var p = i.price != null ? i.price : (order.items.length === 1 ? order.total : null);
          if (p == null) p = '"”';
          return '<tr><td style="padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:11px;vertical-align:top;text-align:center;">' +
            '<div style="font-weight:500;color:#111;">' + esc(i.title || 'Item') + '</div>' +
            '<div style="font-size:10px;color:#6b7280;">' + esc(i.meta || '') + '</div></td>' +
            '<td style="padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:11px;font-weight:500;text-align:center;vertical-align:top;">' + esc(p) + '</td></tr>';
        }).join('');
        var receiptInner = '<div style="font-family:\'DM Sans\',sans-serif;background:#fff;width:350px;color:#374151;text-align:center;">' +
          '<div style="text-align:center;border-bottom:2px solid #939BFB;padding:10px 0;">' +
            '<h1 style="margin:0;font-size:24px;color:#939BFB;font-weight:700;">GoShopMe</h1>' +
            '<p style="margin:4px 0 0;font-size:12px;color:#6b7280;">Your Personal Shopper</p></div>' +
          '<div style="text-align:center;padding:8px 16px;border-bottom:1px solid #f3f4f6;">' +
            '<h2 style="margin:0 0 4px;font-size:18px;font-weight:600;color:#111;">RECEIPT</h2>' +
            '<p style="margin:0;font-size:12px;color:#6b7280;">Order ' + esc(id || '"”') + '</p>' +
            '<p style="margin:2px 0 0;font-size:11px;color:#9ca3af;">Receipt: ' + esc(rn) + '</p></div>' +
          '<div style="padding:6px 16px;border-bottom:1px solid #f3f4f6;text-align:center;">' +
            '<table style="width:100%;border-collapse:collapse;font-size:12px;margin:0 auto;"><tr>' +
            '<td style="padding:2px 4px 2px 0;text-align:center;"><span style="color:#6b7280;">Date:</span></td><td style="padding:2px 0;font-weight:500;text-align:center;">' + esc(order.date) + '</td>' +
            '<td style="padding:2px 0 2px 12px;text-align:center;"><span style="color:#6b7280;">Payment:</span></td><td style="padding:2px 0;font-weight:500;text-align:center;">' + esc(order.payment) + '</td></tr><tr>' +
            '<td style="padding:2px 4px 2px 0;text-align:center;"><span style="color:#6b7280;">Status:</span></td><td style="padding:2px 0;font-weight:500;color:#16a34a;text-align:center;">' + esc(order.statusLabel) + '</td>' +
            '<td style="padding:2px 0 2px 12px;text-align:center;"><span style="color:#6b7280;">Type:</span></td><td style="padding:2px 0;font-weight:500;text-align:center;">Purchase</td></tr></table></div>' +
          '<div style="padding:6px 16px;border-bottom:1px solid #f3f4f6;text-align:center;">' +
            '<h3 style="margin:0 0 4px;font-size:12px;font-weight:600;color:#111;">Bill To:</h3>' +
            '<p style="margin:0;font-size:12px;font-weight:500;">' + esc(order.billedTo) + '</p>' +
            '<p style="margin:4px 0 0;font-size:11px;color:#6b7280;">' + esc(addr) + '</p></div>' +
          '<div style="padding:6px 16px;border-bottom:1px solid #f3f4f6;text-align:center;">' +
            '<h3 style="margin:0 0 4px;font-size:12px;font-weight:600;color:#111;">Items Purchased:</h3>' +
            '<table style="width:100%;border-collapse:collapse;margin:0 auto;">' + itemRows + '</table></div>' +
          '<div style="padding:6px 16px;border-bottom:1px solid #f3f4f6;text-align:center;">' +
            '<h3 style="margin:0 0 4px;font-size:12px;font-weight:600;color:#111;">Price Breakdown:</h3>' +
            '<table style="width:100%;border-collapse:collapse;font-size:12px;margin:0 auto;">' +
            '<tr><td style="padding:4px 0;color:#6b7280;text-align:center;">Subtotal:</td><td style="padding:4px 0;font-weight:500;text-align:center;">' + esc(st) + '</td></tr>' +
            '<tr><td style="padding:4px 0;color:#6b7280;text-align:center;">Shipping:</td><td style="padding:4px 0;font-weight:500;text-align:center;">' + esc(sh) + '</td></tr>' +
            '<tr><td style="padding:4px 0;color:#6b7280;text-align:center;">Taxes:</td><td style="padding:4px 0;font-weight:500;text-align:center;">' + esc(tx) + '</td></tr>' +
            '<tr><td style="padding:6px 0 0;border-top:1px solid #f3f4f6;font-weight:700;font-size:14px;color:#939BFB;text-align:center;">Total Paid:</td><td style="padding:6px 0 0;border-top:1px solid #f3f4f6;font-weight:700;font-size:14px;color:#939BFB;text-align:center;">' + esc(order.total) + '</td></tr></table></div>' +
          '<div style="padding:8px 16px;text-align:center;">' +
            '<p style="margin:0 0 2px;font-size:11px;color:#6b7280;">Thank you for shopping with GoShopMe!</p>' +
            '<p style="margin:0 0 4px;font-size:11px;color:#6b7280;">Questions? Contact us at support@goshopme.com</p>' +
            '<div style="border-top:1px solid #f3f4f6;padding-top:4px;"><p style="margin:0 0 2px;font-size:10px;color:#9ca3af;">Generated on: ' + esc(now) + '</p>' +
            '<p style="margin:0;font-size:10px;color:#9ca3af;">This is an official receipt for your records.</p></div></div></div>';
        return receiptInner;
      }

      function generateAndSharePdf(onSuccess, onFail) {
        var order = null;
        try { order = JSON.parse(localStorage.getItem('__receiptOrder') || '{}'); } catch (e) {}
        if (!order || !order.items || order.items.length === 0) {
          order = { id: '#S04589', date: 'July 15, 2025', total: '$289.50', statusLabel: 'Delivered', payment: 'Visa •••• 4242', receiptNumber: 'RCT-20250715-0001', subtotal: '$250.00', shipping: '$9.50', taxes: '$30.00', billedTo: 'Maria Lopez', shippingAddress: '123 Rue Saint-Honoré', shippingCity: 'Paris, France 75001', items: [{ title: 'Summer Floral Dress', meta: 'Size M • Qty 1', price: '$250.00' }] };
        }
        var orderId = (order && (order.id || order.orderNumber)) ? String(order.id || order.orderNumber).replace(/^#/,'') : 'S04589';
        var html = buildReceiptPdfHtml(order);
        if (!html) { onFail(); return; }
        var container = document.createElement('div');
        container.style.cssText = 'position:absolute;left:-9999px;top:0;width:350px;background:#fff;pointer-events:none';
        var el = document.createElement('div');
        el.innerHTML = html;
        container.appendChild(el);
        document.body.appendChild(container);
        var targetEl = el.firstElementChild || el;
        var opts = {
          margin: [20, 55, 20, 55],
          filename: 'GoShopMe-Receipt-' + orderId + '.pdf',
          image: { type: 'jpeg', quality: 0.95 },
          html2canvas: { scale: 1, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
          pagebreak: { mode: 'avoid-all' }
        };
        if (typeof html2pdf !== 'undefined') {
          var runCapture = function() {
            html2pdf().set(opts).from(targetEl).outputPdf('blob').then(function(blob) {
            if (container.parentNode) document.body.removeChild(container);
            var file = new File([blob], 'GoShopMe-Receipt-' + orderId + '.pdf', { type: 'application/pdf' });
            var shareData = { title: 'GoShopMe Receipt ' + orderId, text: 'My receipt from GoShopMe', files: [file] };
            if (navigator.share) {
              navigator.share(shareData).then(onSuccess).catch(function() {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'GoShopMe-Receipt-' + orderId + '.pdf';
                a.click();
                URL.revokeObjectURL(a.href);
                showNotification('PDF saved - share the file from your device');
                onSuccess();
              });
            } else {
              var a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'GoShopMe-Receipt-' + orderId + '.pdf';
              a.click();
              URL.revokeObjectURL(a.href);
              showNotification('PDF saved - share the file from your device');
              onSuccess();
            }
          }).catch(function(err) { if (container.parentNode) document.body.removeChild(container); onFail(); });
          };
          requestAnimationFrame(function() { setTimeout(runCapture, 100); });
        } else {
          if (container.parentNode) document.body.removeChild(container);
          navigator.clipboard.writeText(window.location.href).then(function() { showNotification('Receipt link copied to clipboard'); }).catch(onFail);
        }
      }

      function showNotification(message)
      {
        var notification = document.getElementById('success-notification');
        var body = document.getElementById('success-notification-body');
        if (body) body.textContent = message;
        if (notification) { notification.classList.remove('hidden'); setTimeout(function() { notification.classList.add('hidden'); }, 3000); }
      }

      function goBack()
      {
        if (window.history.length > 1) window.history.back();
        else window.location.href = 'Receipt_Details_Screen.html';
      }

      (function populateFromReceiptOrder() {
        var order = null;
        try {
          var s = localStorage.getItem('__receiptOrder');
          if (s) order = JSON.parse(s);
        } catch (e) {}
        if (!order) return;

        function esc(str) { return (str == null) ? '' : String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
        var id = order.id || '';
        var receiptNum = order.receiptNumber || (id ? 'RCT-' + String(id).replace(/^#/, '') : 'RCT-0001');
        var subtotal = order.subtotal || order.total || '"”';
        var shipping = order.shipping != null ? order.shipping : '"”';
        var taxes = order.taxes != null ? order.taxes : '"”';
        var items = order.items || [];
        var addr = order.shippingAddress || '';
        var city = order.shippingCity || '';

        var set = function(id, text) { var el = document.getElementById(id); if (el) el.textContent = text; };
        set('pdf-order-number', 'Order ' + (id || '"”'));
        set('pdf-receipt-number', 'Receipt: ' + receiptNum);
        set('pdf-date', order.date || '"”');
        set('pdf-payment', order.payment || '"”');
        set('pdf-status', order.statusLabel || order.status || 'Paid');
        set('pdf-type', 'Purchase');
        set('pdf-billed-to', order.billedTo || '"”');
        set('pdf-address', addr || '"”');
        set('pdf-city', city || '"”');
        set('pdf-subtotal', subtotal);
        set('pdf-shipping', shipping);
        set('pdf-taxes', taxes);
        set('pdf-total', order.total || '"”');

        var container = document.getElementById('pdf-items-container');
        if (container) {
          var itemPrice = items.length === 1 && !items[0].price ? (order.total || '') : null;
          container.innerHTML = items.map(function(item) {
            var img = item.image || '';
            var title = esc(item.title || '');
            var meta = esc(item.meta || '');
            var price = item.price || itemPrice || '"”';
            return '<div class="flex items-center gap-3 py-3 border-b border-gray-100">' +
              '<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">' +
              (img ? '<img class="w-full h-full object-cover" src="' + esc(img) + '" alt="' + title + '">' :
                '<svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>') +
              '</div>' +
              '<div class="flex-1 min-w-0"><p class="font-medium text-sm">' + title + '</p><p class="text-xs text-gray-600">' + esc(meta) + '</p></div>' +
              '<div class="text-right flex-shrink-0"><p class="font-medium text-sm">' + esc(price) + '</p></div>' +
              '</div>';
          }).join('');
        }

        var now = new Date();
        var genStr = 'Generated on: ' + now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) + ' at ' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        set('pdf-generated', genStr);
      })();

      (function() {
        var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
        var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
        var link = document.getElementById('pdf-nav-profile-link');
        if (link) link.href = profileHref;
        var saved = null;
        try { saved = localStorage.getItem('profilePhoto'); } catch (e) {}
        var img = document.getElementById('pdf-nav-profile-photo');
        var icon = document.getElementById('pdf-nav-profile-icon');
        if (img && icon) {
          if (saved) { img.src = saved; img.classList.remove('hidden'); icon.classList.add('hidden'); }
          else { img.src = ''; img.classList.add('hidden'); icon.classList.remove('hidden'); }
        }
      })();

      (function autoPrintIfRequested() {
        var params = new URLSearchParams(window.location.search);
        if (params.get('print') === '1') {
          setTimeout(function() { window.print(); }, 600);
        }
      })();

      // API readiness: get/set receipt data
      window.getPdfReceiptData = function() {
        try { return JSON.parse(localStorage.getItem('__receiptOrder') || 'null'); } catch (e) { return null; }
      };
      window.setPdfReceiptData = function(data) {
        if (data) try { localStorage.setItem('__receiptOrder', JSON.stringify(data)); } catch (e) {}
      };
      document.addEventListener('DOMContentLoaded', function() {
        if (window.__PDF_RECEIPT_DATA__) window.setPdfReceiptData(window.__PDF_RECEIPT_DATA__);
      });
    </script>
</div>
</body>
</html>


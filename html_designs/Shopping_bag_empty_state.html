<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <title>Your Bag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'space-grotesk': ['Space Grotesk', 'sans-serif'],
                        'dm-sans': ['DM Sans', 'sans-serif']
                    },
                    colors: {
                        'shine-primary': '#939BFB',
                        'shine-accent': '#F96226',
                        'shine-support': '#B7C7FF'
                    }
                }
            }
        }
    </script>
    <script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/chat-drawer-drag.css">
    <style>
        ::-webkit-scrollbar { display: none;}
        
        @keyframes slide-in-left {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slide-in-right {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .animate-slide-in-left {
            animation: slide-in-left 0.3s ease forwards;
        }
        
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease forwards;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-shimmer {
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .animate-fade-in {
            animation: fade-in 0.2s ease-out;
        }
        
        @keyframes wavePulse {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.0); }
        }
        
        .wave-bar.playing {
            animation: wavePulse 1.1s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.08s);
        }

        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .animate-progress {
            animation: progress var(--duration) linear;
        }
        .header-icon-btn { transition: transform 0.2s ease, color 0.2s ease; }
        .header-icon-btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-white font-['DM_Sans']">

<!-- Header -->
<header id="header" class="fixed top-0 left-0 right-0 bg-white z-50 border-b border-gray-100">
    <div class="flex items-center justify-between p-4">
        <a id="cart-empty-back-link" href="Home.html" onclick="return typeof goBackCartEmpty==='function'?goBackCartEmpty(event):true" class="header-icon-btn w-10 h-10 flex items-center justify-center p-2 text-gray-600 hover:text-gray-800" aria-label="Back">
            <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path>
            </svg>
        </a>
        <h1 class="text-lg font-semibold text-gray-900 font-['Space_Grotesk']">Your Bag</h1>
        <div class="flex items-center space-x-3">
            <a href="Notifications_Screen.html?from=cart-empty" class="header-icon-btn w-10 h-10 flex items-center justify-center relative p-2 text-gray-600 hover:text-gray-800" aria-label="Notifications">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"></path>
                </svg>
                <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-accent rounded-full hidden items-center justify-center flex"><span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
            <a href="Shopping_bag.html?from=cart-empty" class="header-icon-btn w-10 h-10 flex items-center justify-center relative p-2 text-gray-600 hover:text-gray-800" aria-label="Shopping bag">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"></path>
                </svg>
                <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-shine-primary rounded-full hidden items-center justify-center flex"><span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span></div>
            </a>
        </div>
    </div>
</header>

<!-- Empty State Content -->
<section id="empty-state" class="pt-20 flex flex-col items-center justify-center min-h-[50vh] px-4 pb-40">
    <div class="flex flex-col items-center text-center max-w-[280px] mx-auto">
        <div class="mb-6">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"></path>
            </svg>
        </div>
        <h2 class="text-lg font-semibold text-black font-['Space_Grotesk'] mb-3">Your shopping bag is empty</h2>
        <p class="text-sm text-gray-500 text-center leading-relaxed">Ask ShAI to help you add your loved items</p>
    </div>
</section>

<!-- Chat Drawer Overlay -->
<div id="chat-overlay" class="fixed inset-0 bg-black/20 z-40 hidden"></div>

<!-- Chat Drawer -->
<div id="chat-drawer" class="fixed bottom-16 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-50 h-[50vh] transform translate-y-full transition-transform duration-300 flex flex-col">
    <!-- Drag Handle -->
    <div id="drag-handle-zone" class="chat-drawer-drag-zone flex justify-center pt-3 flex-shrink-0">
        <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full cursor-pointer pointer-events-none"></div>
    </div>

    <!-- Chat Header -->
    <div id="chat-header" class="flex items-center px-4 py-3 flex-shrink-0 border-b border-gray-50">
        <button id="back-btn" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center mr-3 hidden hover:bg-gray-100 transition-colors">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </button>
        <div class="w-8 h-8 rounded-full overflow-hidden mr-3 flex-shrink-0">
            <img class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar />
        </div>
        <div class="flex-1">
            <p class="font-semibold text-gray-900 text-sm font-['Space_Grotesk']">ShAI</p>
            <p class="text-xs text-gray-500">Your shopping assistant</p>
        </div>
    </div>

    <!-- Chat Content -->
    <div id="chat-content" class="flex-1 flex flex-col min-h-0">
        <div id="chat-messages" class="flex-1 overflow-y-auto px-4 py-2">
            <!-- ShAI Welcome Message -->
            <div class="flex items-start space-x-3 mb-2 animate-slide-in-left">
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                    <img class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar />
                </div>
                <div class="flex-1">
                    <div class="bg-gray-50 rounded-2xl rounded-tl-md p-2.5 mb-3 shadow-sm max-w-[80%]">
                        <p class="text-sm text-gray-900">Hi! I'm ShAI, your personal shopping assistant. I can help you find exactly what you're looking for. What would you like to shop for today?</p>
                    </div>
                </div>
            </div>
            
            <!-- Smart Prompts -->
            <div class="flex flex-wrap gap-2 px-11 mb-4">
                <button class="smart-prompt bg-white border border-shine-primary text-shine-primary px-4 py-2 rounded-full text-sm font-medium hover:bg-shine-primary hover:text-white transition-colors">
                    Date night outfit
                </button>
                <button class="smart-prompt bg-white border border-shine-primary text-shine-primary px-4 py-2 rounded-full text-sm font-medium hover:bg-shine-primary hover:text-white transition-colors">
                    New job wardrobe
                </button>
                <button class="smart-prompt bg-white border border-shine-primary text-shine-primary px-4 py-2 rounded-full text-sm font-medium hover:bg-shine-primary hover:text-white transition-colors">
                    Resort finds
                </button>
                <button class="smart-prompt bg-white border border-shine-primary text-shine-primary px-4 py-2 rounded-full text-sm font-medium hover:bg-shine-primary hover:text-white transition-colors">
                    Bags
                </button>
                <button class="smart-prompt bg-white border border-shine-primary text-shine-primary px-4 py-2 rounded-full text-sm font-medium hover:bg-shine-primary hover:text-white transition-colors">
                    Shoes
                </button>
            </div>
        </div>

        <!-- Chat Input Drawer -->
        <div id="chat-input-drawer" class="bg-white border-t border-gray-100 p-4 flex-shrink-0">
            <div class="flex items-end space-x-3 bg-gray-50 rounded-full px-4 py-2 shadow-sm">
                <button id="cam-btn-drawer" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                    </svg>
                </button>
                <textarea id="chat-input-drawer-field" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-gray-900 placeholder-gray-400 resize-none leading-6 py-0 text-sm focus:ring-1 focus:ring-shine-primary" rows="1" style="height: 24px; overflow-y: hidden;"></textarea>
                <button id="add-friend-btn-drawer" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 019.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                    </svg>
                </button>
                <button id="mic-btn-drawer" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors relative">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <button id="send-btn-drawer" class="text-shine-primary hidden flex-shrink-0 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Friend Content -->
    <div id="add-friend-content" class="flex-1 flex flex-col min-h-0 hidden">
        <div id="contact-list" class="flex-1 overflow-y-auto p-4">
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full bg-white border border-gray-200 rounded-2xl px-4 py-3 pl-10 text-sm focus:outline-none focus:ring-1 focus:ring-shine-primary shadow-sm">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                </div>
            </div>
            
            <div id="contacts-container" class="space-y-2">
                <!-- Contact items populated by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Fixed Chat Input Bar When Collapsed -->
<div id="chat-input-bar" class="fixed bottom-16 left-0 right-0 bg-white border-t border-gray-100 p-4 z-30 hidden">
    <div class="flex items-end space-x-3 bg-gray-50 rounded-full px-4 py-2 shadow-sm">
        <button id="cam-btn" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
            </svg>
        </button>
        <textarea id="message-input" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-gray-900 placeholder-gray-400 resize-none leading-6 py-0 text-sm focus:ring-1 focus:ring-shine-primary" rows="1" style="height: 24px; overflow-y: hidden;"></textarea>
        <button id="add-friend-btn" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM3 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 019.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
            </svg>
        </button>
        <button id="mic-btn" class="text-gray-500 hover:text-shine-primary flex-shrink-0 transition-colors relative">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
            </svg>
        </button>
        <button id="send-btn" class="text-shine-primary hidden flex-shrink-0 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" />
            </svg>
        </button>
    </div>
</div>

<!-- Bottom Navigation -->
<nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 z-50">
    <div class="flex items-center justify-around py-2">
        <a href="Home.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-shine-primary transition-colors">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"></path>
            </svg>
            <span class="text-xs">Home</span>
        </a>
        <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-shine-primary transition-colors">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"></path>
            </svg>
            <span class="text-xs">Picks</span>
        </a>
        <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-shine-primary transition-colors">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"></path>
            </svg>
            <span class="text-xs">Wishlist</span>
        </a>
        <a id="bag-empty-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center min-w-[60px] p-2 text-gray-400 hover:text-shine-primary transition-colors">
            <span id="bag-empty-nav-profile-icon" class="flex items-center justify-center w-6 h-6 mb-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                </svg>
            </span>
            <img id="bag-empty-nav-profile-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
            <span class="text-xs">Profile</span>
        </a>
    </div>
</nav>

<script>
// Dynamic profile avatar and link in bottom nav
(function() {
    var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
    var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
    var profileLink = document.getElementById('bag-empty-nav-profile-link');
    if (profileLink) profileLink.href = profileHref;
    var navIcon = document.getElementById('bag-empty-nav-profile-icon');
    var navPhoto = document.getElementById('bag-empty-nav-profile-photo');
    var saved = null;
    try { saved = localStorage.getItem('profilePhoto'); } catch (err) {}
    if (saved && navPhoto && navIcon) {
        navPhoto.src = saved;
        navPhoto.classList.remove('hidden');
        navIcon.classList.add('hidden');
    }
})();
</script>
<script>
// Badges: cart=0 on empty bag page, notif from localStorage; hide when count is 0
(function() {
    var BADGE_KEYS = { notif: 'goshopme_notif_count', cart: 'goshopme_cart_count' };
    var cartCountValue = 0;
    var notifCountValue = 0;
    function updateBadges() {
        var cartEl = document.getElementById('cart-indicator'), cartCount = document.getElementById('cart-count');
        var notifEl = document.getElementById('notif-indicator'), notifCount = document.getElementById('notif-count');
        if (cartEl && cartCount) {
            var showCart = cartCountValue > 0;
            cartEl.classList.toggle('hidden', !showCart);
            cartEl.classList.toggle('flex', showCart);
            cartCount.textContent = showCart ? (cartCountValue > 99 ? '99+' : cartCountValue) : '';
        }
        if (notifEl && notifCount) {
            var showNotif = notifCountValue > 0;
            notifEl.classList.toggle('hidden', !showNotif);
            notifEl.classList.toggle('flex', showNotif);
            notifCount.textContent = showNotif ? (notifCountValue > 99 ? '99+' : notifCountValue) : '';
        }
        try {
            localStorage.setItem(BADGE_KEYS.cart, '0');
            localStorage.setItem('__cartCount', '0');
            localStorage.setItem(BADGE_KEYS.notif, String(notifCountValue));
        } catch (e) {}
    }
    document.addEventListener('DOMContentLoaded', function() {
        try { notifCountValue = parseInt(localStorage.getItem(BADGE_KEYS.notif) || localStorage.getItem('notifCount') || '0', 10); } catch (e) {}
        updateBadges();
    });
})();
</script>
<script>
// Contextual back: from param -> previous page
(function() {
    var fromMap = {
        'home': 'Home.html',
        'picks': "Picks.html",
        'wishlist': 'Wishlist.html',
        'orders': 'Orders.html',
        'orders-empty': 'Orders_Screen_Empty_State.html',
        'order-tracking': 'Order_Tracking.html',
        'product': 'Product_details_page.html',
        'collections': "Creator`s Collections_Page.html",
        'collection': "Creator`s Single_Collection.html",
        'notifications-settings': 'Notifications_Settings.html',
        'notifications': 'Notifications_Screen.html',
        'cart': 'Shopping_bag.html',
        'category': 'ShopbyCategory.html',
        'subscription': 'Subscription_Management.html',
        'trending': 'Trending_Now.html',
        'profile-free': 'User_Profile_Free_Plan.html',
        'profile-paid': 'User_Profile_Paid_Plan.html',
        'privacy-settings': 'Privacy_Settings.html',
        'return-details': 'Return_Details.html',
        'receipt': 'Receipt_Details_Screen.html'
    };
    window.goBackCartEmpty = function(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var params = new URLSearchParams(window.location.search);
        var from = (params.get('from') || '').toLowerCase();
        var target = fromMap[from];
        if (target) {
            window.location.href = target;
        } else if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'Home.html';
        }
        return false;
    };
    document.addEventListener('DOMContentLoaded', function() {
        var params = new URLSearchParams(window.location.search);
        var from = (params.get('from') || '').toLowerCase();
        var link = document.getElementById('cart-empty-back-link');
        if (link) {
            link.href = fromMap[from] || 'Home.html';
        }
    });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ShAI avatar: set from DB when loaded. Call window.setShAIAvatar(url) from API response.
    const defaultShaiAvatar = 'https://raw.githubusercontent.com/nora-todorova/GoShopMe/main/assets/shai-avatar.png';
    window.setShAIAvatar = function(url) {
        window.__shaiAvatarUrl = url || defaultShaiAvatar;
        document.querySelectorAll('[data-shai-avatar]').forEach(function(img) { img.src = window.__shaiAvatarUrl; });
    };
    window.testShAIAvatar = function(url) {
        const testUrl = url || 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg';
        window.setShAIAvatar(testUrl);
        console.log('testShAIAvatar:', testUrl);
    };

    const chatDrawer = document.getElementById('chat-drawer');
    const chatOverlay = document.getElementById('chat-overlay');
    const chatInput = document.getElementById('message-input');
    const chatInputDrawer = document.getElementById('chat-input-drawer-field');
    const micBtn = document.getElementById('mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const micBtnDrawer = document.getElementById('mic-btn-drawer');
    const sendBtnDrawer = document.getElementById('send-btn-drawer');
    const chatInputBar = document.getElementById('chat-input-bar');
    const addFriendBtn = document.getElementById('add-friend-btn');
    const addFriendBtnDrawer = document.getElementById('add-friend-btn-drawer');
    const backBtn = document.getElementById('back-btn');
    const chatMessages = document.getElementById('chat-messages');
    const addFriendContent = document.getElementById('add-friend-content');
    const chatContent = document.getElementById('chat-content');
    const contactSearch = document.getElementById('contact-search');
    const contactsContainer = document.getElementById('contacts-container');
    const dragHandleZone = document.getElementById('drag-handle-zone') || document.getElementById('drag-handle');
    const smartPrompts = document.querySelectorAll('.smart-prompt');
    const camBtn = document.getElementById('cam-btn');
    const camBtnDrawer = document.getElementById('cam-btn-drawer');
    
    let isDrawerExpanded = true;
    let isAddFriendMode = false;
    let isDragging = false;
    let startY = 0;
    let currentHeight = 35;
    
    // Voice recording state
    let isRecording = false;
    let recordingStartX = 0;
    let recordingStartY = 0;
    let mediaRecorder = null;
    let recordingStartTime = null;
    let recordingStream = null;

    // Populate contacts
    const contacts = [
        { name: 'Alex Johnson', phone: '+1 (555) 123-4567', hasApp: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg' },
        { name: 'Maria Rodriguez', phone: '+1 (555) 987-6543', hasApp: false, initials: 'MR' },
        { name: 'David Kim', phone: '+1 (555) 456-7890', hasApp: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-3.jpg' },
        { name: 'Sarah Thompson', phone: '+1 (555) 234-5678', hasApp: false, initials: 'ST' },
        { name: 'Emma Wilson', phone: '+1 (555) 345-6789', hasApp: true, avatar: 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-5.jpg' },
        { name: 'Michael Brown', phone: '+1 (555) 678-9012', hasApp: false, initials: 'MB' }
    ];

    contacts.forEach(contact => {
        const contactDiv = document.createElement('div');
        contactDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-lg';
        contactDiv.innerHTML = `
            ${contact.hasApp ? 
                `<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                    <img src="${contact.avatar}" alt="${contact.name}" class="w-full h-full object-cover">
                </div>` :
                `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                    <span class="text-gray-600 font-medium text-xs">${contact.initials}</span>
                </div>`
            }
            <div class="flex-1 min-w-0">
                <p class="font-medium text-gray-900 text-sm truncate">${contact.name}</p>
                <p class="text-xs text-gray-500">${contact.phone}</p>
            </div>
            <button class="contact-action ${contact.hasApp ? 'bg-shine-primary text-white' : 'bg-white text-shine-primary border border-shine-primary'} px-3 py-1 rounded-full text-xs font-medium" data-name="${contact.name}" data-has-app="${contact.hasApp}">
                ${contact.hasApp ? 'Add' : 'Invite'}
            </button>
        `;
        contactsContainer.appendChild(contactDiv);
    });

    setTimeout(() => {
        expandDrawer();
    }, 500);

    function expandDrawer() {
        chatDrawer.classList.remove('translate-y-full');
        chatOverlay.classList.remove('hidden');
        chatInputBar.classList.add('hidden');
        isDrawerExpanded = true;
    }

    function collapseDrawer() {
        chatDrawer.classList.add('translate-y-full');
        chatOverlay.classList.add('hidden');
        chatInputBar.classList.remove('hidden');
        isDrawerExpanded = false;
        currentHeight = 35;
        chatDrawer.style.height = '50vh';
        if (isAddFriendMode) {
            hideAddFriendFlow();
        }
    }

    function showAddFriendFlow() {
        isAddFriendMode = true;
        chatContent.classList.add('hidden');
        addFriendContent.classList.remove('hidden');
        backBtn.classList.remove('hidden');
        
        if (!isDrawerExpanded) {
            expandDrawer();
        }
    }

    function hideAddFriendFlow() {
        isAddFriendMode = false;
        chatContent.classList.remove('hidden');
        addFriendContent.classList.add('hidden');
        backBtn.classList.add('hidden');
        
        if (contactSearch) {
            contactSearch.value = '';
            filterContacts('');
        }
    }

    function filterContacts(searchTerm) {
        const contactItems = contactsContainer.querySelectorAll('.flex.items-center');
        const term = searchTerm.toLowerCase();
        
        contactItems.forEach(item => {
            const name = item.querySelector('p').textContent.toLowerCase();
            const phone = item.querySelectorAll('p')[1].textContent.toLowerCase();
            
            if (name.includes(term) || phone.includes(term)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function autoResizeTextarea(textarea) {
        textarea.style.height = '24px';
        const scrollHeight = textarea.scrollHeight;
        const maxHeight = 96;
        
        if (scrollHeight <= maxHeight) {
            textarea.style.height = scrollHeight + 'px';
            textarea.style.overflowY = 'hidden';
        } else {
            textarea.style.height = maxHeight + 'px';
            textarea.style.overflowY = 'auto';
        }
    }

    function updateInputButtons(inputField, micButton, addFriendButton, sendButton) {
        if (inputField.value.trim()) {
            if (micButton) micButton.classList.add('hidden');
            if (addFriendButton) addFriendButton.classList.add('hidden');
            if (sendButton) sendButton.classList.remove('hidden');
        } else {
            if (micButton) micButton.classList.remove('hidden');
            if (addFriendButton) addFriendButton.classList.remove('hidden');
            if (sendButton) sendButton.classList.add('hidden');
        }
    }

    function sendMessage(input, isDrawer = false) {
        const message = input.value.trim();
        if (!message) return;
        
        const userMessage = document.createElement('div');
        userMessage.className = 'flex justify-end mb-2 animate-slide-in-right';
        userMessage.innerHTML = `
            <div class="bg-shine-primary text-white rounded-2xl rounded-tr-md p-2.5 max-w-[80%] break-words shadow-sm">
                <p class="text-sm">${message}</p>
            </div>
        `;
        chatMessages.appendChild(userMessage);
        
        input.value = '';
        autoResizeTextarea(input);
        
        if (isDrawer) {
            updateInputButtons(input, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer);
        } else {
            updateInputButtons(input, micBtn, addFriendBtn, sendBtn);
        }
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        setTimeout(() => {
            const avatarUrl = window.__shaiAvatarUrl || defaultShaiAvatar;
            const shaiResponse = document.createElement('div');
            shaiResponse.className = 'flex items-start space-x-3 mb-2 animate-slide-in-left';
            shaiResponse.innerHTML = `
                <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                    <img class="w-full h-full object-cover" src="${avatarUrl.replace(/"/g, '&quot;')}" alt="ShAI assistant avatar" data-shai-avatar />
                </div>
                <div class="flex-1">
                    <div class="bg-gray-50 rounded-2xl rounded-tl-md p-2.5 shadow-sm max-w-[80%]">
                        <p class="text-sm text-gray-900">Thanks for your message! I'm here to help you find the perfect items.</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(shaiResponse);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 1000);
    }

    // Voice Recording Functions
    async function requestMicrophonePermission() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => track.stop());
            return true;
        } catch (error) {
            console.error('Microphone permission denied:', error);
            return false;
        }
    }

    function showRecordingIndicator(micButton) {
        const indicator = document.createElement('div');
        indicator.id = 'recording-indicator';
        indicator.className = 'absolute -top-1 -right-1 w-2 h-2 bg-[#EF4444] rounded-full animate-pulse';
        micButton.appendChild(indicator);
        
        micButton.style.transform = 'scale(1.1)';
        micButton.classList.add('text-[#EF4444]');
    }

    function hideRecordingIndicator(micButton) {
        const indicator = document.getElementById('recording-indicator');
        if (indicator) {
            indicator.remove();
        }
        
        micButton.style.transform = 'scale(1)';
        micButton.classList.remove('text-[#EF4444]');
    }

    function showCancelledMessage() {
        const cancelMessage = document.createElement('div');
        cancelMessage.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-50 text-gray-700 px-4 py-2 rounded-full text-sm z-50 transition-opacity duration-300';
        cancelMessage.textContent = 'Recording cancelled';
        document.body.appendChild(cancelMessage);
        
        setTimeout(() => {
            cancelMessage.style.opacity = '0';
            setTimeout(() => {
                if (cancelMessage.parentNode) {
                    cancelMessage.parentNode.removeChild(cancelMessage);
                }
            }, 300);
        }, 2000);
    }

    async function startRecording(micButton, isDrawerInput = false) {
        if (isRecording) return;
        
        if (!isDrawerInput && !isDrawerExpanded) {
            expandDrawer();
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        const hasPermission = await requestMicrophonePermission();
        if (!hasPermission) {
            alert('Microphone access is required for voice messages.');
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recordingStream = stream;
            mediaRecorder = new MediaRecorder(stream);
            
            isRecording = true;
            recordingStartTime = Date.now();
            
            showRecordingIndicator(micButton);
            
            if (chatInput) chatInput.disabled = true;
            if (chatInputDrawer) chatInputDrawer.disabled = true;
            
            const audioChunks = [];
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                createVoiceMessage(audioBlob, duration);
                
                stream.getTracks().forEach(track => track.stop());
                hideRecordingIndicator(micButton);
                
                if (chatInput) chatInput.disabled = false;
                if (chatInputDrawer) chatInputDrawer.disabled = false;
                
                isRecording = false;
                recordingStream = null;
            };
            
            mediaRecorder.start();
            
        } catch (error) {
            console.error('Recording failed:', error);
            isRecording = false;
        }
    }

    function stopRecording(cancelled = false) {
        if (!isRecording || !mediaRecorder) return;
        
        if (cancelled) {
            mediaRecorder.stop();
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            showCancelledMessage();
        } else {
            mediaRecorder.stop();
        }
    }

    function createVoiceMessage(audioBlob, duration) {
        const audioUrl = URL.createObjectURL(audioBlob);
        
        const voiceMessage = document.createElement('div');
        voiceMessage.className = 'flex justify-end mb-2 animate-slide-in-right';
        voiceMessage.innerHTML = `
            <div class="voice-msg bg-shine-primary text-white rounded-2xl rounded-tr-md p-2.5 flex items-center gap-3 shadow-sm" style="height: 44px;">
                <button class="play-btn w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 transition-all" 
                        onclick="toggleVoicePlayback(this, '${audioUrl}', ${duration})">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </button>
                <div class="waveform flex-1 h-4 flex items-center justify-center gap-0.5">
                    ${Array.from({length: 12}, (_, i) => `<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300 ease-in-out" style="height: ${Math.random() * 60 + 40}%; --i: ${i};"></div>`).join('')}
                </div>
                <span class="text-xs font-medium text-white/90">${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}</span>
            </div>
        `;
        
        chatMessages.appendChild(voiceMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        setTimeout(() => {
            URL.revokeObjectURL(audioUrl);
        }, 10000);
    }

    window.toggleVoicePlayback = function(button, audioUrl, duration) {
        const audio = button.audio || new Audio(audioUrl);
        button.audio = audio;
        
        const voiceBubble = button.closest('.voice-msg');
        const waveBars = voiceBubble.querySelectorAll('.wave-bar');
        const isPlaying = !audio.paused;
        
        if (isPlaying) {
            audio.pause();
            button.innerHTML = `
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            `;
            
            waveBars.forEach(bar => {
                bar.classList.remove('playing');
            });
        } else {
            audio.play();
            button.innerHTML = `
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                </svg>
            `;
            
            waveBars.forEach((bar, index) => {
                bar.classList.add('playing');
                bar.style.animationDelay = `${index * 0.08}s`;
            });
        }
        
        audio.onended = () => {
            button.innerHTML = `
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            `;
            
            waveBars.forEach(bar => {
                bar.classList.remove('playing');
            });
        };
    };

    // Voice recording event handlers
    function handleMicPress(e, micButton, isDrawerInput = false) {
        e.preventDefault();
        e.stopPropagation();
        
        recordingStartX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        recordingStartY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        startRecording(micButton, isDrawerInput);
    }

    function handleMicMove(e, micButton) {
        if (!isRecording) return;
        
        const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const deltaX = recordingStartX - currentX;
        
        if (deltaX > 50) {
            stopRecording(true);
        }
    }

    function handleMicRelease(e, micButton) {
        if (!isRecording) return;
        
        const currentX = e.type.includes('touch') ? (e.changedTouches ? e.changedTouches[0].clientX : recordingStartX) : e.clientX;
        const deltaX = recordingStartX - currentX;
        
        if (deltaX <= 50) {
            stopRecording(false);
        }
    }

    // Camera/media handling
    function handleCameraAttach(isDrawerInput = false) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*,video/*';
        fileInput.capture = 'environment';
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!isDrawerInput && !isDrawerExpanded) {
                expandDrawer();
            }
            
            createMediaBubble(file);
        });
        
        fileInput.click();
    }

    function createMediaBubble(file) {
        const isVideo = file.type.startsWith('video/');
        const isImage = file.type.startsWith('image/');
        
        if (!isImage && !isVideo) return;

        const fileURL = URL.createObjectURL(file);
        
        const mediaBubble = document.createElement('div');
        mediaBubble.className = 'flex justify-end mb-2 animate-slide-in-right';
        mediaBubble.innerHTML = `
            <div class="msg-${isVideo ? 'video' : 'image'} border border-shine-primary rounded-2xl overflow-hidden shadow-sm max-w-[70%]">
                ${isImage ? 
                    `<img src="${fileURL}" alt="User uploaded image" class="object-cover w-full h-auto">` :
                    `<video src="${fileURL}" controls class="object-cover w-full h-auto"></video>`
                }
            </div>
        `;

        chatMessages.appendChild(mediaBubble);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        setTimeout(() => {
            URL.revokeObjectURL(fileURL);
        }, 10000);
    }

    // Smart prompts
    smartPrompts.forEach(prompt => {
        prompt.addEventListener('click', function() {
            const promptText = this.textContent.trim();
            
            const userMessage = document.createElement('div');
            userMessage.className = 'flex justify-end mb-2 animate-slide-in-right';
            userMessage.innerHTML = `
                <div class="bg-shine-primary text-white rounded-2xl rounded-tr-md p-2.5 max-w-[80%] break-words shadow-sm">
                    <p class="text-sm">${promptText}</p>
                </div>
            `;
            chatMessages.appendChild(userMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                const shaiResponse = document.createElement('div');
                shaiResponse.className = 'flex items-start space-x-3 mb-2 animate-slide-in-left';
                shaiResponse.innerHTML = `
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe/main/assets/shai-avatar.png" alt="ShAI assistant avatar" />
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-50 rounded-2xl rounded-tl-md p-2.5 shadow-sm max-w-[80%]">
                            <p class="text-sm text-gray-900">Great choice! Let me find some perfect ${promptText.toLowerCase()} options for you.</p>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(shaiResponse);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        });
    });

    // Event listeners
    if (backBtn) {
        backBtn.addEventListener('click', hideAddFriendFlow);
    }

    if (addFriendBtn) {
        addFriendBtn.addEventListener('click', showAddFriendFlow);
    }

    if (addFriendBtnDrawer) {
        addFriendBtnDrawer.addEventListener('click', showAddFriendFlow);
    }

    if (chatInput) {
        chatInput.addEventListener('focus', function() {
            if (!isDrawerExpanded) {
                expandDrawer();
                setTimeout(() => chatInputDrawer.focus(), 300);
            }
        });

        chatInput.addEventListener('input', function() {
            autoResizeTextarea(this);
            updateInputButtons(this, micBtn, addFriendBtn, sendBtn);
        });

        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(this, false);
            }
        });
    }

    if (chatInputDrawer) {
        chatInputDrawer.addEventListener('input', function() {
            autoResizeTextarea(this);
            updateInputButtons(this, micBtnDrawer, addFriendBtnDrawer, sendBtnDrawer);
        });

        chatInputDrawer.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(this, true);
            }
        });
    }

    if (sendBtn) {
        sendBtn.addEventListener('click', function() {
            sendMessage(chatInput, false);
        });
    }

    if (sendBtnDrawer) {
        sendBtnDrawer.addEventListener('click', function() {
            sendMessage(chatInputDrawer, true);
        });
    }

    if (contactSearch) {
        contactSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const contactItems = contactsContainer.querySelectorAll('.flex.items-center');
            
            contactItems.forEach(item => {
                const nameElement = item.querySelector('p');
                const phoneElement = item.querySelectorAll('p')[1];
                
                const name = nameElement ? nameElement.textContent.toLowerCase() : '';
                const phone = phoneElement ? phoneElement.textContent.toLowerCase().replace(/\D/g, '') : '';
                const searchPhone = searchTerm.replace(/\D/g, '');
                
                const matchesName = name.includes(searchTerm);
                const matchesPhone = phone.includes(searchPhone);
                
                if (matchesName || matchesPhone || searchTerm === '') {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    if (chatOverlay) {
        chatOverlay.addEventListener('click', collapseDrawer);
    }

    // Camera buttons
    if (camBtn) {
        camBtn.addEventListener('click', () => handleCameraAttach(false));
    }
    
    if (camBtnDrawer) {
        camBtnDrawer.addEventListener('click', () => handleCameraAttach(true));
    }

    // Mic buttons
    if (micBtn) {
        micBtn.addEventListener('mousedown', (e) => handleMicPress(e, micBtn, false));
        micBtn.addEventListener('touchstart', (e) => handleMicPress(e, micBtn, false));
        
        document.addEventListener('mousemove', (e) => handleMicMove(e, micBtn));
        document.addEventListener('touchmove', (e) => handleMicMove(e, micBtn));
        
        document.addEventListener('mouseup', (e) => handleMicRelease(e, micBtn));
        document.addEventListener('touchend', (e) => handleMicRelease(e, micBtn));
    }

    if (micBtnDrawer) {
        micBtnDrawer.addEventListener('mousedown', (e) => handleMicPress(e, micBtnDrawer, true));
        micBtnDrawer.addEventListener('touchstart', (e) => handleMicPress(e, micBtnDrawer, true));
        
        document.addEventListener('mousemove', (e) => handleMicMove(e, micBtnDrawer));
        document.addEventListener('touchmove', (e) => handleMicMove(e, micBtnDrawer));
        
        document.addEventListener('mouseup', (e) => handleMicRelease(e, micBtnDrawer));
        document.addEventListener('touchend', (e) => handleMicRelease(e, micBtnDrawer));
    }

    // Drag handle
    if (dragHandleZone) {
        dragHandleZone.addEventListener('mousedown', function(e) {
            isDragging = true;
            startY = e.clientY;
            e.preventDefault();
        });

        dragHandleZone.addEventListener('touchstart', function(e) {
            isDragging = true;
            startY = e.touches[0].clientY;
        }, { passive: true });
    }

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const deltaY = startY - e.clientY;
        const newHeight = Math.min(90, Math.max(35, currentHeight + (deltaY / window.innerHeight) * 100));
        chatDrawer.style.height = newHeight + 'vh';
    });

    document.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        
        const deltaY = startY - e.touches[0].clientY;
        const newHeight = Math.min(90, Math.max(35, currentHeight + (deltaY / window.innerHeight) * 100));
        chatDrawer.style.height = newHeight + 'vh';
    });

    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            const rect = chatDrawer.getBoundingClientRect();
            currentHeight = (rect.height / window.innerHeight) * 100;
        }
    });

    document.addEventListener('touchend', function() {
        if (isDragging) {
            isDragging = false;
            const rect = chatDrawer.getBoundingClientRect();
            currentHeight = (rect.height / window.innerHeight) * 100;
        }
    });
    document.addEventListener('touchcancel', function() {
        if (isDragging) {
            isDragging = false;
            const rect = chatDrawer.getBoundingClientRect();
            currentHeight = (rect.height / window.innerHeight) * 100;
        }
    });

    // Contact actions
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('contact-action')) {
            const contactName = e.target.getAttribute('data-name');
            const hasApp = e.target.getAttribute('data-has-app') === 'true';
            
            if (hasApp) {
                const notification = document.createElement('div');
                notification.className = 'flex justify-center mb-4';
                notification.innerHTML = `
                    <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">
                        ${contactName.split(' ')[0]} has been added to chat
                    </div>
                `;
                chatMessages.appendChild(notification);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                hideAddFriendFlow();
            } else {
                const shareData = {
                    title: 'Join me on GoShopMe',
                    text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless â€” join me",
                    url: 'https://app.goshopme.ai'
                };
                
                if (navigator.share) {
                    navigator.share(shareData);
                } else {
                    const shareText = `${shareData.text} ${shareData.url}`;
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Invite link copied to clipboard!');
                    });
                }
            }
        }
    });
});
</script>

</body>
</html>


/**
 * Inline ShAI chat init for Brand_Products - use when external script fails on mobile file://
 * This is the init logic only (chat HTML must exist in page)
 */
(function(){
  var SHAI_AVATAR='https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
  function run(){
    var d=document.getElementById('chat-drawer'),o=document.getElementById('chat-overlay'),b=document.getElementById('chat-input-bar');
    var m=document.getElementById('shai-messages'),mc=m?m.querySelector('.p-4'):null;
    var id=document.getElementById('shai-input-drawer'),sd=document.getElementById('shai-send-drawer'),md=document.getElementById('shai-mic-drawer'),ad=document.getElementById('shai-add-drawer'),cd=document.getElementById('shai-cam-drawer');
    var ib=document.getElementById('shai-input-bar'),sb=document.getElementById('shai-send-bar'),mb=document.getElementById('shai-mic-bar'),ab=document.getElementById('shai-add-bar'),cb=document.getElementById('shai-cam-bar');
    var dz=document.getElementById('drag-handle-zone');
    if(!d||!o||!b)return;
    var isOpen=false,isDrag=false,dY=0,dH=0,isRec=false,mr,ac=[],ms,micDeny=false,sX;
    function openD(){d.classList.remove('translate-y-full');o.classList.remove('hidden');b.classList.add('hidden');isOpen=true;document.body.style.overflow='hidden';}
    function closeD(){d.classList.add('translate-y-full');o.classList.add('hidden');b.classList.remove('hidden');isOpen=false;document.body.style.overflow='';}
    o.addEventListener('click',closeD);
    b.addEventListener('click',function(e){if(!e.target.closest('button'))openD();});
    function autoGrow(ta){ta.style.height='auto';ta.style.height=Math.min(ta.scrollHeight,144)+'px';}
    function upBtn(inp,send,mic,add){var h=inp.value.trim().length>0;send.classList.toggle('hidden',!h);mic.classList.toggle('hidden',h);add.classList.toggle('hidden',h);}
    [id,ib].forEach(function(ta,i){
      var s=i?sb:sd,mi=i?mb:md,a=i?ab:ad;
      if(!ta||!s||!mi||!a)return;
      ta.addEventListener('input',function(){autoGrow(ta);upBtn(ta,s,mi,a);});
      ta.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendTxt(ta,s,mi,a,i);}});
      s.addEventListener('click',function(){sendTxt(ta,s,mi,a,i);});
    });
    function scrollB(){if(m)m.scrollTop=m.scrollHeight;}
    function shaiR(t){if(!mc)return;var el=document.createElement('div');el.className='flex items-start space-x-3 mb-4';el.innerHTML='<div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0"><img class="w-full h-full object-cover" src="'+SHAI_AVATAR+'" alt="ShAI"></div><div class="flex-1"><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3"><p class="text-sm text-black">'+(t||'').replace(/</g,'&lt;')+'</p></div></div>';mc.appendChild(el);scrollB();}
    function sendTxt(ta,send,mic,add,openA){var t=ta.value.trim();if(!t||!mc)return;if(openA)openD();var el=document.createElement('div');el.className='flex justify-end mb-4';el.innerHTML='<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm break-words whitespace-pre-wrap"></p></div>';el.querySelector('p').textContent=t;mc.appendChild(el);ta.value='';autoGrow(ta);upBtn(ta,send,mic,add);scrollB();setTimeout(function(){shaiR("Perfect! Let me help you find exactly what you're looking for.");},1000);}
    document.querySelectorAll('.shai-prompt').forEach(function(btn){btn.addEventListener('click',function(){openD();if(!mc)return;var el=document.createElement('div');el.className='flex justify-end mb-4';el.innerHTML='<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm break-words whitespace-pre-wrap"></p></div>';el.querySelector('p').textContent=btn.textContent.trim();mc.appendChild(el);scrollB();setTimeout(function(){shaiR("Great choice! I'll find the best options for you right away.");},800);});});
    function pickF(openF){if(openF)openD();var inp=document.createElement('input');inp.type='file';inp.accept='image/*,video/*';inp.onchange=function(e){var f=e.target.files&&e.target.files[0];if(!f||!mc)return;var u=URL.createObjectURL(f),el=document.createElement('div');el.className='flex justify-end mb-4';el.innerHTML=f.type.startsWith('image/')?'<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><img src="'+u+'" class="w-full h-auto"></div>':'<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><video src="'+u+'" controls class="w-full h-auto"></video></div>';mc.appendChild(el);scrollB();setTimeout(function(){shaiR(f.type.startsWith('image/')?"I can see your image! Let me find similar products for you.":"Got your video! Let me analyze it and find matching products.");},1500);};inp.click();}
    if(cd)cd.addEventListener('click',function(){pickF(false);});if(cb)cb.addEventListener('click',function(){pickF(true);});
    function setupMic(btn){btn.addEventListener('mousedown',startR);btn.addEventListener('touchstart',startR,{passive:false});btn.addEventListener('mouseup',stopR);btn.addEventListener('touchend',stopR);btn.addEventListener('mouseleave',cancelR);btn.addEventListener('touchcancel',cancelR);btn.addEventListener('touchmove',function(e){if(!isRec||!e.touches)return;if(sX-e.touches[0].clientX>30)cancelR.call(btn,e);});}
    if(md)setupMic(md);if(mb)setupMic(mb);
    async function startR(e){e.preventDefault();if(!isOpen){openD();return;}if(micDeny){showT('Microphone access denied.');return;}sX=e.touches?e.touches[0].clientX:e.clientX;var t=document.getElementById('shai-temp-rec');if(t)t.remove();try{if(!ms||!ms.active)ms=await navigator.mediaDevices.getUserMedia({audio:true});mr=new MediaRecorder(ms);isRec=true;ac=[];mr.ondataavailable=function(ev){if(ev.data.size>0)ac.push(ev.data);};mr.start();this.classList.add('scale-110','ring-2','ring-[#939BFB]','ring-offset-2');if(mc){var tb=document.createElement('div');tb.id='shai-temp-rec';tb.className='flex justify-end mb-2';tb.innerHTML='<div class="flex items-center bg-[#939BFB] text-white rounded-2xl px-3 py-2 max-w-[70%]"><span class="text-xs">Recording... swipe left to cancel</span></div>';mc.appendChild(tb);scrollB();}}catch(err){var t2=document.getElementById('shai-temp-rec');if(t2)t2.remove();if(err.name==='NotAllowedError'){micDeny=true;showT('Microphone access denied.');}else showT('Could not access microphone.');}}
    function stopR(e){e.preventDefault();if(!isRec)return;isRec=false;this.classList.remove('scale-110','ring-2','ring-[#939BFB]','ring-offset-2');var t=document.getElementById('shai-temp-rec');if(t)t.remove();if(mr){mr.stop();mr.onstop=function(){var blob=new Blob(ac,{type:'audio/webm'});var u=URL.createObjectURL(blob),el=document.createElement('div');el.className='flex justify-end mb-2';el.innerHTML='<div class="voice-message-bubble bg-[#939BFB] text-white rounded-full px-3 py-2 flex items-center gap-2 h-11"><button class="play-btn w-6 h-6 border border-white rounded-full flex items-center justify-center" onclick="window._shaiPlay(this,\''+u+'\')"><svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button><span class="text-xs">0:00</span><audio src="'+u+'" preload="auto" class="hidden"></audio></div>';mc.appendChild(el);scrollB();setTimeout(function(){shaiR("Got your voice message!");},800);};}}
    function cancelR(e){if(!isRec)return;isRec=false;this.classList.remove('scale-110','ring-2','ring-[#939BFB]','ring-offset-2');var t=document.getElementById('shai-temp-rec');if(t)t.remove();if(mr&&mr.state!=='inactive')mr.stop();}
    window._shaiPlay=function(btn,url){var wrap=btn.closest('.voice-message-bubble'),audio=wrap.querySelector('audio');if(audio.paused){audio.play();btn.querySelector('svg').innerHTML='<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';}else{audio.pause();btn.querySelector('svg').innerHTML='<path d="M8 5v14l11-7z"/>';}};
    if(dz){dz.addEventListener('touchstart',function(e){isDrag=true;dY=e.touches[0].clientY;dH=d.getBoundingClientRect().height;d.style.transition='none';},{passive:true});dz.addEventListener('touchmove',function(e){if(!isDrag)return;e.preventDefault();var bo=parseFloat(getComputedStyle(d).bottom)||64,maxH=window.innerHeight-bo-80,newH=Math.max(80,Math.min(maxH,dH-(e.touches[0].clientY-dY)));d.style.height=newH+'px';},{passive:false});function endD(){if(!isDrag)return;isDrag=false;d.style.transition='';if(d.getBoundingClientRect().height/window.innerHeight*100<25)closeD();}dz.addEventListener('touchend',endD,{passive:true});dz.addEventListener('touchcancel',endD,{passive:true});}
    var fp=document.getElementById('shai-friend-panel'),fb=document.getElementById('shai-friend-back'),fs=document.getElementById('shai-friend-search'),fl=document.getElementById('shai-friend-list'),isF=false;
    window.__addFriendContacts=window.__addFriendContacts||[{name:'Alex Johnson',phone:'+1 555 123-4567',goshopme:true},{name:'Maria Rodriguez',phone:'+1 555 987-6543',goshopme:false}];
    function getIn(n){var p=(n||'').trim().split(/\s+/);return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():(p[0]?p[0].slice(0,2):'??').toUpperCase();}
    function renderF(q){if(!fl)return;var list=(window.__addFriendContacts||[]).filter(function(c){if(!q)return true;return(c.name||'').toLowerCase().indexOf((q||'').toLowerCase())>=0;});fl.innerHTML=list.length?list.map(function(c,i){return'<div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-idx="'+i+'"><div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"><span class="text-xs font-medium">'+getIn(c.name)+'</span></div><div class="flex-1"><p class="font-medium text-sm">'+(c.name||'')+'</p></div><button class="shai-friend-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs">Add</button></div>';}).join(''):'<div class="text-center text-sm text-gray-400 py-8">No contacts</div>';fl.querySelectorAll('.shai-friend-action').forEach(function(btn){btn.addEventListener('click',function(){var idx=parseInt(btn.closest('[data-idx]').getAttribute('data-idx'),10),c=list[idx];if(mc&&c){var n=document.createElement('div');n.className='flex justify-center mb-4';n.innerHTML='<div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs">'+(c.name||'').split(' ')[0]+' added</div>';mc.appendChild(n);scrollB();}hideF();});});}
    function showF(){isF=true;if(!isOpen)openD();if(m)m.classList.add('hidden');if(fp){fp.classList.remove('hidden');fp.classList.add('flex');}if(fb)fb.classList.remove('hidden');if(fs)fs.value='';renderF('');}
    function hideF(){isF=false;if(m)m.classList.remove('hidden');if(fp){fp.classList.add('hidden');fp.classList.remove('flex');}if(fb)fb.classList.add('hidden');}
    if(fb)fb.addEventListener('click',hideF);if(fs)fs.addEventListener('input',function(){renderF(fs.value);});if(ad)ad.addEventListener('click',showF);if(ab)ab.addEventListener('click',showF);
    function showT(msg){var t=document.createElement('div');t.style.cssText='position:fixed;bottom:120px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 16px;border-radius:20px;font-size:13px;z-index:9999';t.textContent=msg;document.body.appendChild(t);setTimeout(function(){t.remove();},2500);}
    if(!document.getElementById('shai-wave-css')){var s=document.createElement('style');s.id='shai-wave-css';s.textContent='@keyframes shaiWave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(2)}}';document.head.appendChild(s);}
  }
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',run);else run();
})();

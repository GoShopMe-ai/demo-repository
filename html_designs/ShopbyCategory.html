<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
 <meta name="mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <link rel="stylesheet" href="css/mobile-optimization.css">
 <title>Shop by Category - GoShopMe</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="css/chat-drawer-drag.css">
 <script>
 tailwind.config = {
 theme: {
 extend: {
  colors: {
  'shine-primary': '#939BFB',
  'shine-accent': '#F96226'
  },
  fontFamily: {
  'poppins': ['Poppins', 'sans-serif'],
  'dm-sans': ['DM Sans', 'sans-serif']
  }
 }
 }
 }
 </script>
 <script src="https://unpkg.com/heroicons@2.0.16/24/outline/index.js"></script>
 <style>
 
/* ---- MOBILE FULL-WIDTH OVERRIDE (match Home) ---- */
@media screen and (max-width: 768px) {
  #app-shell, #main-content, #auth-screen, #welcome_screen, #quiz-screen, #onboarding-screen,
  #bottom-nav, #bottom-navigation, #header, #app-header,
  #chat-drawer, #chat-input-bar, #shai-chat-drawer, #return-chat-drawer, #return-chat-input-bar, #chat-input-collapsed,
  #shai-chat-drawer-wrapper, #chat-drawer-wrapper,
  body > div, body > main {
    max-width: 100vw !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    box-shadow: none !important;
    left: 0 !important;
    right: 0 !important;
    transform: none !important;
  }
  [class*="left-1/2"][class*="-translate-x-1/2"]:not([class*="rounded-full"]) {
    left: 0 !important;
    right: 0 !important;
    max-width: 100vw !important;
    width: 100% !important;
    transform: none !important;
  }
  #chat-drawer.translate-y-full, #shai-chat-drawer.translate-y-full, #return-chat-drawer.translate-y-full {
    transform: translateY(100%) !important;
  }
  #bottom-nav > div, #bottom-navigation > div, nav#bottom-nav > div, nav#bottom-navigation > div {
    padding-top: 2px !important;
    padding-bottom: 24px !important;
  }
}

::-webkit-scrollbar { display: none; }
 .dm-sans { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; }
 .poppins { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
 .share-icon-tilted { transform: rotate(-35deg); }
 .icon-button svg { width: 18px; height: 18px; stroke-width: 1.5; }
 .icon-button:hover svg { color: #939BFB; }
 .bottom-nav-btn { display: flex; flex-direction: column; align-items: center; color: #6B7280; transition: color 0.2s ease-in-out; }
 .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #939BFB; }
 .bottom-nav-btn:hover svg, .bottom-nav-btn:hover span, .bottom-nav-btn.active svg, .bottom-nav-btn.active span { color: inherit; }
 .bottom-nav-btn svg { width: 20px; height: 20px; stroke-width: 1.5; }
 .chat-input-action.typing-hidden, .chat-input-action-collapsed.typing-hidden { display: none !important; }
 .chat-input-send.typing-visible, .chat-input-send-collapsed.typing-visible { display: block !important; }
 .voice-message-bubble { min-width: 140px; max-width: 260px; width: fit-content; }
 @keyframes wavePulse { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
 .wave-bar.playing { animation: wavePulse 1.1s ease-in-out infinite; animation-delay: calc(var(--i) * 0.08s); }
 /* Category tiles: pointer cursor (desktop), touch-optimized (mobile) */
 .category-card { cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: rgba(147, 155, 251, 0.12); }
 #notif-badge.hidden, #cart-badge.hidden { display: none !important; }
 </style>
</head>
<body class="bg-[#F6F6F6] dm-sans">
 <div class="max-w-[390px] mx-auto relative min-h-screen bg-white shadow-2xl">
 <!-- App Header -->
 <header id="app-header" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white z-40 border-b border-gray-100">
 <div class="px-4 py-3">
 <div class="relative flex items-center justify-between">
  <a href="Home.html" class="relative z-10 text-gray-600 hover:text-gray-900 transition-colors" aria-label="Back">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
  </svg>
  </a>
  <h1 class="absolute left-0 right-0 text-center text-lg font-semibold poppins text-gray-900 pointer-events-none">Shop by Category</h1>
  <div class="relative z-10 flex items-center gap-0">
  <a href="Notifications_Screen.html?from=category" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Notifications">
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/>
  </svg>
  <span id="notif-badge" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 bg-shine-accent rounded-full hidden flex items-center justify-center">
  <span id="notif-count" class="text-[10px] text-white font-medium leading-none"></span>
  </span>
  </a>
  <a href="Shopping_bag.html?from=category" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 transition-colors relative overflow-visible" aria-label="Shopping bag">
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"/>
  </svg>
  <span id="cart-badge" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] px-1 bg-shine-primary rounded-full hidden flex items-center justify-center">
  <span id="cart-count" class="text-[10px] text-white font-medium leading-none"></span>
  </span>
  </a>
  </div>
 </div>
 </div>
 </header>

 <!-- Main Content Container -->
 <main id="main-content" class="pt-20 px-4 pb-40 relative">
 
 <!-- Background Content -->
 <div id="background-content" class="min-h-screen">
 
 <!-- Hero Section (dynamic) -->
 <section id="hero-section" class="relative h-64 overflow-hidden">
  <div id="hero-content" class="w-full h-full flex items-center justify-center bg-gray-200">
  <div class="animate-pulse text-gray-400 text-sm dm-sans">Loading...</div>
  </div>
 </section>

 <!-- Category Grid Section (dynamic) -->
 <section id="category-grid" class="px-4 py-8">
  <div id="category-grid-inner">
  <div class="grid grid-cols-2 gap-4" id="category-grid-list">
  <!-- Categories rendered dynamically -->
  </div>
  </div>
 </section>

 </div>

 <!-- Chat Drawer Overlay -->
 <div id="chat-overlay" class="fixed inset-0 bg-black/40 z-40 transition-opacity duration-300"></div>

 <!-- ShAI Chat Drawer (same layer as nav, docked above it, in front of header) -->
 <div id="shai-chat-drawer-wrapper" class="fixed bottom-14 left-1/2 -translate-x-1/2 w-full max-w-[390px] z-50">
 <div id="shai-chat-drawer" class="w-full bg-white rounded-t-3xl shadow-2xl transform transition-transform duration-300 ease-out h-[50vh] flex flex-col">
 
 <!-- Drag Handle -->
 <div id="drag-handle-zone" class="chat-drawer-drag-zone flex justify-center mt-2 mb-3 flex-shrink-0">
  <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full flex-shrink-0 pointer-events-none"></div>
 </div>
 
 <!-- Drawer Header -->
 <div id="drawer-header" class="flex items-center px-4 pb-4 border-b border-gray-100 flex-shrink-0">
  <button id="back-button" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hidden hover:opacity-70 transition-opacity mr-3">
  <svg class="w-[18px] h-[18px] text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
  </svg>
  </button>
  <div id="shai-avatar-container" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
  <span id="shai-avatar-placeholder" class="text-gray-600 dm-sans font-medium text-xs">AI</span>
  <img id="shai-avatar" class="w-full h-full object-cover rounded-full" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar />
  </div>
  <div class="ml-3">
  <h4 class="font-semibold text-sm text-black poppins">ShAI</h4>
  <p class="text-xs text-gray-500 dm-sans">Your AI Personal Shopper</p>
  </div>
 </div>

 <!-- Chat Content Wrapper -->
 <div id="chat-messages-scroll" class="flex-1 overflow-y-auto relative min-h-0">
  <!-- Chat Messages -->
  <div id="chat-messages" class="p-4">
  <!-- ShAI Greeting -->
  <div class="flex items-start space-x-3 mb-4">
  <div class="shai-msg-avatar-wrap w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 overflow-hidden">
  <span class="text-gray-600 dm-sans font-medium text-xs">AI</span>
  </div>
  <div class="bg-gray-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs">
  <p class="text-sm text-black dm-sans break-words whitespace-pre-wrap">Looking for something specific? Let me help you find the perfect pieces!</p>
  </div>
  </div>

  <!-- Smart Prompt Chips -->
  <div class="flex flex-wrap gap-2 mb-4 ml-11">
  <button class="px-3 py-1.5 bg-white text-shine-primary border border-[#B7C7FF] rounded-full text-xs font-medium dm-sans hover:bg-shine-primary hover:text-white transition-colors">
  Vacation Edit
  </button>
  <button class="px-3 py-1.5 bg-white text-shine-primary border border-[#B7C7FF] rounded-full text-xs font-medium dm-sans hover:bg-shine-primary hover:text-white transition-colors">
  Date Night
  </button>
  <button class="px-3 py-1.5 bg-white text-shine-primary border border-[#B7C7FF] rounded-full text-xs font-medium dm-sans hover:bg-shine-primary hover:text-white transition-colors">
  Under $100
  </button>
  <button class="px-3 py-1.5 bg-white text-shine-accent border border-[#B7C7FF] rounded-full text-xs font-medium dm-sans hover:bg-shine-accent hover:text-white transition-colors">
  Workwear Looks
  </button>
  </div>
  </div>

  <!-- Add Friend Contact List View -->
  <div id="add-friend-view" class="hidden p-4">
  <!-- Search Bar -->
  <div class="mb-4">
  <div class="flex items-center bg-gray-50 rounded-xl px-4 py-2 pl-10 border border-gray-200 relative">
  <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
   <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
  </svg>
  <input type="text" placeholder="Search contacts..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 text-sm dm-sans" id="contact-search">
  </div>
  </div>

  <!-- Contact List (dynamic: goshopmeâ†’Add+avatar, non-goshopmeâ†’Invite+initials) -->
  <div id="contact-list" class="space-y-2">
  <!-- Rendered by renderAddFriendContacts() -->
  </div>
  </div>
 </div>

 <!-- Chat Input Bar - Inside Drawer -->
 <div class="bg-white border-t border-gray-100 p-4 flex-shrink-0 min-w-0 overflow-hidden">
  <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
  <button id="cam-btn-drawer" class="icon-button hover:opacity-70 transition-opacity flex-shrink-0" aria-label="Camera">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/>
  </svg>
  </button>
  <textarea placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans resize-none min-h-[24px] max-h-[144px] overflow-y-auto py-0" id="chat-input-drawer" rows="1"></textarea>
  <button id="add-friend-button" class="icon-button hover:opacity-70 transition-opacity chat-input-action" aria-label="Add friend">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
  </svg>
  </button>
  <button id="mic-button-drawer" class="icon-button hover:opacity-70 transition-opacity chat-input-action" aria-label="Microphone">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
  </svg>
  </button>
  <button id="send-button-drawer" class="text-shine-primary hidden hover:opacity-70 transition-opacity chat-input-send" aria-label="Send">
  <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
  </svg>
  </button>
  </div>
 </div>
 </div>
 </div>

 <!-- Chat Input Bar - Collapsed State (same layer as nav, docked above it) -->
 <div id="chat-input-collapsed" class="fixed bottom-14 left-1/2 -translate-x-1/2 w-full max-w-[390px] z-50 p-4 bg-white border-t border-gray-100 hidden min-w-0 overflow-hidden">
 <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm min-w-0 w-full overflow-hidden">
  <button id="cam-btn" class="icon-button hover:opacity-70 transition-opacity flex-shrink-0" aria-label="Camera">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/>
  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/>
  </svg>
  </button>
  <textarea placeholder="Message ShAI..." class="flex-1 min-w-0 max-w-full bg-transparent outline-none text-black placeholder-gray-500 dm-sans resize-none min-h-[24px] max-h-[144px] overflow-y-auto py-0" id="chat-input-collapsed-field" rows="1"></textarea>
  <button id="add-friend-button-collapsed" class="icon-button hover:opacity-70 transition-opacity chat-input-action-collapsed" aria-label="Add friend">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/>
  </svg>
  </button>
  <button id="mic-button-collapsed" class="icon-button hover:opacity-70 transition-opacity chat-input-action-collapsed" aria-label="Microphone">
  <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
  </svg>
  </button>
  <button id="send-button-collapsed" class="text-shine-primary hidden hover:opacity-70 transition-opacity chat-input-send-collapsed" aria-label="Send">
  <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/>
  </svg>
  </button>
 </div>
 </div>

 </main>

 <!-- Bottom Navigation (always visible, not part of drawer) -->
 <nav id="bottom-navigation" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 z-50">
 <div class="flex items-center justify-around py-2">
 <a href="Home.html" class="bottom-nav-btn flex flex-col items-center py-1 px-3 text-gray-500 hover:text-shine-primary transition-colors">
  <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
  </svg>
  <span class="text-xs dm-sans">Home</span>
 </a>
 <a href="Picks.html" class="bottom-nav-btn flex flex-col items-center py-1 px-3 text-gray-500 hover:text-shine-primary transition-colors">
  <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/>
  </svg>
  <span class="text-xs dm-sans">Picks</span>
 </a>
 <a href="Wishlist.html" class="bottom-nav-btn flex flex-col items-center py-1 px-3 text-gray-500 hover:text-shine-primary transition-colors">
  <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
  <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
  </svg>
  <span class="text-xs dm-sans">Wishlist</span>
 </a>
 <a id="shop-category-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn flex flex-col items-center py-1 px-3 text-gray-500 hover:text-shine-primary transition-colors">
  <span class="flex items-center justify-center w-6 h-6 mb-1 text-shine-primary">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
  </span>
  <span class="text-xs dm-sans">Profile</span>
 </a>
 </div>
 </nav>

 <script>
 (function() {
 var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
 var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
 var link = document.getElementById('shop-category-nav-profile-link');
 if (link) link.href = profileHref;
 })();
 </script>
 <script>
 document.addEventListener('DOMContentLoaded', function() {
 // --- Shop by Category API / Data Layer ---
 // Expected API response from /api/shop-by-category:
 // {
 // hero: { mediaType: 'image'|'video', imageUrl?, videoUrl?, title, alt?, posterUrl? },
 // categories: [ { id, name, imageUrl, alt?, badge? } ]
 // }
 // Set window.GOSHOPME_API_BASE_URL before load to use your API (e.g. 'https://api.example.com')
 const ShopByCategoryAPI = {
  baseUrl: window.GOSHOPME_API_BASE_URL || '/api',
  endpoints: { pageData: '/shop-by-category' },
  fallbackDataUrls: ['data/shop-by-category.json', './data/shop-by-category.json'],
  async fetchPageData() {
  try {
  const res = await fetch(this.baseUrl + this.endpoints.pageData);
  if (!res.ok) throw new Error('API returned ' + res.status);
  const json = await res.json();
  return json.data || json.result || json;
  } catch (err) {
  for (const url of this.fallbackDataUrls) {
  try {
   const res = await fetch(url);
   if (res.ok) {
   const json = await res.json();
   return json.data || json.result || json;
   }
  } catch (e) { /* try next */ }
  }
  console.warn('Shop by Category: API unavailable, using inline fallback.', err);
  return null;
  }
  }
 };

 const fallbackData = {
  hero: {
  mediaType: 'image',
  imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/679e3cd9c0-57bff49eadf03dd76c2d.png',
  videoUrl: null,
  posterUrl: null,
  title: 'Explore by Category',
  alt: 'fashion shopping aesthetic minimalist hero background with soft colors and elegant styling'
  },
  categories: [
  { id: 'shoes', name: 'Shoes', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shoes%201.jpg', alt: 'Shoes', badge: null },
  { id: 'dresses', name: 'Dresses', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/dresses.jpg', alt: 'Dresses', badge: null },
  { id: 'bags', name: 'Bags', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/bags.jpg', alt: 'Bags', badge: null },
  { id: 'workwear', name: 'Workwear', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Workwear.jpg', alt: 'Workwear', badge: null },
  { id: 'swimwear', name: 'Swimwear', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/swimwear%201.jpg', alt: 'Swimwear', badge: null },
  { id: 'beauty', name: 'Beauty', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/fe64037ddd-2c7840117cc2911d537b.png', alt: 'Beauty', badge: null },
  { id: 'wellness', name: 'Wellness', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/Wellness.jpg', alt: 'Wellness', badge: null },
  { id: 'sale', name: 'Sale', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/179cee2d51-68640f3705cf734d5d3e.png', alt: 'Sale', badge: 'Up to 50% off' }
  ]
 };

 function renderHeroSection(data) {
  const hero = data?.hero || fallbackData.hero;
  const container = document.getElementById('hero-content');
  if (!container) return;
  const mediaType = hero.mediaType || (hero.videoUrl ? 'video' : 'image');
  const mediaHtml = mediaType === 'video' && hero.videoUrl
  ? `<video class="absolute inset-0 w-full h-full object-cover" src="${escapeHtml(hero.videoUrl)}" poster="${escapeHtml(hero.posterUrl || hero.imageUrl || '')}" playsinline muted loop autoplay></video>`
  : `<img class="absolute inset-0 w-full h-full object-cover" src="${escapeHtml(hero.imageUrl || '')}" alt="${escapeHtml(hero.alt || '')}" loading="eager" />`;
  container.innerHTML = `
  ${mediaHtml}
  <div class="absolute inset-0 bg-black/20"></div>
  <div class="absolute inset-0 flex items-center justify-center">
  <h2 class="text-2xl font-semibold poppins text-white text-center">${escapeHtml(hero.title || 'Explore by Category')}</h2>
  </div>
  `;
  container.classList.remove('bg-gray-200');
  container.classList.add('relative');
 }

 function renderCategoryGrid(categories) {
  const list = categories || fallbackData.categories;
  const grid = document.getElementById('category-grid-list');
  if (!grid) return;

  grid.innerHTML = list.map(function(cat) {
  const badge = cat.badge ? `<div class="absolute top-3 right-3 bg-shine-accent text-white px-2 py-1 rounded-full text-xs font-medium dm-sans">${escapeHtml(cat.badge)}</div>` : '';
  const badgeClass = cat.badge ? ' relative' : '';
  const shoesPos = cat.id === 'shoes' ? ' object-[center_75%]' : '';
  const workwearPos = cat.id === 'workwear' ? ' object-top' : '';
  return `
  <div class="category-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow cursor-pointer${badgeClass}" data-category-id="${escapeHtml(cat.id || '')}" data-category-name="${escapeHtml(cat.name || '')}">
  <div class="aspect-square p-6 flex items-center justify-center bg-gray-50">
   <img class="w-24 h-24 object-contain${shoesPos}${workwearPos}" src="${escapeHtml(cat.imageUrl || '')}" alt="${escapeHtml(cat.alt || cat.name || '')}" loading="lazy" />
  </div>
  ${badge}
  <div class="p-4 text-center">
   <h3 class="text-sm font-semibold poppins text-gray-900">${escapeHtml(cat.name || '')}</h3>
  </div>
  </div>
  `;
  }).join('');
 }

 function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
 }

 async function loadShopByCategoryData() {
  const heroContainer = document.getElementById('hero-content');
  const gridEl = document.getElementById('category-grid-list');
  if (heroContainer) heroContainer.innerHTML = '<div class="animate-pulse text-gray-400 text-sm dm-sans">Loading...</div>';
  if (gridEl) gridEl.innerHTML = Array(8).fill('<div class="bg-white rounded-2xl border border-gray-100 overflow-hidden"><div class="aspect-square p-6 bg-gray-100 animate-pulse"></div><div class="p-4"><div class="h-4 rounded bg-gray-100 animate-pulse mx-auto" style="width:60%"></div></div></div>').join('');

  let data = null;
  const isFileProtocol = typeof location !== 'undefined' && location.protocol === 'file:';
  if (!isFileProtocol) {
  try {
  data = await ShopByCategoryAPI.fetchPageData();
  } catch (e) {
  console.warn('Shop by Category: load failed', e);
  }
  }
  if (!data) data = { ...fallbackData };
  if (!data.hero) data.hero = fallbackData.hero;
  else data.hero = { ...fallbackData.hero, ...data.hero };
  if (!data.categories || !data.categories.length) data.categories = fallbackData.categories;

  renderHeroSection(data);
  renderCategoryGrid(data.categories);
 }

 // --- Badge counts (notifications, cart) ---
 const BadgeAPI = {
  baseUrl: window.GOSHOPME_API_BASE_URL || '/api',
  lsKey: { notif: 'goshopme_notif_count', cart: 'goshopme_cart_count' },
  async fetchCounts() {
  let unread = 0, cart = 0;
  try {
  const [notifRes, cartRes] = await Promise.all([
  fetch(this.baseUrl + '/users/me/notifications/unread-count').catch(() => null),
  fetch(this.baseUrl + '/cart').catch(() => null)
  ]);
  if (notifRes && notifRes.ok) {
  const j = await notifRes.json();
  unread = j.count ?? j.unread ?? j.unreadCount ?? 0;
  }
  if (cartRes && cartRes.ok) {
  const j = await cartRes.json();
  const items = j.items ?? j.cart?.items ?? [];
  cart = Array.isArray(items) ? items.reduce((s, i) => s + (i.quantity ?? 1), 0) : 0;
  }
  } catch (e) { /* use fallback */ }
  if (unread === 0 && cart === 0) {
  unread = parseInt(localStorage.getItem(this.lsKey.notif) || '0', 10);
  cart = parseInt(localStorage.getItem(this.lsKey.cart) || '0', 10);
  }
  return { unread, cart };
  },
  setFallback(unread, cart) {
  if (unread != null) localStorage.setItem(this.lsKey.notif, String(unread));
  if (cart != null) localStorage.setItem(this.lsKey.cart, String(cart));
  }
 };

 function updateBadges(unread, cart) {
  const notifBadge = document.getElementById('notif-badge');
  const notifCount = document.getElementById('notif-count');
  const cartBadge = document.getElementById('cart-badge');
  const cartCount = document.getElementById('cart-count');
  if (notifBadge && notifCount) {
  notifBadge.classList.toggle('hidden', !(unread > 0));
  notifBadge.classList.toggle('flex', unread > 0);
  notifCount.textContent = unread > 99 ? '99+' : String(unread);
  }
  if (cartBadge && cartCount) {
  cartBadge.classList.toggle('hidden', !(cart > 0));
  cartBadge.classList.toggle('flex', cart > 0);
  cartCount.textContent = cart > 99 ? '99+' : String(cart);
  }
  BadgeAPI.setFallback(unread, cart);
 }

 async function loadBadgeCounts() {
  const { unread, cart } = await BadgeAPI.fetchCounts();
  updateBadges(unread, cart);
 }

 // Expose for testing: window.testBadges(unread, cart)
 window.testBadges = function(unread, cart) {
  updateBadges(unread ?? 5, cart ?? 3);
 };
 window.resetBadges = function() {
  updateBadges(0, 0);
  console.log('resetBadges');
 };

 // ShAI avatar: set from DB when loaded. Updates header AND all chat message avatars.
 window.__shaiAvatarUrl = window.__shaiAvatarUrl || '';
 function getShaiAvatarHtml() {
  const url = window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
  const base = 'w-8 h-8 rounded-full overflow-hidden flex-shrink-0 flex items-center justify-center bg-gray-200';
  return url
  ? `<div class="shai-msg-avatar-wrap ${base}"><img class="w-full h-full object-cover" src="${url.replace(/"/g, '&quot;')}" alt="ShAI avatar" onerror="this.parentElement.innerHTML='<span class=\\'text-gray-600 dm-sans font-medium text-xs\\'>AI</span>'"></div>`
  : `<div class="shai-msg-avatar-wrap ${base}"><span class="text-gray-600 dm-sans font-medium text-xs">AI</span></div>`;
 }
 function updateAllShaiMsgAvatars() {
  document.querySelectorAll('.shai-msg-avatar-wrap').forEach(wrap => {
  const url = window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
  wrap.innerHTML = url ? `<img class="w-full h-full object-cover" src="${url.replace(/"/g, '&quot;')}" alt="ShAI avatar" onerror="this.parentElement.innerHTML='<span class=\\'text-gray-600 dm-sans font-medium text-xs\\'>AI</span>'">` : '<span class="text-gray-600 dm-sans font-medium text-xs">AI</span>';
  });
 }
 window.setShAIAvatar = function(url) {
  window.__shaiAvatarUrl = url || '';
  const img = document.getElementById('shai-avatar');
  const ph = document.getElementById('shai-avatar-placeholder');
  if (url && img) { img.src = url; img.classList.remove('hidden'); img.dataset.placeholder = 'false'; if (ph) ph.classList.add('hidden'); }
  else if (!url && img && ph) { img.src = ''; img.classList.add('hidden'); img.dataset.placeholder = 'true'; ph.classList.remove('hidden'); }
  updateAllShaiMsgAvatars();
 };

 // Expose for testing: window.testShAIAvatar(url) - simulates DB/API avatar load. Pass URL or use default.
 window.testShAIAvatar = function(url) {
  const testUrl = url || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-2.jpg';
  window.setShAIAvatar(testUrl);
  expandDrawer(maxHeight);
  console.log('testShAIAvatar:', testUrl);
 };

 // Expose for testing: window.testAddFriend(name) - simulates adding a friend, shows notification, increments bell badge
 window.testAddFriend = function(name) {
  const contactName = name || 'Test Friend';
  const doAdd = () => {
  if (typeof onFriendAdded === 'function') {
  onFriendAdded(contactName);
  }
  console.log('testAddFriend:', contactName, '- notification badge incremented');
  };
  if (typeof expandDrawer === 'function') expandDrawer(maxHeight);
  setTimeout(doAdd, 100);
 };

 const chatDrawer = document.getElementById('shai-chat-drawer');
 const chatDrawerWrapper = document.getElementById('shai-chat-drawer-wrapper');
 const chatOverlay = document.getElementById('chat-overlay');
 const chatInputCollapsed = document.getElementById('chat-input-collapsed');
 const chatInputCollapsedField = document.getElementById('chat-input-collapsed-field');
 const chatInputDrawer = document.getElementById('chat-input-drawer');
 const sendButtonDrawer = document.getElementById('send-button-drawer');
 const micButtonDrawer = document.getElementById('mic-button-drawer');
 const sendButtonCollapsed = document.getElementById('send-button-collapsed');
 const micButtonCollapsed = document.getElementById('mic-button-collapsed');
 const addFriendButton = document.getElementById('add-friend-button');
 const addFriendButtonCollapsed = document.getElementById('add-friend-button-collapsed');
 const addFriendView = document.getElementById('add-friend-view');
 const chatMessages = document.getElementById('chat-messages');
 const chatMessagesScroll = document.getElementById('chat-messages-scroll');
 const backButton = document.getElementById('back-button');
 const drawerHeader = document.getElementById('drawer-header');
 const dragHandleZone = document.getElementById('drag-handle-zone') || document.getElementById('drag-handle');

 let isDrawerExpanded = true;
 let isAddFriendView = false;
 let isDragging = false;
 let startY, startHeight;

 const vh = (p) => window.innerHeight * (p / 100);
 const navEl = document.getElementById('bottom-navigation');
 const navHeight = navEl ? navEl.offsetHeight : 56;
 const minHeight = vh(35);
 const maxHeight = window.innerHeight - navHeight;

 function setInitialDrawerState() {
  chatDrawer.style.height = `${minHeight}px`;
  chatDrawer.style.transform = 'translateY(0)';
  chatDrawerWrapper.classList.remove('pointer-events-none');
  chatOverlay.classList.remove('opacity-0', 'pointer-events-none');
  chatInputCollapsed.classList.add('hidden');
  isDrawerExpanded = true;
 }

 setInitialDrawerState();

 function startDrag(e) {
  isDragging = true;
  startY = e.pageY || e.touches[0].pageY;
  startHeight = chatDrawer.clientHeight;
  chatDrawer.style.transition = 'none';
  document.body.style.cursor = 'grabbing';
 }

 function onDrag(e) {
  if (!isDragging) return;
  const currentY = e.pageY || e.touches[0].pageY;
  const diff = startY - currentY;
  let newHeight = startHeight + diff;

  newHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
  chatDrawer.style.height = `${newHeight}px`;
 }

 function endDrag() {
  if (!isDragging) return;
  isDragging = false;
  chatDrawer.style.transition = 'height 0.3s ease-out, transform 0.3s ease-out';
  document.body.style.cursor = 'default';
  
  const currentHeight = chatDrawer.clientHeight;
  if (currentHeight < minHeight + 50 && startHeight > currentHeight) {
  collapseDrawer();
  }
 }

 document.addEventListener('mousemove', onDrag);
 document.addEventListener('mouseup', endDrag);
 document.addEventListener('touchmove', onDrag, { passive: true });
 document.addEventListener('touchend', endDrag);
 document.addEventListener('touchcancel', endDrag);
 if (dragHandleZone) {
  dragHandleZone.addEventListener('mousedown', startDrag);
  dragHandleZone.addEventListener('touchstart', startDrag, { passive: true });
 }

 function expandDrawer(targetHeight = minHeight) {
  chatDrawer.style.height = `${Math.max(minHeight, Math.min(targetHeight, maxHeight))}px`;
  chatDrawer.style.transform = 'translateY(0)';
  chatDrawerWrapper.classList.remove('pointer-events-none');
  chatOverlay.classList.remove('opacity-0', 'pointer-events-none');
  chatInputCollapsed.classList.add('hidden');
  isDrawerExpanded = true;
 }

 function collapseDrawer() {
  chatDrawer.style.transform = 'translateY(100%)';
  chatDrawerWrapper.classList.add('pointer-events-none');
  chatOverlay.classList.add('opacity-0', 'pointer-events-none');
  chatInputCollapsed.classList.remove('hidden');
  isDrawerExpanded = false;
  showChatView();
 }

 loadShopByCategoryData();
 loadBadgeCounts();

 // Add Friend contacts: dynamic. goshopme=true -> Add btn + avatar/initials; goshopme=false -> Invite btn + initials
 window.__addFriendContacts = window.__addFriendContacts || [
  { name: 'Jessica Smith', phone: '+1 (555) 123-4567', goshopme: true },
  { name: 'Michael Johnson', phone: '+1 (555) 987-6543', goshopme: false, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-2.jpg' },
  { name: 'Emily Rodriguez', phone: '+1 (555) 456-7890', goshopme: true, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-3.jpg' },
  { name: 'David Wilson', phone: '+1 (555) 321-0987', goshopme: false }
 ];
 function getInitials(name) {
  const parts = (name || '').trim().split(/\s+/);
  if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
  return (parts[0] ? parts[0].slice(0, 2) : '??').toUpperCase();
 }
 function renderAddFriendContacts() {
  const container = document.getElementById('contact-list');
  if (!container) return;
  const list = Array.isArray(window.__addFriendContacts) ? window.__addFriendContacts : [];
  container.innerHTML = list.map(c => {
  const initials = getInitials(c.name);
  const hasAvatar = c.goshopme && c.avatar;
  const avatarHtml = hasAvatar
  ? `<img class="w-8 h-8 rounded-full object-cover flex-shrink-0" src="${c.avatar.replace(/"/g, '&quot;')}" alt="${(c.name || '').replace(/"/g, '&quot;')}" />`
  : `<div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs dm-sans">${initials}</span></div>`;
  const btnHtml = c.goshopme
  ? '<button class="px-2 py-1 bg-shine-primary text-white rounded-full text-xs font-medium dm-sans hover:opacity-90 transition-opacity contact-add-btn">Add</button>'
  : '<button class="px-2 py-1 bg-white text-shine-primary border border-shine-primary rounded-full text-xs font-medium dm-sans hover:bg-shine-primary hover:text-white transition-colors contact-invite-btn">Invite</button>';
  return '<div class="flex items-center justify-between p-2 bg-gray-50 rounded-xl">' +
  '<div class="flex items-center gap-2">' + avatarHtml +
  '<div><p class="contact-name font-medium text-sm text-black dm-sans">' + (c.name || '').replace(/</g, '&lt;') + '</p>' +
  '<p class="contact-phone text-xs text-gray-500 dm-sans">' + (c.phone || '').replace(/</g, '&lt;') + '</p></div></div>' + btnHtml + '</div>';
  }).join('');
 }
 window.loadAddFriendContacts = function(data) {
  window.__addFriendContacts = Array.isArray(data) ? data : [];
  renderAddFriendContacts();
 };
 renderAddFriendContacts();

 // Apply ShAI avatar on load: use pre-set URL or default from assets
 if (window.__shaiAvatarUrl) window.setShAIAvatar(window.__shaiAvatarUrl);
 else window.setShAIAvatar('https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png');

 // Expose for console testing
 window.loadShopByCategoryData = loadShopByCategoryData;
 window.loadBadgeCounts = loadBadgeCounts;
 window.testWithFallback = function() {
  renderHeroSection(fallbackData);
  renderCategoryGrid(fallbackData.categories);
  console.log('Rendered with inline fallback data');
 };
 window.testDynamicLoading = function(testData) {
  const heroContainer = document.getElementById('hero-content');
  const gridEl = document.getElementById('category-grid-list');
  if (!heroContainer || !gridEl) return console.error('Containers not found');
  const data = testData || {
  hero: {
  mediaType: 'image',
  imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/679e3cd9c0-57bff49eadf03dd76c2d.png',
  title: 'TEST HERO Dynamic Data',
  alt: 'Test hero'
  },
  categories: [
  { id: 'test1', name: 'Test Category 1', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/9defa79298-af813b2ec06aee066a72.png', alt: 'Test 1' },
  { id: 'test2', name: 'Test Category 2', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/9defa79298-586bd62186535e4aa324.png', alt: 'Test 2' },
  { id: 'test3', name: 'Test Category 3', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/fe889403a6-3dc53cccc6540bdaf934.png', alt: 'Test 3' },
  { id: 'test4', name: 'Test Category 4', imageUrl: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/b5ae74c852-b927503e5a0055c22ba0.png', alt: 'Test 4', badge: 'NEW' }
  ]
  };
  renderHeroSection(data);
  renderCategoryGrid(data.categories);
  console.log('Rendered test data:', data);
 };

 // Test add-friend flow: inject contact data and re-render. Each contact: { name, phone, goshopme: boolean, avatar? }
 // GoShopMe user -> Add btn (filled); non-GoShopMe -> Invite btn (outline). Avatar only for goshopme+avatar.
 window.testAddFriendContacts = function(contacts) {
  if (contacts) {
  window.__addFriendContacts = Array.isArray(contacts) ? contacts : [contacts];
  } else {
  window.__addFriendContacts = [
  { name: 'Alex Go', phone: '+1 111-1111', goshopme: true, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-2.jpg' },
  { name: 'Bob NonGo', phone: '+1 222-2222', goshopme: false },
  { name: 'Carol GoNoPic', phone: '+1 333-3333', goshopme: true },
  { name: 'Dana Invite', phone: '+1 444-4444', goshopme: false }
  ];
  }
  renderAddFriendContacts();
  if (typeof expandDrawer === 'function') expandDrawer(maxHeight);
  addFriendButton.click();
  console.log('testAddFriendContacts:', window.__addFriendContacts);
 };

 document.getElementById('category-grid-list').addEventListener('click', function(e) {
  const card = e.target.closest('.category-card');
  if (!card) return;
  const categoryId = card.getAttribute('data-category-id') || '';
  const categoryName = card.getAttribute('data-category-name') || categoryId;
  expandDrawer();
  showChatView();

  const contextMessage = document.createElement('div');
  contextMessage.className = 'flex items-start space-x-3 mb-4';
  contextMessage.innerHTML = `${getShaiAvatarHtml()}<div class="bg-gray-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs"><p class="text-sm text-black dm-sans break-words whitespace-pre-wrap">Great choice! I'll show you the best ${escapeHtml(categoryName)} options that match your style and size. What's the occasion?</p></div>`;
  chatMessages.appendChild(contextMessage);
  scrollChatToBottom();
 });

 chatInputCollapsedField.addEventListener('focus', () => {
  expandDrawer();
  setTimeout(() => chatInputDrawer.focus(), 300);
 });

 chatInputCollapsed.addEventListener('click', (e) => {
  if (!isDrawerExpanded) {
  expandDrawer();
  if (e.target !== chatInputCollapsedField) {
  setTimeout(() => chatInputDrawer.focus(), 300);
  }
  }
 });

 function showAddFriendView() {
  chatMessages.classList.add('hidden');
  addFriendView.classList.remove('hidden');
  backButton.classList.remove('hidden');
  isAddFriendView = true;
 }

 function showChatView() {
  chatMessages.classList.remove('hidden');
  addFriendView.classList.add('hidden');
  backButton.classList.add('hidden');
  isAddFriendView = false;
 }

 function scrollChatToBottom() {
  const scrollEl = chatMessagesScroll || chatMessages.parentElement || chatMessages;
  if (scrollEl) scrollEl.scrollTop = scrollEl.scrollHeight;
 }

 function addShaiReply(text) {
  const aiResponse = document.createElement('div');
  aiResponse.className = 'flex items-start space-x-3 mb-4';
  aiResponse.innerHTML = `${getShaiAvatarHtml()}<div class="bg-gray-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-[80%]"><p class="text-sm text-black dm-sans break-words whitespace-pre-wrap">${text.replace(/</g, '&lt;')}</p></div>`;
  chatMessages.appendChild(aiResponse);
  scrollChatToBottom();
 }

 addFriendButton.addEventListener('click', () => {
  expandDrawer(maxHeight);
  showAddFriendView();
 });

 // Camera button - open file picker for images/videos
 function handleCameraAccess() {
  showChatView();
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*,video/*';
  input.onchange = function(e) {
  const file = e.target.files && e.target.files[0];
  if (file) {
  const url = URL.createObjectURL(file);
  const bubble = document.createElement('div');
  bubble.className = 'flex justify-end mb-4';
  if (file.type.indexOf('image') === 0) {
  bubble.innerHTML = '<div class="rounded-2xl border border-shine-primary max-w-[60%] overflow-hidden shadow-sm"><img src="' + url + '" class="w-full h-auto" alt="Uploaded image"></div>';
  } else if (file.type.indexOf('video') === 0) {
  bubble.innerHTML = '<div class="rounded-2xl border border-shine-primary max-w-[60%] overflow-hidden"><video src="' + url + '" controls class="w-full h-auto"></video></div>';
  }
  if (bubble.innerHTML) {
  chatMessages.appendChild(bubble);
  scrollChatToBottom();
  const isImage = file.type.indexOf('image') === 0;
  setTimeout(() => addShaiReply(isImage ? "Perfect! I can see your image. Let me find styles that match what you're looking for!" : "Love the video! I'll use this to curate the best options for you."), 800);
  }
  input.value = '';
  }
  };
  input.click();
 }
 const camBtnDrawer = document.getElementById('cam-btn-drawer');
 const camBtn = document.getElementById('cam-btn');
 if (camBtnDrawer) camBtnDrawer.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); handleCameraAccess(); });
 if (camBtn) camBtn.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); if (!isDrawerExpanded) expandDrawer(); setTimeout(handleCameraAccess, 300); });

 // Voice recording (hold-to-record)
 let mediaStream = null, mediaRecorder = null, audioChunks = [], isRecording = false, startX = 0, micAccessDenied = false;
 function removeTempRecordingBubble() {
  const t = document.getElementById('temp-recording');
  if (t) t.remove();
 }
 function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'fixed top-20 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-[60] dm-sans';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
 }
 async function startRecording(e) {
  e.preventDefault();
  removeTempRecordingBubble();
  if (!isDrawerExpanded) { expandDrawer(); return; }
  if (micAccessDenied) {
  showToast('Microphone access denied. Enable it in your browser settings to record voice messages.');
  return;
  }
  startX = e.touches ? e.touches[0].clientX : e.clientX;
  try {
  if (!mediaStream || !mediaStream.active) mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(mediaStream);
  isRecording = true;
  audioChunks = [];
  mediaRecorder.ondataavailable = ev => { if (ev.data.size > 0) audioChunks.push(ev.data); };
  mediaRecorder.start();
  this.classList.add('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
  showChatView();
  const tempBubble = document.createElement('div');
  tempBubble.id = 'temp-recording';
  tempBubble.className = 'flex justify-end mb-2';
  tempBubble.innerHTML = '<div class="flex items-center bg-shine-primary text-white rounded-2xl px-3 py-2 max-w-[70%]"><svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg><span class="text-xs dm-sans">Recording... swipe left to cancel</span></div>';
  chatMessages.appendChild(tempBubble);
  scrollChatToBottom();
  } catch (err) {
  removeTempRecordingBubble();
  if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
  micAccessDenied = true;
  showToast('Microphone access denied. Enable it in your browser settings to record voice messages.');
  } else {
  showToast('Could not access microphone. Please try again.');
  console.warn('Microphone error:', err);
  }
  }
 }
 function stopRecording(e) {
  e.preventDefault();
  if (!isRecording) return;
  isRecording = false;
  this.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
  removeTempRecordingBubble();
  if (mediaRecorder) {
  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
  const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
  const audioUrl = URL.createObjectURL(audioBlob);
  renderAudioBubble(audioUrl);
  };
  }
 }
 function cancelRecording(e) {
  if (!isRecording) return;
  isRecording = false;
  this.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
  removeTempRecordingBubble();
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
 }
 function handleSwipeCancel(e) {
  if (!isRecording || !e.touches || !e.touches.length) return;
  const curX = e.touches[0].clientX;
  if (startX - curX > 30) cancelRecording.call(this, e);
 }
 function renderAudioBubble(url) {
  const bubble = document.createElement('div');
  bubble.className = 'flex justify-end mb-2';
  bubble.innerHTML = '<div role="group" aria-label="Voice message from you" class="voice-message-bubble bg-shine-primary text-white rounded-full px-3 py-2 flex items-center gap-2 h-11 shadow-sm">' +
  '<button aria-label="Play voice message from you" class="play-btn flex-shrink-0 w-6 h-6 border border-white rounded-full flex items-center justify-center hover:bg-white/20 transition-all duration-150" onclick="window.toggleVoicePlaybackCat(this, \'' + url + '\')">' +
  '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>' +
  '<div class="waveform flex-1 flex items-center justify-center gap-0.5 h-4 max-w-[120px]">' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 0"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 1"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 2"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 16px; --i: 3"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 4"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 14px; --i: 5"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 6"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 7"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 8"></div>' +
  '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 9"></div></div>' +
  '<span class="duration-text text-white/90 text-xs font-medium flex-shrink-0 dm-sans">0:00</span>' +
  '<audio src="' + url + '" preload="auto" class="hidden"></audio></div>';
  chatMessages.appendChild(bubble);
  const audio = bubble.querySelector('audio');
  const durationText = bubble.querySelector('.duration-text');
  if (audio && durationText) audio.addEventListener('loadedmetadata', () => {
  const d = Math.ceil(audio.duration);
  durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
  });
  scrollChatToBottom();
  setTimeout(() => addShaiReply("Got your voice message! I'm on it - let me find the best options for you."), 800);
 }
 window.toggleVoicePlaybackCat = function(button, audioUrl) {
  const container = button.closest('.voice-message-bubble');
  const audio = container.querySelector('audio');
  const playIcon = button.querySelector('svg');
  const waveBars = container.querySelectorAll('.wave-bar');
  const durationText = container.querySelector('.duration-text');
  if (audio.paused) {
  audio.play();
  playIcon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
  waveBars.forEach((bar, i) => {
  bar.style.animation = 'wavePulse 1.1s ease-in-out infinite';
  bar.style.animationDelay = (i * 0.08) + 's';
  });
  audio.addEventListener('timeupdate', () => {
  const rem = Math.ceil(audio.duration - audio.currentTime);
  durationText.textContent = Math.floor(rem / 60) + ':' + (rem % 60).toString().padStart(2, '0');
  }, { once: false });
  audio.addEventListener('ended', () => {
  playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
  waveBars.forEach(b => { b.style.animation = 'none'; });
  const d = Math.ceil(audio.duration);
  durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
  }, { once: true });
  } else {
  audio.pause();
  playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
  waveBars.forEach(b => { b.style.animation = 'none'; });
  const d = Math.ceil(audio.duration);
  durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
  }
 };
 [micButtonDrawer, micButtonCollapsed].filter(Boolean).forEach(btn => {
  btn.addEventListener('mousedown', startRecording);
  btn.addEventListener('touchstart', startRecording);
  btn.addEventListener('mouseup', stopRecording);
  btn.addEventListener('mouseleave', cancelRecording);
  btn.addEventListener('touchend', stopRecording);
  btn.addEventListener('touchcancel', cancelRecording);
  btn.addEventListener('touchmove', handleSwipeCancel);
 });

 addFriendButtonCollapsed.addEventListener('click', () => {
  expandDrawer(maxHeight);
  setTimeout(() => showAddFriendView(), 300);
 });

 backButton.addEventListener('click', () => showChatView());

 function getCurrentBadgeCounts() {
  const notifEl = document.getElementById('notif-count');
  const cartEl = document.getElementById('cart-count');
  const notifText = notifEl ? notifEl.textContent : '0';
  const cartText = cartEl ? cartEl.textContent : '0';
  const unread = notifText === '99+' ? 99 : Math.max(0, parseInt(notifText, 10) || 0);
  const cart = cartText === '99+' ? 99 : Math.max(0, parseInt(cartText, 10) || 0);
  return { unread, cart };
 }

 function onFriendAdded(contactName) {
  const notification = document.createElement('div');
  notification.className = 'flex justify-center mb-4';
  notification.innerHTML = `<div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">${contactName.replace(/</g, '&lt;')} has been added to chat</div>`;
  chatMessages.appendChild(notification);
  const { unread, cart } = getCurrentBadgeCounts();
  updateBadges(unread + 1, cart);
  BadgeAPI.setFallback(unread + 1, cart);
  showChatView();
  scrollChatToBottom();
 }

 // Event delegation: contact-list is re-rendered, so we attach to the persistent parent
 const contactList = document.getElementById('contact-list');
 if (contactList) {
  contactList.addEventListener('click', (e) => {
  const addBtn = e.target.closest('.contact-add-btn');
  const inviteBtn = e.target.closest('.contact-invite-btn');
  if (addBtn) {
  const row = addBtn.closest('.flex');
  const contactName = (row && row.querySelector('.contact-name')) ? row.querySelector('.contact-name').textContent : 'Friend';
  onFriendAdded(contactName);
  } else if (inviteBtn) {
  const shareData = {
  title: 'GoShopMe Invitation',
  text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless join me",
  url: 'https://app.goshopme.ai'
  };
  if (navigator.share) navigator.share(shareData);
  else window.open(`sms:?body=${encodeURIComponent(shareData.text + ' ' + shareData.url)}`, '_blank');
  }
  });
 }

 function autoGrowTextarea(ta) {
  ta.style.overflowY = 'hidden';
  ta.style.height = '0';
  ta.style.height = Math.min(Math.max(ta.scrollHeight, 24), 144) + 'px';
  ta.style.overflowY = ta.scrollHeight > 144 ? 'auto' : 'hidden';
 }

 function updateDrawerInputUI(hasText) {
  const actions = document.querySelectorAll('.chat-input-action');
  const send = document.querySelector('.chat-input-send');
  if (hasText) {
  actions.forEach(el => { el.classList.add('typing-hidden'); });
  if (send) { send.classList.remove('hidden'); send.classList.add('typing-visible'); }
  } else {
  actions.forEach(el => { el.classList.remove('typing-hidden'); });
  if (send) { send.classList.add('hidden'); send.classList.remove('typing-visible'); }
  }
 }

 function updateCollapsedInputUI(hasText) {
  const actions = document.querySelectorAll('.chat-input-action-collapsed');
  const send = document.querySelector('.chat-input-send-collapsed');
  if (hasText) {
  actions.forEach(el => { el.classList.add('typing-hidden'); });
  if (send) { send.classList.remove('hidden'); send.classList.add('typing-visible'); }
  } else {
  actions.forEach(el => { el.classList.remove('typing-hidden'); });
  if (send) { send.classList.add('hidden'); send.classList.remove('typing-visible'); }
  }
 }

 chatInputDrawer.addEventListener('input', (e) => {
  autoGrowTextarea(e.target);
  const hasText = e.target.value.trim().length > 0;
  updateDrawerInputUI(hasText);
 });

 chatInputCollapsedField.addEventListener('input', (e) => {
  autoGrowTextarea(e.target);
  const hasText = e.target.value.trim().length > 0;
  updateCollapsedInputUI(hasText);
 });

 chatInputDrawer.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
  e.preventDefault();
  sendMessage(chatInputDrawer, sendButtonDrawer, micButtonDrawer);
  }
 });

 chatInputCollapsedField.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
  e.preventDefault();
  sendMessage(chatInputCollapsedField, sendButtonCollapsed, micButtonCollapsed);
  expandDrawer();
  }
 });

 function sendMessage(inputField, sendButton, micButton) {
  const message = inputField.value.trim();
  if (message) {
  showChatView();
  const userMessage = document.createElement('div');
  userMessage.className = 'flex justify-end mb-4';
  const bubble = document.createElement('div');
  bubble.className = 'bg-shine-primary rounded-2xl rounded-tr-md px-4 py-3 max-w-xs';
  const p = document.createElement('p');
  p.className = 'text-sm text-white dm-sans break-words whitespace-pre-wrap';
  p.textContent = message;
  bubble.appendChild(p);
  userMessage.appendChild(bubble);
  chatMessages.appendChild(userMessage);
  scrollChatToBottom();
  inputField.value = '';
  inputField.style.height = '0';
  inputField.style.height = '24px';
  if (inputField === chatInputDrawer) {
  updateDrawerInputUI(false);
  } else {
  updateCollapsedInputUI(false);
  }

  setTimeout(() => {
  const aiResponse = document.createElement('div');
  aiResponse.className = 'flex items-start space-x-3 mb-4';
  aiResponse.innerHTML = `${getShaiAvatarHtml()}<div class="bg-gray-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs"><p class="text-sm text-black dm-sans break-words whitespace-pre-wrap">Perfect! Let me curate some amazing options that match exactly what you're looking for.</p></div>`;
  chatMessages.appendChild(aiResponse);
  scrollChatToBottom();
  }, 1000);
  }
 }

 sendButtonDrawer.addEventListener('click', () => sendMessage(chatInputDrawer, sendButtonDrawer, micButtonDrawer));
 sendButtonCollapsed.addEventListener('click', () => {
  sendMessage(chatInputCollapsedField, sendButtonCollapsed, micButtonCollapsed);
  expandDrawer();
 });

 const promptReplies = {
  'Vacation Edit': "Love it! I'll curate the best vacation looks — breezy dresses, swimwear, and versatile pieces you can mix and match for your trip.",
  'Date Night': "Perfect! I'll find you stunning date night outfits — elegant dresses, chic tops, and accessories that'll make you feel amazing.",
  'Under $100': "Got it! I'll show you amazing finds under $100 — stylish pieces that won't break the bank.",
  'Workwear Looks': "On it! I'll put together sharp workwear options — professional blazers, tailored pieces, and polished looks for the office."
 };
 document.querySelectorAll('.ml-11 button').forEach(button => {
  button.addEventListener('click', () => {
  showChatView();
  const promptText = button.textContent.trim();
  const userMessage = document.createElement('div');
  userMessage.className = 'flex justify-end mb-4';
  userMessage.innerHTML = `<div class="bg-shine-primary rounded-2xl rounded-tr-md px-4 py-3 max-w-xs"><p class="text-sm text-white dm-sans break-words whitespace-pre-wrap">${promptText}</p></div>`;
  chatMessages.appendChild(userMessage);
  scrollChatToBottom();

  const replyText = promptReplies[promptText] || "Great choice! I'll show you curated pieces perfect for that style and occasion.";
  setTimeout(() => {
  const aiResponse = document.createElement('div');
  aiResponse.className = 'flex items-start space-x-3 mb-4';
  aiResponse.innerHTML = `${getShaiAvatarHtml()}<div class="bg-gray-50 rounded-2xl rounded-tl-md px-4 py-3 max-w-xs"><p class="text-sm text-black dm-sans break-words whitespace-pre-wrap">${replyText.replace(/</g, '&lt;')}</p></div>`;
  chatMessages.appendChild(aiResponse);
  scrollChatToBottom();
  }, 800);
  });
 });

 chatOverlay.addEventListener('click', () => { if (isDrawerExpanded) collapseDrawer(); });
 document.getElementById('background-content').addEventListener('click', () => { if (isDrawerExpanded) collapseDrawer(); });

 document.getElementById('contact-search').addEventListener('input', (e) => {
  const searchTerm = e.target.value.toLowerCase();
  document.querySelectorAll('#contact-list > div').forEach(contact => {
  const nameEl = contact.querySelector('.contact-name');
  const phoneEl = contact.querySelector('.contact-phone');
  const name = (nameEl && nameEl.textContent || '').toLowerCase();
  const phone = (phoneEl && phoneEl.textContent || '').toLowerCase();
  contact.style.display = (name.includes(searchTerm) || phone.includes(searchTerm)) ? 'flex' : 'none';
  });
 });

 });
 </script>
 </div>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" href="css/mobile-optimization.css">
    <title>Creator Picks - GoShopMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=Karla:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/chat-drawer-drag.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'shine-primary': '#939BFB',
                        'shine-accent': '#F96226',
                        'primary': '#939BFB'
                    },
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                        'dm-sans': ['DM Sans', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* ---- MOBILE: drawer full-width, title centered (match Home) ---- */
        @media screen and (max-width: 768px) {
          body > div:not(#chat-overlay):not(#shai-chat-drawer):not(#chat-input-bar),
          body > main {
            max-width: 100vw !important;
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            box-shadow: none !important;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
          }
          [class*="left-1/2"][class*="-translate-x-1/2"]:not([class*="rounded-full"]):not(#page-title):not(#shai-chat-drawer):not(#chat-overlay):not(#chat-input-bar) {
            left: 0 !important;
            right: 0 !important;
            max-width: 100vw !important;
            width: 100% !important;
            transform: none !important;
          }
          /* Preserve header title centering */
          #app-header #page-title {
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: auto !important;
            max-width: calc(100vw - 140px) !important;
            right: auto !important;
            text-align: center;
          }
          /* Chat drawer: full width, bottom slide, dock above nav */
          #shai-chat-drawer {
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            bottom: var(--shai-nav-h, 64px) !important;
          }
          #shai-chat-drawer:not(.translate-y-full) {
            transform: none !important;
          }
          #shai-chat-drawer.translate-y-full {
            transform: translateY(100%) !important;
          }
          /* Chat input bar: full width, dock above nav */
          #chat-input-bar {
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            transform: none !important;
            bottom: var(--shai-nav-h, 64px) !important;
          }
          /* Drawer header: avatar square, text horizontal */
          #drawer-header {
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            align-items: center !important;
          }
          #shai-avatar-container {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            min-height: 32px !important;
            max-width: 32px !important;
            max-height: 32px !important;
            flex-shrink: 0 !important;
            overflow: hidden !important;
            aspect-ratio: 1 !important;
          }
          #shai-avatar-container img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            object-position: center !important;
          }
          #drawer-header .flex-1 {
            min-width: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: flex-start !important;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            text-align: left !important;
          }
          #drawer-header #header-title,
          #drawer-header #header-subtitle {
            writing-mode: horizontal-tb !important;
            text-align: left !important;
            white-space: normal !important;
          }
          /* Input bar: same as Home - hide add/mic when typing, send on right */
          #chat-input-bar .icon-button,
          #chat-input-drawer-wrap .icon-button {
            flex-shrink: 0 !important;
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
          }
          #chat-input-bar .icon-button.hidden,
          #chat-input-drawer-wrap .icon-button.hidden,
          #chat-input-bar #send-btn.hidden,
          #chat-input-drawer-wrap #send-btn-drawer.hidden {
            display: none !important;
          }
          #chat-input-bar #send-btn:not(.hidden),
          #chat-input-drawer-wrap #send-btn-drawer:not(.hidden) {
            flex-shrink: 0 !important;
            width: 36px !important;
            height: 36px !important;
            margin-left: auto !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
          }
          #chat-input-bar #message-input,
          #chat-input-drawer-wrap #chat-input-drawer {
            flex: 1 1 0% !important;
            min-width: 0 !important;
          }
          #bottom-nav > div, #bottom-navigation > div, nav#bottom-nav > div, nav#bottom-navigation > div {
            padding-top: 2px !important;
            padding-bottom: 24px !important;
          }
        }
        ::-webkit-scrollbar { display: none; }
        * { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .dm-sans { font-family: 'DM Sans', 'Karla', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .poppins { font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .font-fahkwang { font-family: 'Poppins', sans-serif; }
        .container-mobile { max-width: 390px; margin-left: auto; margin-right: auto; width: 100%; }

        .icon-button svg { width: 18px; height: 18px; stroke-width: 1.5; }
        .icon-button:hover svg { color: #939BFB; }
        .bottom-nav-btn { display: flex; flex-direction: column; align-items: center; color: #6B7280; transition: color 0.2s ease-in-out; }
        .bottom-nav-btn:hover, .bottom-nav-btn.active { color: #939BFB; }
        .bottom-nav-btn:hover svg, .bottom-nav-btn:hover span, .bottom-nav-btn.active svg, .bottom-nav-btn.active span { color: #939BFB; }
        .bottom-nav-btn svg { width: 20px; height: 20px; stroke-width: 1.5; margin-bottom: 4px; }
        #cart-indicator, #notif-indicator { min-width: 18px; min-height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; }
        #cart-indicator.hidden, #notif-indicator.hidden { display: none !important; }
        #cart-indicator.badge-numeric, #notif-indicator.badge-numeric { min-width: 18px; padding: 0 5px; }
        .heart-filled { fill: #939BFB !important; stroke: #939BFB !important; }
        .share-icon-tilted { transform: rotate(-35deg); }
        .product-overlay-icon { /* Plain white icons - Instagram style */ }
        .product-image-overlay-wrap::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.08); pointer-events: none; z-index: 0; }
        .product-image-overlay-wrap > [class*="absolute"][class*="top-"] { z-index: 1; }
        .voice-message-bubble { min-width: 140px; max-width: 260px; width: fit-content; }
        @keyframes wavePulse { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
        .wave-bar.playing { animation: wavePulse 1.1s ease-in-out infinite; animation-delay: calc(var(--i) * 0.08s); }
        /* Collection tiles: pointer cursor (desktop), touch-optimized (mobile) */
        .collection-tile { cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: rgba(147, 155, 251, 0.12); }
        .header-icon-btn { transition: transform 0.2s ease, color 0.2s ease; }
        .header-icon-btn:hover { transform: translateY(-2px); }
    </style>
    <script>
    // Header badge system - dynamic on all screens, synced via localStorage (match ShopbyCategory)
    var BADGE_KEYS = { notif: 'goshopme_notif_count', cart: 'goshopme_cart_count' };
    var cartCountValue = 0, notifCountValue = 0;
    function getBadgeElements() {
        return { cartIndicator: document.getElementById('cart-indicator'), cartCount: document.getElementById('cart-count'), notifIndicator: document.getElementById('notif-indicator'), notifCount: document.getElementById('notif-count') };
    }
    function updateCartBadge() { var el = getBadgeElements(); if (el.cartIndicator && el.cartCount) { var s = cartCountValue > 0; el.cartIndicator.classList.toggle('hidden', !s); el.cartIndicator.classList.toggle('flex', s); el.cartCount.textContent = s ? (cartCountValue > 99 ? '99+' : cartCountValue) : ''; } try { localStorage.setItem(BADGE_KEYS.cart, String(cartCountValue)); } catch (e) {} }
    function updateNotifBadge() { var el = getBadgeElements(); if (el.notifIndicator && el.notifCount) { var s = notifCountValue > 0; el.notifIndicator.classList.toggle('hidden', !s); el.notifIndicator.classList.toggle('flex', s); el.notifCount.textContent = s ? (notifCountValue > 99 ? '99+' : notifCountValue) : ''; } try { localStorage.setItem(BADGE_KEYS.notif, String(notifCountValue)); } catch (e) {} }
    window.addToCart = function() { cartCountValue++; updateCartBadge(); };
    window.addNotification = function() { notifCountValue++; updateNotifBadge(); };
    window.setCartCount = function(n) { cartCountValue = Math.max(0, n); updateCartBadge(); };
    window.setNotifCount = function(n) { notifCountValue = Math.max(0, n); updateNotifBadge(); };
    window.testBadges = function(unread, cart) { notifCountValue = Math.max(0, unread ?? 5); cartCountValue = Math.max(0, cart ?? 3); updateNotifBadge(); updateCartBadge(); console.log('testBadges:', notifCountValue, cartCountValue); };
    window.resetBadges = function() { cartCountValue = 0; notifCountValue = 0; try { localStorage.setItem(BADGE_KEYS.notif, '0'); localStorage.setItem(BADGE_KEYS.cart, '0'); } catch (e) {} updateCartBadge(); updateNotifBadge(); console.log('resetBadges'); };
    document.addEventListener('DOMContentLoaded', function() {
        try { notifCountValue = parseInt(localStorage.getItem(BADGE_KEYS.notif) || '0', 10); cartCountValue = parseInt(localStorage.getItem(BADGE_KEYS.cart) || '0', 10); } catch (e) {}
        updateCartBadge(); updateNotifBadge();
    });
    </script>
    <script src="js/picks-api.js"></script>
</head>
<body class="bg-[#F6F6F6] min-h-screen text-black overflow-x-hidden">

    <div id="app-shell" class="relative w-full max-w-[390px] mx-auto min-h-screen bg-white shadow-2xl">

    <!-- App Header - design system: centered title, badges -->
    <header id="app-header" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] z-50 bg-white/95 backdrop-blur-sm border-b border-gray-100">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="w-10 flex-shrink-0"><!-- Spacer for centering --></div>
            <h1 id="page-title" class="text-lg poppins font-semibold text-gray-900 absolute left-1/2 transform -translate-x-1/2">Picks</h1>
            <div class="flex items-center gap-0">
                <a href="Notifications_Screen.html?from=picks" id="notif-btn" class="header-icon-btn w-10 h-10 flex items-center justify-center relative overflow-visible text-gray-600 hover:text-gray-800" aria-label="Notifications">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/>
                    </svg>
                    <div id="notif-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-[#F96226] rounded-full hidden items-center justify-center flex">
                        <span id="notif-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span>
                    </div>
                </a>
                <a href="Shopping_bag.html?from=picks" id="cart-btn" class="header-icon-btn w-10 h-10 flex items-center justify-center relative overflow-visible text-gray-600 hover:text-gray-800" aria-label="Shopping bag">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993z"/>
                    </svg>
                    <div id="cart-indicator" class="absolute -top-0.5 -right-0.5 min-w-[18px] min-h-[18px] px-1 bg-[#939BFB] rounded-full hidden items-center justify-center flex">
                        <span id="cart-count" class="text-[10px] text-white font-medium leading-none whitespace-nowrap"></span>
                    </div>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content Container - pb for bottom nav + chat input bar -->
    <main id="main-content" class="pt-20 px-4 pb-40 relative w-full max-w-[390px] mx-auto overflow-y-auto">
        
        <!-- Background Content - Collections Feed (dynamic: loadCreatorPicksData) -->
        <div id="background-content" class="min-h-screen">
            <div id="creator-picks-container"><!-- Populated by loadCreatorPicksData() --></div>

        </div>

    </main>

        <!-- Chat Drawer Overlay - fixed, docked above bottom nav (match Home) -->
        <div id="chat-overlay" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

        <!-- ShAI Chat Drawer - fixed bottom-16 = docked to top of bottom nav (match Home) -->
        <div id="shai-chat-drawer" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] z-50 bg-white rounded-t-3xl shadow-2xl h-[50vh] transform transition-transform duration-300 flex flex-col border-t border-gray-100">
            <div id="drag-handle-zone" class="chat-drawer-drag-zone flex justify-center pt-2 flex-shrink-0">
                <div id="drag-handle" class="w-10 h-1 bg-gray-300 rounded-full pointer-events-none drag-handle"></div>
            </div>
            <div id="drawer-header" class="flex items-center p-4 pb-2 flex-shrink-0">
                <button id="back-button" class="mr-3 hidden hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
                </button>
                <div id="shai-avatar-container" class="w-8 h-8 rounded-full overflow-hidden mr-3 flex-shrink-0 bg-gray-200 flex items-center justify-center">
                    <img id="shai-avatar" class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar>
                    <span id="shai-avatar-placeholder" class="text-gray-500 text-xs font-medium hidden">AI</span>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-black text-sm" id="header-title">ShAI</p>
                    <p class="text-xs text-gray-500" id="header-subtitle">Your shopping assistant</p>
                </div>
            </div>

            <!-- Chat Content -->
            <div id="chat-content" class="flex-1 flex flex-col min-h-0">
                <div id="chat-messages" class="flex-1 overflow-y-auto">
                    <div class="p-4 pb-0">
                        <div class="flex items-start space-x-3 mb-4">
                            <div class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-200 flex items-center justify-center">
                                <img id="creator-picks-greeting-avatar" class="w-full h-full object-cover" src="https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png" alt="ShAI avatar" data-shai-avatar onerror="this.style.display='none';this.nextElementSibling?.classList.remove('hidden')">
                                <span class="text-gray-500 text-sm font-medium hidden">AI</span>
                            </div>
                            <div class="flex-1">
                                <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-[80%] mb-3">
                                    <p class="text-sm text-black break-words whitespace-pre-wrap">Discover amazing collections from your favorite creators! Which style catches your eye?</p>
                                </div>
                                <div id="smart-prompts" class="flex flex-wrap gap-2 pb-2">
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">What's trending?</button>
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Find pieces in my size</button>
                                    <button class="bg-white border border-[#B7C7FF] text-[#939BFB] px-3 py-1.5 rounded-full text-xs font-medium flex-shrink-0 hover:bg-[#939BFB] hover:text-white transition-colors">Budget-friendly styles</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input Bar - Inside Drawer -->
                <div id="chat-input-drawer-wrap" class="bg-white border-t border-gray-100 p-4 flex-shrink-0">
                    <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm">
                        <button id="cam-btn-drawer" class="icon-button hover:opacity-70 transition-opacity" aria-label="Add image or video">
                            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg>
                        </button>
                        <textarea id="chat-input-drawer" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 dm-sans resize-none min-h-[24px] max-h-[144px] overflow-y-auto" rows="1"></textarea>
                        <button id="add-friend-drawer" class="icon-button hover:opacity-70 transition-opacity">
                            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg>
                        </button>
                        <button id="mic-btn-drawer" class="icon-button hover:opacity-70 transition-opacity" aria-label="Record voice">
                            <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg>
                        </button>
                        <button id="send-btn-drawer" class="icon-button text-[#939BFB] hidden hover:opacity-70 transition-opacity" aria-label="Send">
                            <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Friend Flow Content - match Home/design system -->
            <div id="add-friend-flow" class="flex-1 flex flex-col min-h-0 hidden">
                <div id="contact-list" class="flex-1 overflow-y-auto p-4">
                    <div class="mb-4">
                        <div class="relative">
                            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
                            <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 pl-10 text-sm">
                        </div>
                    </div>
                    <div id="contacts-container" class="space-y-2"><!-- Contacts rendered dynamically --></div>
                </div>
            </div>
        </div>

        <!-- Chat Input Bar - Collapsed State - always visible when drawer closed -->
        <div id="chat-input-bar" class="fixed bottom-16 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 p-4 z-30">
            <div class="flex items-center gap-2 bg-white rounded-2xl border border-gray-200 px-4 py-3 shadow-sm">
                <button id="cam-btn" class="icon-button hover:opacity-70 transition-opacity" aria-label="Add image or video">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg>
                </button>
                <textarea id="message-input" placeholder="Message ShAI..." class="flex-1 bg-transparent outline-none text-black placeholder-gray-500 dm-sans resize-none min-h-[24px] max-h-[144px] overflow-y-auto" rows="1"></textarea>
                <button id="add-friend-btn" class="icon-button hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z"/></svg>
                </button>
                <button id="mic-btn" class="icon-button hover:opacity-70 transition-opacity" aria-label="Record voice">
                    <svg class="w-[18px] h-[18px] text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg>
                </button>
                <button id="send-btn" class="text-[#939BFB] hidden hover:opacity-70 transition-opacity">
                    <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg>
                </button>
            </div>
        </div>

    <!-- Bottom Navigation - match Creator Collections -->
    <nav id="bottom-navigation" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-[390px] bg-white border-t border-gray-100 z-50">
        <div class="flex items-center justify-around py-2">
            <a href="Home.html" class="bottom-nav-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
                <span class="text-xs">Home</span>
            </a>
            <a href="Picks.html" class="bottom-nav-btn active">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/></svg>
                <span class="text-xs">Picks</span>
            </a>
            <a href="Wishlist.html" class="bottom-nav-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg>
                <span class="text-xs">Wishlist</span>
            </a>
            <a id="picks-nav-profile-link" href="User_Profile_Free_Plan.html" class="bottom-nav-btn">
                <span id="picks-nav-profile-icon" class="flex items-center justify-center w-6 h-6 mb-1 text-shine-primary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
                </span>
                <img id="picks-nav-profile-photo" class="w-6 h-6 rounded-full object-cover mb-1 hidden" src="" alt="Profile">
                <span class="text-xs">Profile</span>
            </a>
        </div>
    </nav>
    <script src="js/chat-dock-nav.js"></script>
    <script>
    (function() {
        var plan = (localStorage.getItem('__userPlan') || '').toLowerCase();
        var profileHref = (plan === 'paid' || plan === 'true') ? 'User_Profile_Paid_Plan.html' : 'User_Profile_Free_Plan.html';
        var profileLink = document.getElementById('picks-nav-profile-link');
        if (profileLink) profileLink.href = profileHref;
        var saved = null;
        try { saved = localStorage.getItem('profilePhoto'); } catch (e) {}
        var img = document.getElementById('picks-nav-profile-photo');
        var icon = document.getElementById('picks-nav-profile-icon');
        if (img && icon) {
            if (saved) { img.src = saved; img.classList.remove('hidden'); icon.classList.add('hidden'); }
            else { img.classList.add('hidden'); icon.classList.remove('hidden'); }
        }
        window.setProfilePhoto = function(url) {
            try { if (url) localStorage.setItem('profilePhoto', url); else localStorage.removeItem('profilePhoto'); } catch (e) {}
            var i = document.getElementById('picks-nav-profile-photo');
            var ic = document.getElementById('picks-nav-profile-icon');
            if (i && ic) {
                if (url) { i.src = url; i.classList.remove('hidden'); ic.classList.add('hidden'); }
                else { i.src = ''; i.classList.add('hidden'); ic.classList.remove('hidden'); }
            }
        };
    })();
    </script>

    </div><!-- end app-shell -->

    <script>
        var collectionWishlist = new Set(['work-week-essentials']);
        window.toggleCollectionWishlist = function(btn) {
            var id = (btn && btn.dataset && btn.dataset.collectionId) || (btn && btn.closest && btn.closest('.collection-tile') && btn.closest('.collection-tile').dataset && btn.closest('.collection-tile').dataset.collectionId);
            if (!id) return;
            var svg = btn && btn.querySelector('svg');
            if (collectionWishlist.has(id)) {
                collectionWishlist.delete(id);
                if (svg) { svg.classList.remove('heart-filled'); svg.setAttribute('fill', 'none'); svg.setAttribute('stroke', 'currentColor'); }
            } else {
                collectionWishlist.add(id);
                if (svg) { svg.classList.add('heart-filled'); svg.setAttribute('fill', '#939BFB'); svg.setAttribute('stroke', '#939BFB'); }
            }
        };
        window.shareCollection = function(name) {
            var base = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
            var shareUrl = base + "Creator`s Single_Collection.html?collection=" + encodeURIComponent(name || '');
            var d = { title: (name || '') + ' - GoShopMe', text: 'Check out this collection on GoShopMe', url: shareUrl };
            if (navigator.share) navigator.share(d).catch(function() { if (navigator.clipboard) navigator.clipboard.writeText(d.text + ' ' + d.url); });
            else if (navigator.clipboard) navigator.clipboard.writeText(d.text + ' ' + d.url);
        };
        /** Sample data for Creator Picks. Replace with API call; pass to loadCreatorPicksData(). */
        var SAMPLE_CREATORS = [
            { id: 'emma-style', name: 'Emma Style', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-5.jpg', tagline: 'Bold evening edits', collections: [
                { id: 'paris-spring', name: 'Paris in Spring', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/278b6d1110-b06029a51757c766cbe6.png', itemCount: 7, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a1fa951de5-1df3707f3a394528a723.png', 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a5a5c3117b-e552b0101625253f2e63.png', 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/5f3cd8d80d-86184dd368f92c3bd86a.png'] },
                { id: 'work-week-essentials', name: 'Work Week Essentials', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/486bd6818f-a15b8b6d17a566d04183.png', itemCount: 12, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/7e094a771c-f075ee55c692dad6fbaa.png', 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/1c28bc4fa5-25ed7e84931d74632079.png', 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c04fdb7242-ad37b9466fca9d34e8f1.png'] },
                { id: 'date-night-ready', name: 'Date Night Ready', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/7c640ee900-49da491c48a25226f4d3.png', itemCount: 6, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/1d822aec75-b3cb13c31948045b34c1.png', 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c62b5fd602-4418e43e7e210d817e4d.png'] }
            ]},
            { id: 'anna-rivera', name: 'Anna Rivera', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-6.jpg', tagline: 'Minimalist cool', collections: [
                { id: 'power-business', name: 'Power Business', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/b13c2b21e8-e2e6c6512286c20cbd44.png', itemCount: 8, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/b13c2b21e8-e2e6c6512286c20cbd44.png'] },
                { id: 'minimalist-basics', name: 'Minimalist Basics', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a237d37f08-9183f2271467bd16514a.png', itemCount: 10, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a237d37f08-9183f2271467bd16514a.png'] }
            ]},
            { id: 'sofia-chen', name: 'Sofia Chen', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-7.jpg', tagline: 'Weekend vibes', collections: [
                { id: 'weekend-casual', name: 'Weekend Casual', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a16416caa3-176574d362901d57a338.png', itemCount: 9, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/a16416caa3-176574d362901d57a338.png'] },
                { id: 'cozy-layered', name: 'Cozy Layered', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/cba1ef9ed4-2a4abf50b1ec50c51ddd.png', itemCount: 7, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/cba1ef9ed4-2a4abf50b1ec50c51ddd.png'] }
            ]},
            { id: 'maya-johnson', name: 'Maya Johnson', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-1.jpg', tagline: 'Street style', collections: [
                { id: 'urban-street', name: 'Urban Street Style', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/02814a6d7b-0207c0fd9ce4694eb9ed.png', itemCount: 11, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/02814a6d7b-0207c0fd9ce4694eb9ed.png'] },
                { id: 'sneaker-fashion', name: 'Sneaker Fashion', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/64c66e6d0e-91cec063e572905c683c.png', itemCount: 8, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/64c66e6d0e-91cec063e572905c683c.png'] }
            ]},
            { id: 'alex-kim', name: 'Alex Kim', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-8.jpg', tagline: 'Athleisure', collections: [
                { id: 'athleisure-gym', name: 'Athleisure Gym to Street', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/73024ae4b1-a0a9c28bc4907d22ac6b.png', itemCount: 10, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/73024ae4b1-a0a9c28bc4907d22ac6b.png'] },
                { id: 'active-lifestyle', name: 'Active Lifestyle', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/4e2d3c7b9a-497abef6a977f5abdef1.png', itemCount: 6, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/4e2d3c7b9a-497abef6a977f5abdef1.png'] }
            ]},
            { id: 'zoe-martinez', name: 'Zoe Martinez', avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-9.jpg', tagline: 'Retro revival', collections: [
                { id: 'retro-vintage', name: 'Retro Vintage Revival', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c1edec7423-160beffc50d92dc988c2.png', itemCount: 12, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c1edec7423-160beffc50d92dc988c2.png'] },
                { id: '90s-fashion', name: '90s Fashion Throwback', coverImage: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c446a619d5-f94ec3967727fcde88dd.png', itemCount: 9, itemThumbnails: ['https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/c446a619d5-f94ec3967727fcde88dd.png'] }
            ]}
        ];
        /**
         * Load Creator Picks dynamically. Call with data from your API.
         * @param {Array} creators - Array of { id, name, avatar?, tagline, collections: [{ id, name, coverImage, coverVideo?, coverType?, itemCount, itemThumbnails? }] }
         */
        window.loadCreatorPicksData = function(creators) {
            function getInitials(name) {
                if (!name) return '?';
                var parts = name.trim().split(/\s+/);
                if (parts.length >= 2) return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
                return name.charAt(0).toUpperCase();
            }
            var container = document.getElementById('creator-picks-container');
            var bg = document.getElementById('background-content');
            if (!container || !bg) return;
            var list = Array.isArray(creators) ? creators : [];
            window.__creatorPicksCreators = {};
            list.forEach(function(c) { window.__creatorPicksCreators[c.id || ''] = c; });
            var html = '';
            list.forEach(function(creator, idx) {
                var sectionClass = idx % 2 === 0 ? 'px-4 py-6 creator-block' : 'px-4 py-6 bg-gray-50 border-y border-gray-100 creator-block';
                var avatarHtml = creator.avatar
                    ? '<img class="w-14 h-14 rounded-full object-cover border-2 border-[#939bfb]/20" src="' + (creator.avatar || '').replace(/"/g, '&quot;') + '" alt="' + (creator.name || '').replace(/"/g, '&quot;') + '">'
                    : '<div class="w-14 h-14 rounded-full bg-gray-200 flex items-center justify-center border-2 border-[#939bfb]/20"><span class="text-gray-600 font-medium text-lg">' + getInitials(creator.name) + '</span></div>';
                var collectionsHtml = (creator.collections || []).map(function(col) {
                    var slug = (col.id || col.name || '').toLowerCase().replace(/\s+/g, '-');
                    var isWishlisted = (typeof collectionWishlist !== 'undefined' && collectionWishlist.has(slug));
                    var heartClass = isWishlisted ? ' heart-filled" fill="#939BFB" stroke="#939BFB"' : '" fill="none" stroke="currentColor"';
                    var coverType = col.coverType || 'image';
                    var coverUrl = col.coverImage || col.coverVideo || '';
                    var coverHtml = '';
                    var showTopPosition = slug === 'power-business';
                    var posClass = showTopPosition ? ' object-top' : '';
                    if (coverType === 'video' && coverUrl) {
                        coverHtml = '<video class="w-full h-40 object-cover' + posClass + '" src="' + coverUrl.replace(/"/g, '&quot;') + '" autoplay muted loop playsinline></video>';
                    } else {
                        coverHtml = '<img class="w-full h-40 object-cover' + posClass + '" src="' + coverUrl.replace(/"/g, '&quot;') + '" alt="' + (col.name || '').replace(/"/g, '&quot;') + '"/>';
                    }
                    return '<div class="flex-shrink-0 w-48 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer collection-tile" data-collection-id="' + (slug || '').replace(/"/g, '&quot;') + '" data-creator="' + (creator.name || '').replace(/"/g, '&quot;') + '"><div class="relative product-image-overlay-wrap">' + coverHtml + '<div class="absolute top-3 right-3 flex flex-col space-y-2"><button class="p-1 collection-wishlist-btn flex items-center justify-center hover:opacity-80 transition-opacity" data-collection-id="' + slug + '" onclick="event.stopPropagation(); window.toggleCollectionWishlist(this);"><svg class="w-[18px] h-[18px] text-white product-overlay-icon' + heartClass + ' viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg></button><button class="p-1 share-collection-btn flex items-center justify-center hover:opacity-80 transition-opacity" onclick="event.stopPropagation(); window.shareCollection(\'' + (col.name || '').replace(/'/g, "\\'") + '\');"><svg class="w-[18px] h-[18px] text-white product-overlay-icon share-icon-tilted" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"/></svg></button><button class="p-1 chat-trigger flex items-center justify-center hover:opacity-80 transition-opacity" data-collection="' + (col.name || '').replace(/"/g, '&quot;') + '" onclick="event.stopPropagation();"><svg class="w-4 h-4 text-white product-overlay-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/></svg></button></div></div><div class="p-3"><h4 class="font-medium text-black text-sm mb-1">' + (col.name || '').replace(/</g, '&lt;') + '</h4><p class="text-xs text-gray-500">' + (col.itemCount || 0) + ' items</p></div></div>';
                }).join('');
                html += '<section class="' + sectionClass + '" data-creator-id="' + (creator.id || '').replace(/"/g, '&quot;') + '"><div class="container-mobile"><div class="flex items-center justify-between mb-4"><div class="flex items-center space-x-3">' + avatarHtml + '<div><h3 class="text-lg font-fahkwang font-bold text-black">' + (creator.name || '').replace(/</g, '&lt;') + '</h3><p class="text-sm text-gray-600">' + (creator.tagline || '').replace(/</g, '&lt;') + '</p></div></div><a href="Creator`s Collections_Page.html?creator=' + encodeURIComponent(creator.id || '') + '" class="view-all-creator-link text-[#939bfb] text-sm font-medium underline hover:opacity-80 transition-opacity">View all</a></div><div class="flex space-x-4 overflow-x-auto pb-2">' + collectionsHtml + '</div></div></section>';
            });
            container.innerHTML = html;
            var staticBlocks = bg.querySelectorAll('.creator-block-static, [id^="creator-block-"]');
            for (var i = 0; i < staticBlocks.length; i++) { staticBlocks[i].remove(); }
        };
        window.setShAIAvatar = function(url) {
            window.__shaiAvatarUrl = url || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
            var img = document.getElementById('shai-avatar');
            var ph = document.getElementById('shai-avatar-placeholder');
            var greetingImg = document.getElementById('creator-picks-greeting-avatar');
            if (img && ph) {
                if (url) { img.src = url; img.classList.remove('hidden'); ph.classList.add('hidden'); img.removeAttribute('data-placeholder'); }
                else { img.src = ''; img.classList.add('hidden'); ph.classList.remove('hidden'); img.setAttribute('data-placeholder', 'true'); }
            }
            if (greetingImg) { if (url) { greetingImg.src = url; greetingImg.style.display = ''; greetingImg.nextElementSibling?.classList.add('hidden'); } else { greetingImg.src = ''; greetingImg.style.display = 'none'; greetingImg.nextElementSibling?.classList.remove('hidden'); } }
        };
        window.testShAIAvatar = function(url) {
            var testUrl = url || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-2.jpg';
            window.setShAIAvatar(testUrl);
            var drawer = document.getElementById('shai-chat-drawer');
            if (drawer && drawer.classList.contains('translate-y-full')) { document.getElementById('chat-overlay').classList.remove('hidden'); drawer.classList.remove('translate-y-full'); drawer.style.height = '50vh'; }
            console.log('testShAIAvatar:', testUrl);
        };
        function getShAIAvatarHtml(size) {
            var img = document.getElementById('shai-avatar');
            var url = (img && img.src ? img.src : '') || window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
            var sz = size || 'w-8 h-8';
            if (url) return '<img class="' + sz + ' rounded-full object-cover flex-shrink-0" src="' + url.replace(/"/g, '&quot;') + '" alt="ShAI avatar">';
            return '<div class="' + sz + ' rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-500 text-xs font-medium">AI</span></div>';
        }
        document.addEventListener('DOMContentLoaded', async function() {
            var creators = window.__creatorPicksData || null;
            if (!creators && typeof window.GoShopMePicksAPI !== 'undefined') {
                creators = await window.GoShopMePicksAPI.fetchCreatorPicks();
            }
            if (!creators) creators = SAMPLE_CREATORS;
            if (typeof window.loadCreatorPicksData === 'function') {
                window.loadCreatorPicksData(creators);
            }
            if (typeof window.setShAIAvatar === 'function') { window.__shaiAvatarUrl = 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png'; window.setShAIAvatar('https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png'); }
            const chatDrawer = document.getElementById('shai-chat-drawer');
            const chatOverlay = document.getElementById('chat-overlay');
            const chatInputCollapsedField = document.getElementById('message-input');
            const chatInputDrawer = document.getElementById('chat-input-drawer');
            const sendButtonDrawer = document.getElementById('send-btn-drawer');
            const micButtonDrawer = document.getElementById('mic-btn-drawer');
            const sendButtonCollapsed = document.getElementById('send-btn');
            const micButtonCollapsed = document.getElementById('mic-btn');
            const bottomNavigation = document.getElementById('bottom-navigation');
            const chatTriggers = document.querySelectorAll('.chat-trigger');
            const backgroundContent = document.getElementById('background-content');
            const dragHandleZone = document.getElementById('drag-handle-zone') || document.querySelector('.drag-handle');
            const chatMessages = document.getElementById('chat-messages');
            const chatMessagesContainer = document.querySelector('#chat-messages .p-4');
            const addFriendFlow = document.getElementById('add-friend-flow');
            function scrollChatToBottom() {
                if (chatMessages) {
                    requestAnimationFrame(function() { chatMessages.scrollTop = chatMessages.scrollHeight; });
                }
            }
            const backButton = document.getElementById('back-button');
            const addFriendDrawer = document.getElementById('add-friend-drawer');
            const chatInputBar = document.getElementById('chat-input-bar');
            
            let isDrawerExpanded = false;
            let isAddFriendMode = false;
            let drawerHeight = 50;
            const minHeight = 20;
            const HEADER_PLUS_BOTTOM = 144;
            const maxHeight = Math.min(90, ((window.innerHeight - HEADER_PLUS_BOTTOM) / window.innerHeight) * 100);
            
            // Drag handle functionality
            let isDragging = false;
            let startY = 0;
            let startHeight = 0;

            dragHandleZone.addEventListener('mousedown', startDrag);
            dragHandleZone.addEventListener('touchstart', startDrag, { passive: true });

            function startDrag(e) {
                isDragging = true;
                startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
                startHeight = drawerHeight;
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);
                document.addEventListener('touchcancel', stopDrag);
                e.preventDefault();
            }

            function drag(e) {
                if (!isDragging) return;
                
                const currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
                const deltaY = startY - currentY;
                const newHeight = Math.min(maxHeight, Math.max(minHeight, startHeight + (deltaY / window.innerHeight) * 100));
                
                drawerHeight = newHeight;
                chatDrawer.style.height = `${drawerHeight}vh`;
            }

            function stopDrag() {
                if (!isDragging) return;
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
                document.removeEventListener('touchcancel', stopDrag);
                const h = (chatDrawer.getBoundingClientRect().height / window.innerHeight) * 100;
                if (h < 35) collapseDrawer();
                else { drawerHeight = Math.max(minHeight, Math.min(maxHeight, h)); chatDrawer.style.height = drawerHeight + 'vh'; }
            }

            const chatContent = document.getElementById('chat-content');
            const headerTitle = document.getElementById('header-title');
            const headerSubtitle = document.getElementById('header-subtitle');
            function showAddFriendFlow() {
                isAddFriendMode = true;
                if (chatContent) chatContent.classList.add('hidden');
                if (addFriendFlow) addFriendFlow.classList.remove('hidden');
                if (backButton) backButton.classList.remove('hidden');
                if (headerTitle) headerTitle.textContent = 'Add Friend';
                if (headerSubtitle) headerSubtitle.textContent = 'Choose contacts to add';
                expandDrawer();
            }
            function hideAddFriendFlow() {
                isAddFriendMode = false;
                if (chatContent) chatContent.classList.remove('hidden');
                if (addFriendFlow) addFriendFlow.classList.add('hidden');
                if (backButton) backButton.classList.add('hidden');
                if (headerTitle) headerTitle.textContent = 'ShAI';
                if (headerSubtitle) headerSubtitle.textContent = 'Your shopping assistant';
                const contactSearch = document.getElementById('contact-search');
                if (contactSearch) { contactSearch.value = ''; filterContacts(''); }
            }

            const addFriendBtn = document.getElementById('add-friend-btn');
            addFriendDrawer.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); showAddFriendFlow(); });
            if (addFriendBtn) addFriendBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); if (!isDrawerExpanded) expandDrawer(); setTimeout(showAddFriendFlow, 300); });

            backButton.addEventListener('click', hideAddFriendFlow);

            // Add Friend contacts: dynamic. Same pattern as Home - goshopme+avatar=photo, else initials.
            // GoShopMe user with uploaded picture -> show photo; GoShopMe user without -> initials; non-GoShopMe -> initials
            const contactsContainer = document.getElementById('contacts-container');
            const contactSearch = document.getElementById('contact-search');
            window.__addFriendContacts = window.__addFriendContacts || [
                { name: 'Emma Wilson', phone: '+1 (555) 123-4567', goshopme: true, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-2.jpg' },
                { name: 'Mike Johnson', phone: '+1 (555) 987-6543', goshopme: true, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-3.jpg' },
                { name: 'Sarah Lee', phone: '+1 (555) 456-7890', goshopme: false },
                { name: 'David Martinez', phone: '+1 (555) 321-0987', goshopme: false },
                { name: 'Lisa Chen', phone: '+1 (555) 654-3210', goshopme: true, avatar: 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/avatars/avatar-4.jpg' },
                { name: 'Tom Kim', phone: '+1 (555) 789-0123', goshopme: false },
                { name: 'Alex Johnson', phone: '+1 (555) 111-2222', goshopme: true }
            ];
            function getInitials(name) {
                const parts = (name || '').trim().split(/\s+/);
                if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
                return (parts[0] ? parts[0].slice(0, 2) : '??').toUpperCase();
            }
            function renderAddFriendContacts(container) {
                if (!container) return;
                const list = Array.isArray(window.__addFriendContacts) ? window.__addFriendContacts : [];
                container.innerHTML = list.map(c => {
                    const initials = getInitials(c.name);
                    const hasAvatar = c.goshopme && c.avatar;
                    const avatarHtml = hasAvatar
                        ? `<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img src="${(c.avatar || '').replace(/"/g, '&quot;')}" alt="${(c.name || '').replace(/"/g, '&quot;')}" class="w-full h-full object-cover"></div>`
                        : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-600 font-medium text-xs">${initials}</span></div>`;
                    const btnHtml = c.goshopme
                        ? '<button class="contact-action bg-[#939BFB] text-white px-2 py-1 rounded-full text-xs font-medium">Add</button>'
                        : '<button class="contact-action bg-white text-[#939BFB] px-2 py-1 rounded-full text-xs font-medium border border-[#939BFB]">Invite</button>';
                    return `<div class="contact-item flex items-center gap-2 p-2 bg-gray-50 rounded-xl" data-name="${(c.name || '').replace(/"/g, '&quot;')}" data-phone="${(c.phone || '').replace(/"/g, '&quot;')}" data-goshopme="${c.goshopme ? 'true' : 'false'}">${avatarHtml}<div class="flex-1"><p class="font-medium text-sm text-black">${(c.name || '').replace(/</g, '&lt;')}</p><p class="text-xs text-gray-500">${(c.phone || '').replace(/</g, '&lt;')}</p></div>${btnHtml}</div>`;
                }).join('');
            }
            window.loadAddFriendContacts = function(data) {
                window.__addFriendContacts = Array.isArray(data) ? data : [];
                renderAddFriendContacts(contactsContainer);
            };
            renderAddFriendContacts(contactsContainer);
            function filterContacts(term) {
                const items = contactsContainer ? contactsContainer.querySelectorAll('.contact-item') : [];
                const t = (term || '').toLowerCase();
                items.forEach(el => {
                    const match = ((el.getAttribute('data-name') || '') + (el.getAttribute('data-phone') || '')).toLowerCase().includes(t);
                    el.style.display = match ? 'flex' : 'none';
                });
            }
            if (contactSearch) contactSearch.addEventListener('input', function() { filterContacts(this.value); });
            backButton.addEventListener('click', function() {
                if (contactSearch) contactSearch.value = '';
                filterContacts('');
            });
            contactsContainer.addEventListener('click', function(e) {
                if (!e.target.classList.contains('contact-action')) return;
                const contactItem = e.target.closest('.contact-item');
                if (!contactItem) return;
                const contactName = (contactItem.querySelector('p') || {}).textContent || '';
                const isGoshopmeUser = contactItem.getAttribute('data-goshopme') === 'true';
                if (!isGoshopmeUser && navigator.share) {
                    navigator.share({ title: 'Join me on GoShopMe', text: "Hey! I'm using GoShopMe. It's faster, smarter and effortless &mdash; join me", url: 'https://app.goshopme.ai' }).catch(() => {});
                }
                hideAddFriendFlow();
                const notification = document.createElement('div');
                notification.className = 'flex justify-center mb-4';
                notification.innerHTML = `<div class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-xs font-medium">${contactName.split(' ')[0]} has been ${isGoshopmeUser ? 'added to chat' : 'invited to GoShopMe'}</div>`;
                if (chatMessagesContainer) chatMessagesContainer.appendChild(notification);
                scrollChatToBottom();
            });

            // Click on main screen to collapse drawer
            backgroundContent.addEventListener('click', () => {
                if (isDrawerExpanded) {
                    collapseDrawer();
                }
            });

            // Click on overlay to collapse drawer
            chatOverlay.addEventListener('click', () => {
                if (isDrawerExpanded) {
                    collapseDrawer();
                }
            });

            // Collection chat triggers - with thumbnails (match Creator Collections)
            function handleChatTriggerClick(e) {
                const trigger = e.target.closest('.chat-trigger');
                if (!trigger) return;
                e.stopPropagation();
                const collectionName = trigger.dataset.collection || '';
                if (!collectionName) return;
                expandDrawer();
                
                // Find collection from creator picks data
                var col = null;
                if (window.__creatorPicksCreators) {
                    for (var creatorId in window.__creatorPicksCreators) {
                        var creator = window.__creatorPicksCreators[creatorId];
                        if (creator && creator.collections) {
                            col = creator.collections.find(function(c) { return (c.name || '') === collectionName; });
                            if (col) break;
                        }
                    }
                }
                
                // Get thumbnails: use itemThumbnails if available, else fallback to coverImage
                var thumbs = [];
                if (col) {
                    if (col.itemThumbnails && Array.isArray(col.itemThumbnails) && col.itemThumbnails.length) {
                        thumbs = col.itemThumbnails.slice(0, 4);
                    } else if (col.coverImage) {
                        thumbs = [col.coverImage];
                    }
                }
                
                // Add contextual message with thumbnails
                const contextMessage = document.createElement('div');
                contextMessage.className = 'flex items-start space-x-3 mb-4';
                const avatarHtml = typeof getShAIAvatarHtml === 'function' ? getShAIAvatarHtml('w-8 h-8') : '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-500 text-xs font-medium">AI</span></div>';
                const thumbHtml = thumbs.length ? '<div class="flex gap-1.5 mt-2 flex-wrap">' + thumbs.slice(0, 4).map(function(t) { return '<img class="w-12 h-12 rounded-lg object-cover border border-gray-200" src="' + (t || '').replace(/"/g, '&quot;') + '" alt="">'; }).join('') + '</div>' : '';
                contextMessage.innerHTML = avatarHtml + '<div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-xs"><p class="text-sm text-black break-words whitespace-pre-wrap">Want the entire "' + (collectionName || '').replace(/</g, '&lt;') + '" look? I\'ll help you shop it!</p>' + thumbHtml + '</div>';
                if (chatMessagesContainer) chatMessagesContainer.appendChild(contextMessage);
                scrollChatToBottom();
            }
            
            // Use event delegation for dynamically added chat triggers
            document.addEventListener('click', function(e) {
                if (e.target.closest('.chat-trigger')) {
                    handleChatTriggerClick(e);
                }
            }, true);
            
            // Also handle existing static triggers
            chatTriggers.forEach(trigger => {
                trigger.addEventListener('click', handleChatTriggerClick);
            });

            // Expand drawer when tapping chat input bar or message input - match Home
            if (chatInputBar) chatInputBar.addEventListener('click', function(e) { if (!isDrawerExpanded) { expandDrawer(); setTimeout(function() { if (chatInputDrawer) chatInputDrawer.focus(); }, 300); } });
            if (chatInputCollapsedField) {
                chatInputCollapsedField.addEventListener('click', function() { expandDrawer(); setTimeout(function() { if (chatInputDrawer) chatInputDrawer.focus(); }, 300); });
                chatInputCollapsedField.addEventListener('focus', function() { expandDrawer(); setTimeout(function() { if (chatInputDrawer) chatInputDrawer.focus(); }, 300); });
            }
            // Camera button - open file picker for images/videos (match Home)
            function handleCameraAccess() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*';
                input.onchange = function(e) {
                    var file = e.target.files && e.target.files[0];
                        if (file) {
                        var url = URL.createObjectURL(file);
                        var isImage = file.type.indexOf('image') === 0;
                        if (chatMessagesContainer) {
                            var bubble = document.createElement('div');
                            bubble.className = 'flex justify-end mb-4';
                            if (isImage) bubble.innerHTML = '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden shadow-sm"><img src="' + url + '" class="w-full h-auto" alt="Uploaded image"></div>';
                            else if (file.type.indexOf('video') === 0) bubble.innerHTML = '<div class="rounded-2xl border border-[#939BFB] max-w-[60%] overflow-hidden"><video src="' + url + '" controls class="w-full h-auto"></video></div>';
                            if (bubble.innerHTML) { chatMessagesContainer.appendChild(bubble); scrollChatToBottom(); }
                            var aiReply = isImage ? "I can see your image! Let me find similar products for you." : "Got your video! Let me analyze it and find matching products.";
                            setTimeout(function() {
                                if (!chatMessagesContainer) return;
                                var avatarUrl = (document.getElementById('shai-avatar') || {}).src || window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
                                var aiResponse = document.createElement('div');
                                aiResponse.className = 'flex items-start space-x-3 mb-4';
                                aiResponse.innerHTML = (typeof getShAIAvatarHtml === 'function' ? getShAIAvatarHtml('w-8 h-8') : '<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img class="w-full h-full object-cover" src="' + (avatarUrl || '').replace(/"/g, '&quot;') + '" alt="ShAI" data-shai-avatar /></div>') + '<div class="flex-1"><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-[80%]"><p class="text-sm text-black">' + aiReply.replace(/</g, '&lt;') + '</p></div></div>';
                                chatMessagesContainer.appendChild(aiResponse);
                                scrollChatToBottom();
                            }, 1500);
                        }
                        input.value = '';
                    }
                };
                input.click();
            }
            var camBtn = document.getElementById('cam-btn');
            if (camBtn) camBtn.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); if (!isDrawerExpanded) expandDrawer(); setTimeout(handleCameraAccess, 300); });
            if (document.getElementById('cam-btn-drawer')) document.getElementById('cam-btn-drawer').addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); handleCameraAccess(); });

            // Voice recording (hold-to-record) - match Home
            function showToast(msg) {
                var t = document.createElement('div');
                t.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black text-white px-4 py-2 rounded-full text-sm z-50';
                t.textContent = msg;
                document.body.appendChild(t);
                setTimeout(function() { t.remove(); }, 3000);
            }
            var mediaStream = null, mediaRecorder = null, audioChunks = [], isRecording = false, startX = 0, micAccessDenied = false;
            function removeTempRecordingBubble() {
                var t = document.getElementById('temp-recording');
                if (t) t.remove();
            }
            async function startRecording(e) {
                e.preventDefault();
                removeTempRecordingBubble();
                if (!isDrawerExpanded) { expandDrawer(); return; }
                if (micAccessDenied) {
                    showToast('Microphone access denied. Enable it in your browser settings to record voice messages.');
                    return;
                }
                startX = e.touches ? e.touches[0].clientX : e.clientX;
                try {
                    if (!mediaStream || !mediaStream.active) mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(mediaStream);
                    isRecording = true;
                    audioChunks = [];
                    mediaRecorder.ondataavailable = function(ev) { if (ev.data.size > 0) audioChunks.push(ev.data); };
                    mediaRecorder.start();
                    this.classList.add('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
                    if (chatMessagesContainer) {
                        var tempBubble = document.createElement('div');
                        tempBubble.id = 'temp-recording';
                        tempBubble.className = 'flex justify-end mb-2';
                        tempBubble.innerHTML = '<div class="flex items-center bg-[#939BFB] text-white rounded-2xl px-3 py-2 max-w-[70%]"><svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/></svg><span class="text-xs">Recording... swipe left to cancel</span></div>';
                        chatMessagesContainer.appendChild(tempBubble);
                        scrollChatToBottom();
                    }
                } catch (err) {
                    removeTempRecordingBubble();
                    if (err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')) {
                        micAccessDenied = true;
                        showToast('Microphone access denied. Enable it in your browser settings to record voice messages.');
                    } else {
                        showToast('Could not access microphone. Please try again.');
                        console.warn('Microphone error:', err);
                    }
                }
            }
            function stopRecording(e) {
                e.preventDefault();
                if (!isRecording) return;
                isRecording = false;
                this.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
                removeTempRecordingBubble();
                if (mediaRecorder) {
                    mediaRecorder.stop();
                    mediaRecorder.onstop = function() {
                        var audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        var audioUrl = URL.createObjectURL(audioBlob);
                        renderAudioBubble(audioUrl);
                    };
                }
            }
            function cancelRecording(e) {
                if (!isRecording) return;
                isRecording = false;
                this.classList.remove('scale-110', 'ring-2', 'ring-[#939BFB]', 'ring-offset-2');
                removeTempRecordingBubble();
                if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            }
            function handleSwipeCancel(e) {
                if (!isRecording || !e.touches || !e.touches.length) return;
                var curX = e.touches[0].clientX;
                if (startX - curX > 30) cancelRecording.call(this, e);
            }
            function renderAudioBubble(url) {
                if (!chatMessagesContainer) return;
                var bubble = document.createElement('div');
                bubble.className = 'flex justify-end mb-2';
                bubble.innerHTML = '<div role="group" aria-label="Voice message from you" class="voice-message-bubble bg-[#939BFB] text-white rounded-full px-3 py-2 flex items-center gap-2 h-11 shadow-sm">' +
                    '<button aria-label="Play voice message from you" class="play-btn flex-shrink-0 w-6 h-6 border border-white rounded-full flex items-center justify-center hover:bg-white/20 transition-all duration-150 hover:scale-105" onclick="toggleVoicePlayback(this, \'' + url + '\')">' +
                    '<svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>' +
                    '<div class="waveform flex-1 flex items-center justify-center gap-0.5 h-4 max-w-[120px]">' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 0"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 1"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 2"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 16px; --i: 3"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 4"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 14px; --i: 5"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 8px; --i: 6"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 12px; --i: 7"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 6px; --i: 8"></div>' +
                    '<div class="wave-bar w-0.5 bg-white/90 rounded-full transition-all duration-300" style="height: 10px; --i: 9"></div></div>' +
                    '<span class="duration-text text-white/90 text-xs font-medium flex-shrink-0">0:00</span>' +
                    '<audio src="' + url + '" preload="auto" class="hidden"></audio></div>';
                chatMessagesContainer.appendChild(bubble);
                var audio = bubble.querySelector('audio');
                var durationText = bubble.querySelector('.duration-text');
                if (audio && durationText) audio.addEventListener('loadedmetadata', function() {
                    var d = Math.ceil(audio.duration);
                    durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
                });
                scrollChatToBottom();
                setTimeout(function() {
                    if (!chatMessagesContainer) return;
                    var avatarUrl = (document.getElementById('shai-avatar') || {}).src || window.__shaiAvatarUrl || 'https://raw.githubusercontent.com/nora-todorova/GoShopMe-assets/main/assets/shai-avatar.png';
                    var aiResponse = document.createElement('div');
                    aiResponse.className = 'flex items-start space-x-3 mb-4';
                    aiResponse.innerHTML = '<div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0"><img class="w-full h-full object-cover" src="' + (avatarUrl || '').replace(/"/g, '&quot;') + '" alt="ShAI" data-shai-avatar /></div><div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-[80%]"><p class="text-sm text-black">Got your voice message! I\'m on it &mdash; let me find the best options for you.</p></div>';
                    chatMessagesContainer.appendChild(aiResponse);
                    scrollChatToBottom();
                }, 800);
            }
            window.toggleVoicePlayback = function(button, audioUrl) {
                var container = button.closest('.voice-message-bubble');
                var audio = container.querySelector('audio');
                var playIcon = button.querySelector('svg');
                var waveBars = container.querySelectorAll('.wave-bar');
                var durationText = container.querySelector('.duration-text');
                if (audio.paused) {
                    audio.play();
                    playIcon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
                    waveBars.forEach(function(bar, i) {
                        bar.style.animation = 'wavePulse 1.1s ease-in-out infinite';
                        bar.style.animationDelay = (i * 0.08) + 's';
                    });
                    audio.addEventListener('timeupdate', function() {
                        var rem = Math.ceil(audio.duration - audio.currentTime);
                        durationText.textContent = Math.floor(rem / 60) + ':' + (rem % 60).toString().padStart(2, '0');
                    });
                    audio.addEventListener('ended', function() {
                        playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                        waveBars.forEach(function(b) { b.style.animation = 'none'; });
                        var d = Math.ceil(audio.duration);
                        durationText.textContent = Math.floor(d / 60) + ':' + (d % 60).toString().padStart(2, '0');
                    });
                } else {
                    audio.pause();
                    playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                    waveBars.forEach(function(b) { b.style.animation = 'none'; });
                }
            };
            [micButtonDrawer, micButtonCollapsed].filter(Boolean).forEach(function(btn) {
                btn.addEventListener('mousedown', startRecording);
                btn.addEventListener('touchstart', startRecording);
                btn.addEventListener('mouseup', stopRecording);
                btn.addEventListener('mouseleave', cancelRecording);
                btn.addEventListener('touchend', stopRecording);
                btn.addEventListener('touchcancel', cancelRecording);
                btn.addEventListener('touchmove', handleSwipeCancel);
            });
            if (sendButtonCollapsed) sendButtonCollapsed.addEventListener('click', function() {
                sendMessage(chatInputCollapsedField, sendButtonCollapsed, micButtonCollapsed);
                expandDrawer();
            });

            function expandDrawer() {
                chatDrawer.classList.remove('translate-y-full');
                chatDrawer.style.height = drawerHeight + 'vh';
                chatOverlay.classList.remove('hidden');
                if (chatInputBar) chatInputBar.classList.add('hidden');
                // Keep bottom nav visible - drawer docks above it (match Home)
                isDrawerExpanded = true;
            }

            function collapseDrawer() {
                chatDrawer.classList.add('translate-y-full');
                chatOverlay.classList.add('hidden');
                if (chatInputBar) chatInputBar.classList.remove('hidden');
                isDrawerExpanded = false;
                hideAddFriendFlow();
            }

            // Open drawer by default at 50% height
            expandDrawer();

            // Chat Input Functionality - match Home: show send when typing, hide mic/add-friend
            function updateInputState(inputEl, mic, addFriend, send) {
                var hasText = inputEl && inputEl.value.trim().length > 0;
                if (mic) mic.classList.toggle('hidden', hasText);
                if (addFriend) addFriend.classList.toggle('hidden', hasText);
                if (send) send.classList.toggle('hidden', !hasText);
            }
            if (chatInputDrawer) chatInputDrawer.addEventListener('input', function() { updateInputState(chatInputDrawer, micButtonDrawer, addFriendDrawer, sendButtonDrawer); });
            if (chatInputCollapsedField) chatInputCollapsedField.addEventListener('input', function() { updateInputState(chatInputCollapsedField, micButtonCollapsed, addFriendBtn, sendButtonCollapsed); });
            updateInputState(chatInputDrawer, micButtonDrawer, addFriendDrawer, sendButtonDrawer);
            updateInputState(chatInputCollapsedField, micButtonCollapsed, addFriendBtn, sendButtonCollapsed);

            // Send Message Functions - match Home
            function sendMessage(inputField, sendButton, micButton, addFriendBtnRef) {
                const message = inputField && inputField.value ? inputField.value.trim() : '';
                if (message) {
                    const userMessage = document.createElement('div');
                    userMessage.className = 'flex justify-end mb-4';
                    userMessage.innerHTML = '<div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]"><p class="text-sm break-words whitespace-pre-wrap">' + message.replace(/</g, '&lt;') + '</p></div>';
                    if (chatMessagesContainer) chatMessagesContainer.appendChild(userMessage);
                    scrollChatToBottom();
                    inputField.value = '';
                    autoGrowTextarea(inputField);
                    updateInputState(inputField, micButton, addFriendBtnRef, sendButton);

                    // Simulate AI response
                    setTimeout(() => {
                        const aiResponse = document.createElement('div');
                        aiResponse.className = 'flex items-start space-x-3 mb-4';
                        aiResponse.innerHTML = (typeof getShAIAvatarHtml === 'function' ? getShAIAvatarHtml('w-8 h-8') : '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-500 text-xs font-medium">AI</span></div>') + `
                            <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-[80%]">
                                <p class="text-sm text-black break-words whitespace-pre-wrap">Perfect! I'll help you find pieces from that collection that match your style and preferences.</p>
                            </div>
                        `;
                        if (chatMessagesContainer) chatMessagesContainer.appendChild(aiResponse);
                        scrollChatToBottom();
                    }, 1000);
                }
            }

            if (sendButtonDrawer) sendButtonDrawer.addEventListener('click', () => {
                sendMessage(chatInputDrawer, sendButtonDrawer, micButtonDrawer, addFriendDrawer);
            });

            if (sendButtonCollapsed) sendButtonCollapsed.addEventListener('click', () => {
                sendMessage(chatInputCollapsedField, sendButtonCollapsed, micButtonCollapsed, addFriendBtn);
                expandDrawer();
            });

            // Enter to send - match Home (Shift+Enter = newline)
            function onKeydownSend(e, inputEl, sendBtn, micBtn, addFriendBtnRef) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(inputEl, sendBtn, micBtn, addFriendBtnRef);
                    if (inputEl === chatInputCollapsedField) expandDrawer();
                }
            }
            if (chatInputDrawer) chatInputDrawer.addEventListener('keydown', function(e) { onKeydownSend(e, chatInputDrawer, sendButtonDrawer, micButtonDrawer, addFriendDrawer); });
            if (chatInputCollapsedField) chatInputCollapsedField.addEventListener('keydown', function(e) { onKeydownSend(e, chatInputCollapsedField, sendButtonCollapsed, micButtonCollapsed, addFriendBtn); });

            // Auto-grow textarea - match Home (design system: max 6 rows)
            function autoGrowTextarea(ta) {
                ta.style.height = 'auto';
                ta.style.height = Math.min(ta.scrollHeight, 144) + 'px';
            }
            if (chatInputDrawer) {
                chatInputDrawer.addEventListener('input', function() { autoGrowTextarea(chatInputDrawer); });
                autoGrowTextarea(chatInputDrawer);
            }
            if (chatInputCollapsedField) {
                chatInputCollapsedField.addEventListener('input', function() { autoGrowTextarea(chatInputCollapsedField); });
                autoGrowTextarea(chatInputCollapsedField);
            }

            // Smart prompt chip functionality
            (document.querySelectorAll('#smart-prompts button') || []).forEach(button => {
                button.addEventListener('click', () => {
                    const userMessage = document.createElement('div');
                    userMessage.className = 'flex justify-end mb-4';
                    userMessage.innerHTML = `
                        <div class="bg-[#939BFB] text-white rounded-2xl rounded-tr-md p-3 max-w-[80%]">
                            <p class="text-sm break-words whitespace-pre-wrap">${button.textContent}</p>
                        </div>
                    `;
                    if (chatMessagesContainer) chatMessagesContainer.appendChild(userMessage);
                    scrollChatToBottom();

                    setTimeout(() => {
                        const aiResponse = document.createElement('div');
                        aiResponse.className = 'flex items-start space-x-3 mb-4';
                        aiResponse.innerHTML = (typeof getShAIAvatarHtml === 'function' ? getShAIAvatarHtml('w-8 h-8') : '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><span class="text-gray-500 text-xs font-medium">AI</span></div>') + `
                            <div class="bg-gray-50 rounded-2xl rounded-tl-md p-3 max-w-[80%]">
                                <p class="text-sm text-black break-words whitespace-pre-wrap">Great question! Let me show you what's perfect for you from these collections.</p>
                            </div>
                        `;
                        if (chatMessagesContainer) chatMessagesContainer.appendChild(aiResponse);
                        scrollChatToBottom();
                    }, 800);
                });
            });

            // Collection tile navigation - match Creator Collections
            document.querySelectorAll('.collection-tile').forEach(tile => {
                tile.addEventListener('click', (e) => {
                    if (e.target.closest('button')) return;
                    const h4 = tile.querySelector('h4');
                    const img = tile.querySelector('img');
                    const p = tile.querySelector('.text-xs.text-gray-500');
                    const name = h4 ? h4.textContent : '';
                    const col = { id: tile.dataset.collectionId, name: name, coverImage: img ? img.src : '', itemCount: parseInt((p && p.textContent) || '0') || 0 };
                    const creator = { name: tile.dataset.creator || '' };
                    sessionStorage.setItem('__singleCollectionData', JSON.stringify({ collection: col, creator: creator }));
                    window.location.href = "Creator`s Single_Collection.html?collection=" + encodeURIComponent(name || '');
                });
            });

            // Share and wishlist button delegation
            document.addEventListener('click', function(e) {
                var btn = e.target.closest('.share-collection-btn');
                if (btn) {
                    var tile = btn.closest('.collection-tile');
                    var h4 = tile && tile.querySelector('h4');
                    if (h4) { e.stopPropagation(); e.preventDefault(); window.shareCollection(h4.textContent); }
                    return;
                }
                btn = e.target.closest('.collection-wishlist-btn');
                if (btn) { e.stopPropagation(); e.preventDefault(); window.toggleCollectionWishlist(btn); }
            });
        });
    </script>

